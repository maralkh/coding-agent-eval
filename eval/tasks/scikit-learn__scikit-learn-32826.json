{
  "id": "scikit-learn__scikit-learn-32826",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "d1661f07ad31b836649044cc6befbc75ef8c1eb9",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 32826,
  "pr_title": "TST add tests for pyproject minimum dependency checks",
  "gold_patch": "diff --git a/sklearn/tests/test_min_dependencies_readme.py b/sklearn/tests/test_min_dependencies_readme.py\nindex 0f894103a8e27..9a51041e2321f 100644\n--- a/sklearn/tests/test_min_dependencies_readme.py\n+++ b/sklearn/tests/test_min_dependencies_readme.py\n@@ -2,6 +2,7 @@\n \n import os\n import re\n+import tomllib\n from collections import defaultdict\n from pathlib import Path\n \n@@ -11,18 +12,79 @@\n from sklearn._min_dependencies import dependent_packages\n from sklearn.utils.fixes import parse_version\n \n-min_depencies_tag_to_packages_without_version = defaultdict(list)\n-for package, (min_version, extras) in dependent_packages.items():\n-    for extra in extras.split(\", \"):\n-        min_depencies_tag_to_packages_without_version[extra].append(package)\n+# minimal dependencies and pyproject definitions for testing the pyproject tests\n \n-pyproject_section_to_min_dependencies_tag = {\n-    \"build-system.requires\": \"build\",\n-    \"project.dependencies\": \"install\",\n+TOY_MIN_DEPENDENCIES_PY_INFO = {\n+    \"joblib\": (\"1.3.0\", \"install\"),\n+    \"scipy\": (\"1.10.0\", \"build, install\"),\n+    \"conda-lock\": (\"3.0.1\", \"maintenance\"),\n }\n-for tag in min_depencies_tag_to_packages_without_version:\n-    section = f\"project.optional-dependencies.{tag}\"\n-    pyproject_section_to_min_dependencies_tag[section] = tag\n+\n+TOY_MATCHING_PYPROJECT_SECTIONS = \"\"\"\n+[project]\n+dependencies = [\"joblib>=1.3.0\", \"scipy>=1.10.0\"]\n+[project.optional-dependencies]\n+build = [\"scipy>=1.10.0\"]\n+install = [\"joblib>=1.3.0\", \"scipy>=1.10.0\"]\n+maintenance = [\"conda-lock==3.0.1\"]\n+[build-system]\n+requires = [\"scipy>=1.10.0\"]\n+\"\"\"\n+\n+TOY_MATCHING_PYPROJECT_SECTIONS_WITH_UPPER_BOUND = \"\"\"\n+[project]\n+dependencies = [\"joblib>=1.3.0,<2.0\", \"scipy>=1.10.0\"]\n+[project.optional-dependencies]\n+build = [\"scipy>=1.10.0,<1.19.0\"]\n+install = [\"joblib>=1.3.0,<2.0\", \"scipy>=1.10.0\"]\n+maintenance = [\"conda-lock==3.0.1\"]\n+[build-system]\n+requires = [\"scipy>=1.10.0,<1.19.0\"]\n+\"\"\"\n+\n+TOY_WRONG_SYMBOL_PYPROJECT_SECTIONS = \"\"\"\n+[project]\n+dependencies = [\"scipy<1.10.0\"]\n+[project.optional-dependencies]\n+build = [\"scipy>=1.10.0\"]\n+install = [\"scipy>=1.10.0\"]\n+maintenance = [\"conda-lock==3.0.1\"]\n+[build-system]\n+requires = [\"scipy>=1.10.0\"]\n+\"\"\"\n+\n+TOY_MISSING_PACKAGE_PYPROJECT_SECTIONS = \"\"\"\n+[project]\n+dependencies = [\"scipy>=1.10.0\"]\n+[project.optional-dependencies]\n+build = [\"scipy>=1.10.0\"]\n+install = [\"scipy>=1.10.0\"]\n+maintenance = [\"conda-lock==3.0.1\"]\n+[build-system]\n+requires = [\"scipy>=1.10.0\"]\n+\"\"\"\n+\n+TOY_ADDITIONAL_PACKAGE_PYPROJECT_SECTIONS = \"\"\"\n+[project]\n+dependencies = [\"joblib>=1.3.0\", \"scipy>=1.10.0\"]\n+[project.optional-dependencies]\n+build = [\"scipy>=1.10.0\", \"package_not_in_min_dependencies_py_file>=4.2\"]\n+install = [\"joblib>=1.3.0\", \"scipy>=1.10.0\"]\n+maintenance = [\"conda-lock==3.0.1\"]\n+[build-system]\n+requires = [\"scipy>=1.10.0\"]\n+\"\"\"\n+\n+TOY_NON_MATCHING_VERSION_PYPROJECT_SECTIONS = \"\"\"\n+[project]\n+dependencies = [\"joblib>=1.42.0\", \"scipy>=1.10.0\"]\n+[project.optional-dependencies]\n+build = [\"scipy>=1.10.0\"]\n+install = [\"joblib>=1.3.0\", \"scipy>=1.10.0\"]\n+maintenance = [\"conda-lock==3.0.1\"]\n+[build-system]\n+requires = [\"scipy>=1.10.0\"]\n+\"\"\"\n \n \n def test_min_dependencies_readme():\n@@ -66,18 +128,79 @@ def test_min_dependencies_readme():\n                 assert version == min_version, message\n \n \n-def check_pyproject_section(\n-    pyproject_section, min_dependencies_tag, skip_version_check_for=None\n-):\n-    # tomllib is available in Python 3.11\n-    tomllib = pytest.importorskip(\"tomllib\")\n+def extract_packages_and_pyproject_tags(dependencies):\n+    min_depencies_tag_to_packages_without_version = defaultdict(list)\n+    for package, (min_version, tags) in dependencies.items():\n+        for t in tags.split(\", \"):\n+            min_depencies_tag_to_packages_without_version[t].append(package)\n+\n+    pyproject_section_to_min_dependencies_tag = {\n+        \"build-system.requires\": \"build\",\n+        \"project.dependencies\": \"install\",\n+    }\n+    for tag in min_depencies_tag_to_packages_without_version:\n+        section = f\"project.optional-dependencies.{tag}\"\n+        pyproject_section_to_min_dependencies_tag[section] = tag\n+\n+    return (\n+        min_depencies_tag_to_packages_without_version,\n+        pyproject_section_to_min_dependencies_tag,\n+    )\n+\n+\n+def check_pyproject_sections(pyproject_toml, min_dependencies):\n+    packages, pyproject_tags = extract_packages_and_pyproject_tags(min_dependencies)\n+\n+    for pyproject_section, min_dependencies_tag in pyproject_tags.items():\n+        # Special situation for numpy: we have numpy>=2 in\n+        # build-system.requires to make sure we build wheels against numpy>=2.\n+        # TODO remove this when our minimum supported numpy version is >=2.\n+        skip_version_check_for = (\n+            [\"numpy\"] if pyproject_section == \"build-system.requires\" else []\n+        )\n+\n+        expected_packages = packages[min_dependencies_tag]\n+\n+        pyproject_section_keys = pyproject_section.split(\".\")\n+        info = pyproject_toml\n+        # iterate through nested keys to get packages and version\n+        for key in pyproject_section_keys:\n+            info = info[key]\n+\n+        pyproject_build_min_versions = {}\n+        # Assuming pyproject.toml build section has something like \"my-package>=2.3.0\"\n+        pattern = r\"([\\w-]+)\\s*[>=]=\\s*([\\d\\w.]+)\"\n+        for requirement in info:\n+            match = re.search(pattern, requirement)\n+            if match is None:\n+                raise NotImplementedError(\n+                    f\"{requirement} does not match expected regex {pattern!r}. \"\n+                    \"Only >= and == are supported for version requirements\"\n+                )\n+\n+            package, version = match.group(1), match.group(2)\n \n-    if skip_version_check_for is None:\n-        skip_version_check_for = []\n+            pyproject_build_min_versions[package] = version\n \n-    expected_packages = min_depencies_tag_to_packages_without_version[\n-        min_dependencies_tag\n-    ]\n+        msg = f\"Packages in {pyproject_section} differ from _min_depencies.py\"\n+\n+        assert sorted(pyproject_build_min_versions) == sorted(expected_packages), msg\n+\n+        for package, version in pyproject_build_min_versions.items():\n+            version = parse_version(version)\n+            expected_min_version = parse_version(min_dependencies[package][0])\n+            if package in skip_version_check_for:\n+                continue\n+\n+            message = (\n+                f\"{package} has inconsistent minimum versions in pyproject.toml and\"\n+                f\" _min_depencies.py: {version} != {expected_min_version}\"\n+            )\n+            assert version == expected_min_version, message\n+\n+\n+def test_min_dependencies_pyproject_toml():\n+    \"\"\"Check versions in pyproject.toml is consistent with _min_dependencies.\"\"\"\n \n     root_directory = Path(sklearn.__file__).parent.parent\n     pyproject_toml_path = root_directory / \"pyproject.toml\"\n@@ -90,54 +213,53 @@ def check_pyproject_section(\n     with pyproject_toml_path.open(\"rb\") as f:\n         pyproject_toml = tomllib.load(f)\n \n-    pyproject_section_keys = pyproject_section.split(\".\")\n-    info = pyproject_toml\n-    for key in pyproject_section_keys:\n-        info = info[key]\n-\n-    pyproject_build_min_versions = {}\n-    # Assuming pyproject.toml build section has something like \"my-package>=2.3.0\"\n-    # Warning: if you try to modify this regex, bear in mind that there can be upper\n-    # bounds in release branches so \"my-package>=2.3.0,<2.5.0\"\n-    pattern = r\"([\\w-]+)\\s*[>=]=\\s*([\\d\\w.]+)\"\n-    for requirement in info:\n-        match = re.search(pattern, requirement)\n-        if match is None:\n-            raise NotImplementedError(\n-                f\"{requirement} does not match expected regex {pattern!r}. \"\n-                \"Only >= and == are supported for version requirements\"\n-            )\n-\n-        package, version = match.group(1), match.group(2)\n+    check_pyproject_sections(pyproject_toml, dependent_packages)\n \n-        pyproject_build_min_versions[package] = version\n \n-    assert sorted(pyproject_build_min_versions) == sorted(expected_packages)\n+@pytest.mark.parametrize(\n+    \"example_pyproject\",\n+    [\n+        TOY_MATCHING_PYPROJECT_SECTIONS,\n+        TOY_MATCHING_PYPROJECT_SECTIONS_WITH_UPPER_BOUND,\n+    ],\n+)\n+def test_check_matching_pyproject_section(example_pyproject):\n+    \"\"\"Test the version check for matching packages.\"\"\"\n \n-    for package, version in pyproject_build_min_versions.items():\n-        version = parse_version(version)\n-        expected_min_version = parse_version(dependent_packages[package][0])\n-        if package in skip_version_check_for:\n-            continue\n+    pyproject_toml = tomllib.loads(example_pyproject)\n \n-        message = (\n-            f\"{package} has inconsistent minimum versions in pyproject.toml and\"\n-            f\" _min_depencies.py: {version} != {expected_min_version}\"\n-        )\n-        assert version == expected_min_version, message\n+    check_pyproject_sections(pyproject_toml, TOY_MIN_DEPENDENCIES_PY_INFO)\n \n \n @pytest.mark.parametrize(\n-    \"pyproject_section, min_dependencies_tag\",\n-    pyproject_section_to_min_dependencies_tag.items(),\n+    \"example_non_matching_pyproject, error_msg\",\n+    [\n+        (\n+            TOY_WRONG_SYMBOL_PYPROJECT_SECTIONS,\n+            \".* does not match expected regex .*. \"\n+            \"Only >= and == are supported for version requirements\",\n+        ),\n+        (\n+            TOY_MISSING_PACKAGE_PYPROJECT_SECTIONS,\n+            \"Packages in .* differ from _min_depencies.py\",\n+        ),\n+        (\n+            TOY_ADDITIONAL_PACKAGE_PYPROJECT_SECTIONS,\n+            \"Packages in .* differ from _min_depencies.py\",\n+        ),\n+        (\n+            TOY_NON_MATCHING_VERSION_PYPROJECT_SECTIONS,\n+            \".* has inconsistent minimum versions in pyproject.toml and\"\n+            \" _min_depencies.py: .* != .*\",\n+        ),\n+    ],\n )\n-def test_min_dependencies_pyproject_toml(pyproject_section, min_dependencies_tag):\n-    \"\"\"Check versions in pyproject.toml is consistent with _min_dependencies.\"\"\"\n-    # NumPy is more complex because build-time (>=1.25) and run-time (>=1.19.5)\n-    # requirement currently don't match\n-    skip_version_check_for = [\"numpy\"] if min_dependencies_tag == \"build\" else None\n-    check_pyproject_section(\n-        pyproject_section,\n-        min_dependencies_tag,\n-        skip_version_check_for=skip_version_check_for,\n-    )\n+def test_check_non_matching_pyproject_section(\n+    example_non_matching_pyproject, error_msg\n+):\n+    \"\"\"Test the version check for non-matching packages and versions.\"\"\"\n+\n+    pyproject_toml = tomllib.loads(example_non_matching_pyproject)\n+\n+    with pytest.raises(Exception, match=error_msg):\n+        check_pyproject_sections(pyproject_toml, TOY_MIN_DEPENDENCIES_PY_INFO)\n",
  "fail_to_pass": [
    "test_min_dependencies_pyproject_toml",
    "test_check_matching_pyproject_section",
    "test_check_non_matching_pyproject_section"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/tests/test_min_dependencies_readme.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-12-01T16:31:51Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32826",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}