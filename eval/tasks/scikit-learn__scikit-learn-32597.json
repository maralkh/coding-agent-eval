{
  "id": "scikit-learn__scikit-learn-32597",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "1358f7a87edf7ab6e2498e77a9f4cbd600166a86",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 32597,
  "pr_title": "FEA Add array API support for `manhattan_distances`",
  "gold_patch": "diff --git a/doc/modules/array_api.rst b/doc/modules/array_api.rst\nindex e263ef51d5723..5ae5f99f23b68 100644\n--- a/doc/modules/array_api.rst\n+++ b/doc/modules/array_api.rst\n@@ -172,9 +172,10 @@ Metrics\n - :func:`sklearn.metrics.pairwise.chi2_kernel`\n - :func:`sklearn.metrics.pairwise.cosine_similarity`\n - :func:`sklearn.metrics.pairwise.cosine_distances`\n-- :func:`sklearn.metrics.pairwise.pairwise_distances` (only supports \"cosine\", \"euclidean\" and \"l2\" metrics)\n+- :func:`sklearn.metrics.pairwise.pairwise_distances` (only supports \"cosine\", \"euclidean\", \"manhattan\" and \"l2\" metrics)\n - :func:`sklearn.metrics.pairwise.euclidean_distances` (see :ref:`device_support_for_float64`)\n - :func:`sklearn.metrics.pairwise.linear_kernel`\n+- :func:`sklearn.metrics.pairwise.manhattan_distances`\n - :func:`sklearn.metrics.pairwise.paired_cosine_distances`\n - :func:`sklearn.metrics.pairwise.paired_euclidean_distances`\n - :func:`sklearn.metrics.pairwise.pairwise_kernels` (supports all `sklearn.pairwise.PAIRWISE_KERNEL_FUNCTIONS` except :func:`sklearn.metrics.pairwise.laplacian_kernel`)\ndiff --git a/doc/whats_new/upcoming_changes/array-api/32597.feature.rst b/doc/whats_new/upcoming_changes/array-api/32597.feature.rst\nnew file mode 100644\nindex 0000000000000..2d22190b4a052\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/array-api/32597.feature.rst\n@@ -0,0 +1,2 @@\n+- :func:`sklearn.metrics.pairwise.manhattan_distances` now supports array API compatible inputs.\n+  By :user:`Omar Salman <OmarManzoor>`.\ndiff --git a/sklearn/metrics/pairwise.py b/sklearn/metrics/pairwise.py\nindex 5b82b5ca58b84..7957540c15e70 100644\n--- a/sklearn/metrics/pairwise.py\n+++ b/sklearn/metrics/pairwise.py\n@@ -1089,17 +1089,38 @@ def manhattan_distances(X, Y=None):\n            [4., 4.]])\n     \"\"\"\n     X, Y = check_pairwise_arrays(X, Y)\n+    n_x, n_y = X.shape[0], Y.shape[0]\n \n     if issparse(X) or issparse(Y):\n         X = csr_matrix(X, copy=False)\n         Y = csr_matrix(Y, copy=False)\n         X.sum_duplicates()  # this also sorts indices in-place\n         Y.sum_duplicates()\n-        D = np.zeros((X.shape[0], Y.shape[0]))\n+        D = np.zeros((n_x, n_y))\n         _sparse_manhattan(X.data, X.indices, X.indptr, Y.data, Y.indices, Y.indptr, D)\n         return D\n \n-    return distance.cdist(X, Y, \"cityblock\")\n+    xp, _, device_ = get_namespace_and_device(X, Y)\n+\n+    if _is_numpy_namespace(xp):\n+        return distance.cdist(X, Y, \"cityblock\")\n+\n+    # array API support\n+    float_dtype = _find_matching_floating_dtype(X, Y, xp=xp)\n+    out = xp.empty((n_x, n_y), dtype=float_dtype, device=device_)\n+    batch_size = 1024\n+    for i in range(0, n_x, batch_size):\n+        i_end = min(i + batch_size, n_x)\n+        batch_X = X[i:i_end, ...]\n+        for j in range(0, n_y, batch_size):\n+            j_end = min(j + batch_size, n_y)\n+            batch_Y = Y[j:j_end, ...]\n+            block_dist = xp.sum(\n+                xp.abs(batch_X[:, None, :] - batch_Y[None, :, :]), axis=2\n+            )\n+            out[i:i_end, j:j_end] = block_dist\n+\n+    return out\n \n \n @validate_params(\ndiff --git a/sklearn/metrics/tests/test_common.py b/sklearn/metrics/tests/test_common.py\nindex 7b91d6016dceb..ca92cc09c8660 100644\n--- a/sklearn/metrics/tests/test_common.py\n+++ b/sklearn/metrics/tests/test_common.py\n@@ -65,6 +65,7 @@\n     cosine_similarity,\n     euclidean_distances,\n     linear_kernel,\n+    manhattan_distances,\n     paired_cosine_distances,\n     paired_euclidean_distances,\n     pairwise_distances,\n@@ -2340,6 +2341,7 @@ def check_array_api_metric_pairwise(metric, array_namespace, device, dtype_name)\n     paired_euclidean_distances: [check_array_api_metric_pairwise],\n     cosine_distances: [check_array_api_metric_pairwise],\n     euclidean_distances: [check_array_api_metric_pairwise],\n+    manhattan_distances: [check_array_api_metric_pairwise],\n     linear_kernel: [check_array_api_metric_pairwise],\n     polynomial_kernel: [check_array_api_metric_pairwise],\n     rbf_kernel: [check_array_api_metric_pairwise],\ndiff --git a/sklearn/metrics/tests/test_pairwise.py b/sklearn/metrics/tests/test_pairwise.py\nindex f7c60def7bce8..34647b388050f 100644\n--- a/sklearn/metrics/tests/test_pairwise.py\n+++ b/sklearn/metrics/tests/test_pairwise.py\n@@ -156,7 +156,7 @@ def test_pairwise_distances_for_dense_data(global_dtype):\n     yield_namespace_device_dtype_combinations(),\n     ids=_get_namespace_device_dtype_ids,\n )\n-@pytest.mark.parametrize(\"metric\", [\"cosine\", \"euclidean\"])\n+@pytest.mark.parametrize(\"metric\", [\"cosine\", \"euclidean\", \"manhattan\"])\n def test_pairwise_distances_array_api(array_namespace, device, dtype_name, metric):\n     # Test array API support in pairwise_distances.\n     xp = _array_api_for_tests(array_namespace, device)\n@@ -398,6 +398,7 @@ def test_pairwise_parallel(func, metric, kwds, dtype):\n     \"func, metric, kwds\",\n     [\n         (pairwise_distances, \"euclidean\", {}),\n+        (pairwise_distances, \"manhattan\", {}),\n         (pairwise_kernels, \"polynomial\", {\"degree\": 1}),\n         (pairwise_kernels, callable_rbf_kernel, {\"gamma\": 0.1}),\n     ],\n",
  "fail_to_pass": [],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/metrics/pairwise.py",
    "sklearn/metrics/tests/test_common.py",
    "sklearn/metrics/tests/test_pairwise.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-10-28T10:42:52Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32597",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}