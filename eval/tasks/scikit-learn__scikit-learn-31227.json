{
  "id": "scikit-learn__scikit-learn-31227",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "36d056fc0b4ff84c6fd1f158b1b14798e9f75df2",
  "issue_number": 27818,
  "issue_title": "ENH Use scipy.stats.yeojohnson in PowerTransformer",
  "issue_body": "<!--\r\nThanks for contributing a pull request! Please ensure you have taken a look at\r\nthe contribution guidelines: https://github.com/scikit-learn/scikit-learn/blob/main/CONTRIBUTING.md\r\n-->\r\n\r\n#### Reference Issues/PRs\r\n<!--\r\nExample: Fixes #1234. See also #3456.\r\nPlease use keywords (e.g., Fixes) to create link to the issues or pull requests\r\nyou resolved, so that they will automatically be closed when your pull request\r\nis merged. See https://github.com/blog/1506-closing-issues-via-pull-requests\r\n-->\r\nCloses #26308\r\n\r\n#### What does this implement/fix? Explain your changes.\r\nUse [scipy.stats.yeojohnson](https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.yeojohnson.html#scipy-stats-yeojohnson) instead of our own implementation as @lorentzenchr suggested.\r\n\r\n#### Any other comments?\r\n\r\n\r\n<!--\r\nPlease be aware that we are a loose team of volunteers so patience is\r\nnecessary; assistance handling other issues is very welcome. We value\r\nall user contributions, no matter how minor they are. If we are slow to\r\nreview, either the pull request needs some benchmarking, tinkering,\r\nconvincing, etc. or more likely the reviewers are simply busy. In either\r\ncase, we ask for your understanding during the review process.\r\nFor more information, see our FAQ on this topic:\r\nhttp://scikit-learn.org/dev/faq.html#why-is-my-pull-request-not-getting-any-attention.\r\n\r\nThanks for contributing!\r\n-->\r\n",
  "pr_number": 31227,
  "pr_title": "ENH Use scipy Yeo-Johnson implementation in PowerTransformer for scipy >= 1.9",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.preprocessing/31227.fix.rst b/doc/whats_new/upcoming_changes/sklearn.preprocessing/31227.fix.rst\nnew file mode 100644\nindex 0000000000000..803517760a822\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.preprocessing/31227.fix.rst\n@@ -0,0 +1,6 @@\n+- Now using ``scipy.stats.yeojohnson`` instead of our own implementation of the Yeo-Johnson transform.\n+  Fixed numerical stability (mostly overflows) of the Yeo-Johnson transform with\n+  `PowerTransformer(method=\"yeo-johnson\")` when scipy version is `>= 1.12`.\n+  Initial PR by :user:`Xuefeng Xu <xuefeng-xu>` completed by :user:`Mohamed Yaich <yaichm>`,\n+  :user:`Oussama Er-rabie <eroussama>`, :user:`Mohammed Yaslam Dlimi <Dlimim>`,\n+  :user:`Hamza Zaroual <HamzaLuffy>`, :user:`Amine Hannoun <AmineHannoun>` and :user:`Sylvain Mari\u00e9 <smarie>`.\n\\ No newline at end of file\ndiff --git a/sklearn/preprocessing/_data.py b/sklearn/preprocessing/_data.py\nindex f9dd9b6b360db..1349374a61ea8 100644\n--- a/sklearn/preprocessing/_data.py\n+++ b/sklearn/preprocessing/_data.py\n@@ -6,7 +6,7 @@\n from numbers import Integral, Real\n \n import numpy as np\n-from scipy import optimize, sparse, stats\n+from scipy import sparse, stats\n from scipy.special import boxcox, inv_boxcox\n \n from sklearn.utils import metadata_routing\n@@ -28,6 +28,7 @@\n )\n from ..utils._param_validation import Interval, Options, StrOptions, validate_params\n from ..utils.extmath import _incremental_mean_and_var, row_norms\n+from ..utils.fixes import _yeojohnson_lambda\n from ..utils.sparsefuncs import (\n     incr_mean_variance_axis,\n     inplace_column_scale,\n@@ -3542,8 +3543,8 @@ def _neg_log_likelihood(lmbda):\n         # the computation of lambda is influenced by NaNs so we need to\n         # get rid of them\n         x = x[~np.isnan(x)]\n-        # choosing bracket -2, 2 like for boxcox\n-        return optimize.brent(_neg_log_likelihood, brack=(-2, 2))\n+\n+        return _yeojohnson_lambda(_neg_log_likelihood, x)\n \n     def _check_input(self, X, in_fit, check_positive=False, check_shape=False):\n         \"\"\"Validate the input before fit and transform.\ndiff --git a/sklearn/preprocessing/tests/test_data.py b/sklearn/preprocessing/tests/test_data.py\nindex 4732d2960360c..a618d426a7dcb 100644\n--- a/sklearn/preprocessing/tests/test_data.py\n+++ b/sklearn/preprocessing/tests/test_data.py\n@@ -12,6 +12,7 @@\n from sklearn import config_context, datasets\n from sklearn.base import clone\n from sklearn.exceptions import NotFittedError\n+from sklearn.externals._packaging.version import parse as parse_version\n from sklearn.metrics.pairwise import linear_kernel\n from sklearn.model_selection import cross_val_predict\n from sklearn.pipeline import Pipeline\n@@ -62,6 +63,7 @@\n     CSC_CONTAINERS,\n     CSR_CONTAINERS,\n     LIL_CONTAINERS,\n+    sp_version,\n )\n from sklearn.utils.sparsefuncs import mean_variance_axis\n \n@@ -2640,3 +2642,52 @@ def test_power_transformer_constant_feature(standardize):\n             assert_allclose(Xt_, np.zeros_like(X))\n         else:\n             assert_allclose(Xt_, X)\n+\n+\n+@pytest.mark.skipif(\n+    sp_version < parse_version(\"1.12\"),\n+    reason=\"scipy version 1.12 required for stable yeo-johnson\",\n+)\n+def test_power_transformer_no_warnings():\n+    \"\"\"Verify that PowerTransformer operates without raising any warnings on valid data.\n+\n+    This test addresses numerical issues with floating point numbers (mostly\n+    overflows) with the Yeo-Johnson transform, see\n+    https://github.com/scikit-learn/scikit-learn/issues/23319#issuecomment-1464933635\n+    \"\"\"\n+    x = np.array(\n+        [\n+            2003.0,\n+            1950.0,\n+            1997.0,\n+            2000.0,\n+            2009.0,\n+            2009.0,\n+            1980.0,\n+            1999.0,\n+            2007.0,\n+            1991.0,\n+        ]\n+    )\n+\n+    def _test_no_warnings(data):\n+        \"\"\"Internal helper to test for unexpected warnings.\"\"\"\n+        with warnings.catch_warnings(record=True) as caught_warnings:\n+            warnings.simplefilter(\"always\")  # Ensure all warnings are captured\n+            PowerTransformer(method=\"yeo-johnson\", standardize=True).fit_transform(data)\n+\n+        assert not caught_warnings, \"Unexpected warnings were raised:\\n\" + \"\\n\".join(\n+            str(w.message) for w in caught_warnings\n+        )\n+\n+    # Full dataset: Should not trigger overflow in variance calculation.\n+    _test_no_warnings(x.reshape(-1, 1))\n+\n+    # Subset of data: Should not trigger overflow in power calculation.\n+    _test_no_warnings(x[:5].reshape(-1, 1))\n+\n+\n+def test_yeojohnson_for_different_scipy_version():\n+    \"\"\"Check that the results are consistent across different SciPy versions.\"\"\"\n+    pt = PowerTransformer(method=\"yeo-johnson\").fit(X_1col)\n+    pt.lambdas_[0] == pytest.approx(0.99546157, rel=1e-7)\ndiff --git a/sklearn/utils/fixes.py b/sklearn/utils/fixes.py\nindex 816deb3d36072..02e723963448b 100644\n--- a/sklearn/utils/fixes.py\n+++ b/sklearn/utils/fixes.py\n@@ -14,6 +14,7 @@\n import scipy\n import scipy.sparse.linalg\n import scipy.stats\n+from scipy import optimize\n \n try:\n     import pandas as pd\n@@ -80,6 +81,38 @@ def _sparse_linalg_cg(A, b, **kwargs):\n         return scipy.sparse.linalg.cg(A, b, **kwargs)\n \n \n+# TODO : remove this when required minimum version of scipy >= 1.9.0\n+def _yeojohnson_lambda(_neg_log_likelihood, x):\n+    \"\"\"Estimate the optimal Yeo-Johnson transformation parameter (lambda).\n+\n+    This function provides a compatibility workaround for versions of SciPy\n+    older than 1.9.0, where `scipy.stats.yeojohnson` did not return\n+    the estimated lambda directly.\n+\n+    Parameters\n+    ----------\n+    _neg_log_likelihood : callable\n+        A function that computes the negative log-likelihood of the Yeo-Johnson\n+        transformation for a given lambda. Used only for SciPy versions < 1.9.0.\n+\n+    x : array-like\n+        Input data to estimate the Yeo-Johnson transformation parameter.\n+\n+    Returns\n+    -------\n+    lmbda : float\n+        The estimated lambda parameter for the Yeo-Johnson transformation.\n+    \"\"\"\n+    min_scipy_version = \"1.9.0\"\n+\n+    if sp_version < parse_version(min_scipy_version):\n+        # choosing bracket -2, 2 like for boxcox\n+        return optimize.brent(_neg_log_likelihood, brack=(-2, 2))\n+\n+    _, lmbda = scipy.stats.yeojohnson(x, lmbda=None)\n+    return lmbda\n+\n+\n # TODO: Fuse the modern implementations of _sparse_min_max and _sparse_nan_min_max\n # into the public min_max_axis function when Scipy 1.11 is the minimum supported\n # version and delete the backport in the else branch below.\n",
  "fail_to_pass": [
    "test_power_transformer_no_warnings",
    "test_yeojohnson_for_different_scipy_version"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/preprocessing/_data.py",
    "sklearn/preprocessing/tests/test_data.py",
    "sklearn/utils/fixes.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-04-19T12:21:19Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/31227",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/27818"
}