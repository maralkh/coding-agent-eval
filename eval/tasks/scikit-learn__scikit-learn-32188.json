{
  "id": "scikit-learn__scikit-learn-32188",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "3498b6f2958839b5e89f21dcefc67ceb72de589c",
  "issue_number": 32155,
  "issue_title": "ColumnTransformer.fit() fails on polars.DataFrame: AttributeError: 'DataFrame' object has no attribute 'size'",
  "issue_body": "### Describe the bug\n\nFitting a sklearn.compose.ColumnTransformer with *more than one* transformer on a polars.DataFrame yields the error:\n\n> AttributeError: 'DataFrame' object has no attribute 'size'\n\n* Fitting works fine when converting the DataFrame to pandas beforehand\n* Fitting also works fine with a *polars* DataFrame for as long as only a *single* transformer is passed to ColumnTransformer\n\nI am using the latest stable version of sklearn (1.7.2) and polars (1.33.1).\n\nThank you so much for looking into this!\n\n### Steps/Code to Reproduce\n\n```python\nimport polars as pl\nfrom sklearn.preprocessing import OneHotEncoder\nfrom sklearn.compose import ColumnTransformer\n\n## Generate toy data (polars DataFrame)\ndf = pl.DataFrame({\n    'some_categories': list('abc'),\n    'some_numbers': range(3)\n})\n\nprint(df)\nshape: (3, 2)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 some_categories \u2506 some_numbers \u2502\n\u2502 ---             \u2506 ---          \u2502\n\u2502 str             \u2506 i64          \u2502\n\u255e\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u256a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2561\n\u2502 a               \u2506 0            \u2502\n\u2502 b               \u2506 1            \u2502\n\u2502 c               \u2506 2            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n## Define a ColumnTransformer and fit on polars df -> AttributeError\npreprocessor = ColumnTransformer(\n    transformers=[\n        ('cat', OneHotEncoder(handle_unknown='ignore', drop='first'), ['some_categories']),\n        ('num', 'passthrough', [\"some_numbers\"])\n    ])\n\n## Fit on polars df\npreprocessor.fit(df) ## AttributeError: 'DataFrame' object has no attribute 'size'\n\n## Fit on pandas df\npreprocessor.fit(df.to_pandas()) ## works fine for pandas df\n\n\n## Define ColumnTransformers with only one transformer each and fit on polars df -> works fine\npreprocessor1 = ColumnTransformer(\n    transformers=[\n        ('cat', OneHotEncoder(handle_unknown='ignore', drop='first'), ['some_categories'])\n    ])\n\npreprocessor2 = ColumnTransformer(\n    transformers=[\n        ('num', 'passthrough', [\"some_numbers\"])\n    ])\n\npreprocessor1.fit(df) ## works\npreprocessor2.fit(df) ## works\n```\n\n### Expected Results\n\nNo error.\n\n### Actual Results\n\nAttributeError: 'DataFrame' object has no attribute 'size'\n\n### Versions\n\n```shell\nSystem:\n    python: 3.12.11 (main, Jun 12 2025, 12:44:17) [MSC v.1943 64 bit (AMD64)]\nexecutable: xxx\\.venv\\Scripts\\python.exe\n   machine: Windows-11-10.0.26100-SP0\n\nPython dependencies:\n      sklearn: 1.7.2\n          pip: None\n   setuptools: 80.9.0\n        numpy: 2.3.2\n        scipy: 1.16.1\n       Cython: None\n       pandas: 2.3.2\n   matplotlib: 3.10.5\n       joblib: 1.5.2\nthreadpoolctl: 3.6.0\n\nBuilt with OpenMP: True\n\nthreadpoolctl info:\n       user_api: openmp\n   internal_api: openmp\n    num_threads: 20\n         prefix: vcomp\n       filepath: xxx\\.venv\\Lib\\site-packages\\sklearn\\.libs\\vcomp140.dll\n        version: None\n\n       user_api: blas\n   internal_api: openblas\n    num_threads: 20\n         prefix: libscipy_openblas\n       filepath: xxx\\.venv\\Lib\\site-packages\\numpy.libs\\libscipy_openblas64_-860d95b1c38e637ce4509f5fa24fbf2a.dll\n        version: 0.3.30\nthreading_layer: pthreads\n   architecture: Haswell\n\n       user_api: blas\n   internal_api: openblas\n    num_threads: 20\n         prefix: libscipy_openblas\n       filepath: xxx\\.venv\\Lib\\site-packages\\scipy.libs\\libscipy_openblas-6b2103f2ae4d8547998b5d188e9801fb.dll\n        version: 0.3.28\nthreading_layer: pthreads\n   architecture: Haswell\n```",
  "pr_number": 32188,
  "pr_title": "FIX ColumnTransformer.fit_transform for polars.DataFrame missing a .size attribute in sparse stacking",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.compose/32188.fix.rst b/doc/whats_new/upcoming_changes/sklearn.compose/32188.fix.rst\nnew file mode 100644\nindex 0000000000000..1bd73934a426c\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.compose/32188.fix.rst\n@@ -0,0 +1,3 @@\n+- The :class:`compose.ColumnTransformer` now correctly fits on data provided as a\n+  `polars.DataFrame` when any transformer has a sparse output.\n+  By :user:`Phillipp Gnan <ph-ll-pp>`.\ndiff --git a/sklearn/compose/_column_transformer.py b/sklearn/compose/_column_transformer.py\nindex 58570b9676078..37629abcb43e4 100644\n--- a/sklearn/compose/_column_transformer.py\n+++ b/sklearn/compose/_column_transformer.py\n@@ -1014,10 +1014,10 @@ def fit_transform(self, X, y=None, **params):\n \n         # determine if concatenated output will be sparse or not\n         if any(sparse.issparse(X) for X in Xs):\n-            nnz = sum(X.nnz if sparse.issparse(X) else X.size for X in Xs)\n-            total = sum(\n-                X.shape[0] * X.shape[1] if sparse.issparse(X) else X.size for X in Xs\n+            nnz = sum(\n+                X.nnz if sparse.issparse(X) else X.shape[0] * X.shape[1] for X in Xs\n             )\n+            total = sum(X.shape[0] * X.shape[1] for X in Xs)\n             density = nnz / total\n             self.sparse_output_ = density < self.sparse_threshold\n         else:\ndiff --git a/sklearn/compose/tests/test_column_transformer.py b/sklearn/compose/tests/test_column_transformer.py\nindex 0ba240cf5df11..031414190f87e 100644\n--- a/sklearn/compose/tests/test_column_transformer.py\n+++ b/sklearn/compose/tests/test_column_transformer.py\n@@ -513,14 +513,17 @@ def test_column_transformer_list():\n \n \n @pytest.mark.parametrize(\"csr_container\", CSR_CONTAINERS)\n-def test_column_transformer_sparse_stacking(csr_container):\n-    X_array = np.array([[0, 1, 2], [2, 4, 6]]).T\n+@pytest.mark.parametrize(\"constructor_name\", [\"array\", \"pandas\", \"polars\"])\n+def test_column_transformer_sparse_stacking(csr_container, constructor_name):\n+    X = np.array([[0, 1, 2], [2, 4, 6]]).T\n+    X = _convert_container(X, constructor_name, columns_name=[\"first\", \"second\"])\n+\n     col_trans = ColumnTransformer(\n         [(\"trans1\", Trans(), [0]), (\"trans2\", SparseMatrixTrans(csr_container), 1)],\n         sparse_threshold=0.8,\n     )\n-    col_trans.fit(X_array)\n-    X_trans = col_trans.transform(X_array)\n+    col_trans.fit(X)\n+    X_trans = col_trans.transform(X)\n     assert sparse.issparse(X_trans)\n     assert X_trans.shape == (X_trans.shape[0], X_trans.shape[0] + 1)\n     assert_array_equal(X_trans.toarray()[:, 1:], np.eye(X_trans.shape[0]))\n@@ -531,8 +534,8 @@ def test_column_transformer_sparse_stacking(csr_container):\n         [(\"trans1\", Trans(), [0]), (\"trans2\", SparseMatrixTrans(csr_container), 1)],\n         sparse_threshold=0.1,\n     )\n-    col_trans.fit(X_array)\n-    X_trans = col_trans.transform(X_array)\n+    col_trans.fit(X)\n+    X_trans = col_trans.transform(X)\n     assert not sparse.issparse(X_trans)\n     assert X_trans.shape == (X_trans.shape[0], X_trans.shape[0] + 1)\n     assert_array_equal(X_trans[:, 1:], np.eye(X_trans.shape[0]))\ndiff --git a/sklearn/utils/_testing.py b/sklearn/utils/_testing.py\nindex c373dbc66f6d6..c3a1b5d6b73b7 100644\n--- a/sklearn/utils/_testing.py\n+++ b/sklearn/utils/_testing.py\n@@ -976,12 +976,12 @@ def _convert_container(\n     container : array-like\n         The container to convert.\n     constructor_name : {\"list\", \"tuple\", \"array\", \"sparse\", \"dataframe\", \\\n-            \"series\", \"index\", \"slice\", \"sparse_csr\", \"sparse_csc\", \\\n+            \"pandas\", \"series\", \"index\", \"slice\", \"sparse_csr\", \"sparse_csc\", \\\n             \"sparse_csr_array\", \"sparse_csc_array\", \"pyarrow\", \"polars\", \\\n             \"polars_series\"}\n         The type of the returned container.\n     columns_name : index or array-like, default=None\n-        For pandas container supporting `columns_names`, it will affect\n+        For pandas/polars container supporting `columns_names`, it will affect\n         specific names.\n     dtype : dtype, default=None\n         Force the dtype of the container. Does not apply to `\"slice\"`\n",
  "fail_to_pass": [
    "test_column_transformer_sparse_stacking"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/compose/_column_transformer.py",
    "sklearn/compose/tests/test_column_transformer.py",
    "sklearn/utils/_testing.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-09-15T11:18:41Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32188",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/32155"
}