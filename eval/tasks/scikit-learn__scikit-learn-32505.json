{
  "id": "scikit-learn__scikit-learn-32505",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "f1261a9356fe4519ac25af3a2e2b7ec31de3be96",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 32505,
  "pr_title": "CI Handle `[all random seeds]` commit marker in GHA",
  "gold_patch": "diff --git a/.github/workflows/unit-tests.yml b/.github/workflows/unit-tests.yml\nindex a67818bfdadd5..466f3640cf706 100644\n--- a/.github/workflows/unit-tests.yml\n+++ b/.github/workflows/unit-tests.yml\n@@ -52,7 +52,7 @@ jobs:\n         with:\n           ref: ${{ github.event.pull_request.head.sha }}\n       - id: git-log\n-        name: Set commit message job output\n+        name: Retrieve the latest commit message\n         shell: bash\n         run: |\n           set -eu\n@@ -65,11 +65,52 @@ jobs:\n             echo EOF\n           } >> \"${GITHUB_OUTPUT}\"\n \n+  retrieve-selected-tests:\n+    # Parse the commit message to check if `build_tools/azure/test_script.sh` should run\n+    # only specific tests.\n+    #\n+    # If so, selected tests will be run with SKLEARN_TESTS_GLOBAL_RANDOM_SEED=\"all\".\n+    #\n+    # The commit message must take the form:\n+    #     <title> [all random seeds]\n+    #     <test_name_1>\n+    #     <test_name_2>\n+    #     ...\n+    name: Retrieve the selected tests\n+    runs-on: ubuntu-latest\n+    if: github.repository == 'scikit-learn/scikit-learn'\n+    outputs:\n+      tests: ${{ steps.selected-tests.outputs.tests }}\n+    needs: [retrieve-commit-message]\n+    steps:\n+      - id: selected-tests\n+        name: Retrieve the selected tests\n+        shell: python\n+        env:\n+          COMMIT_MESSAGE: ${{ needs.retrieve-commit-message.outputs.message }}\n+        run: |\n+          import os\n+\n+          commit_message = os.environ[\"COMMIT_MESSAGE\"]\n+\n+          # Retrieve selected tests from commit message\n+          if \"[all random seeds]\" in commit_message:\n+              selected_tests = commit_message.split(\"[all random seeds]\")[1].strip()\n+              selected_tests = selected_tests.replace(\"\\n\", \" or \")\n+              # quote 'selected_tests' to cover the case of multiple selected tests\n+              selected_tests = f\"{selected_tests!r}\"\n+          else:\n+              selected_tests = \"\"\n+\n+          # Write selected tests to `GITHUB_OUTPUT`\n+          with open(os.environ[\"GITHUB_OUTPUT\"], \"a\") as file:\n+              file.write(f\"tests={selected_tests}\\n\")\n+\n   unit-tests:\n     name: ${{ matrix.name }}\n     runs-on: ${{ matrix.os }}\n     if: github.repository == 'scikit-learn/scikit-learn'\n-    needs: [lint, retrieve-commit-message]\n+    needs: [lint, retrieve-commit-message, retrieve-selected-tests]\n     strategy:\n       # Ensures that all builds run to completion even if one of them fails\n       fail-fast: false\n@@ -111,21 +152,19 @@ jobs:\n         run: bash -l build_tools/azure/install.sh\n \n       - name: Run tests\n-        run: bash -l build_tools/azure/test_script.sh\n         env:\n           COMMIT_MESSAGE: ${{ needs.retrieve-commit-message.outputs.message }}\n+          SELECTED_TESTS: ${{ needs.retrieve-selected-tests.outputs.tests }}\n+          COVERAGE: ${{ env.COVERAGE == 'true' && needs.retrieve-selected-tests.outputs.tests == ''}}\n+        run: bash -l build_tools/azure/test_script.sh\n \n       - name: Combine coverage reports from parallel test runners\n         run: bash -l build_tools/azure/combine_coverage_reports.sh\n-        if: ${{ env.COVERAGE == 'true' }}\n+        if: ${{ env.COVERAGE == 'true' && needs.retrieve-selected-tests.outputs.tests == ''}}\n \n       - name: Upload coverage report to Codecov\n         uses: codecov/codecov-action@v5\n-        # TODO: should depend on whether we run the whole test suite (could be by adding\n-        # && env.SELECTED_TESTS == '' as in build_tools/azure/posix.yml, or setting\n-        # env.COVERAGE == 'false' before the \"Run tests\" step, so reports are not\n-        # generated at all)\n-        if: ${{ env.COVERAGE == 'true' }}\n+        if: ${{ env.COVERAGE == 'true' && needs.retrieve-selected-tests.outputs.tests == ''}}\n         with:\n           files: ./coverage.xml\n           token: ${{ secrets.CODECOV_TOKEN }}\ndiff --git a/build_tools/azure/get_commit_message.py b/build_tools/azure/get_commit_message.py\nindex 94aed95dc2b63..f110697c2b24f 100644\n--- a/build_tools/azure/get_commit_message.py\n+++ b/build_tools/azure/get_commit_message.py\n@@ -1,21 +1,18 @@\n import argparse\n import os\n import subprocess\n-import warnings\n \n \n def get_commit_message():\n     \"\"\"Retrieve the commit message.\"\"\"\n-    build_source_version_message = os.environ.get(\"BUILD_SOURCEVERSIONMESSAGE\")\n-    if build_source_version_message is None:\n-        # We are not on Azure: behaviour based on commit-message is not\n-        # supported for now.\n-        # TODO: this should be implemented at one point for GHA.\n-        warnings.warn(\n-            \"get_commit_message not supported outside Azure for now, \"\n-            \"returning empty commit message\"\n+\n+    if \"COMMIT_MESSAGE\" in os.environ or \"BUILD_SOURCEVERSIONMESSAGE\" not in os.environ:\n+        raise RuntimeError(\n+            \"This legacy script should only be used on Azure. \"\n+            \"On GitHub actions, use the 'COMMIT_MESSAGE' environment variable\"\n         )\n-        return \"\"\n+\n+    build_source_version_message = os.environ[\"BUILD_SOURCEVERSIONMESSAGE\"]\n \n     if os.environ[\"BUILD_REASON\"] == \"PullRequest\":\n         # By default pull requests use refs/pull/PULL_ID/merge as the source branch\ndiff --git a/build_tools/azure/get_selected_tests.py b/build_tools/azure/get_selected_tests.py\nindex f453748f843c4..177d42604a5b2 100644\n--- a/build_tools/azure/get_selected_tests.py\n+++ b/build_tools/azure/get_selected_tests.py\n@@ -1,3 +1,5 @@\n+import os\n+\n from get_commit_message import get_commit_message\n \n \n@@ -12,6 +14,12 @@ def get_selected_tests():\n         <test_name_2>\n         ...\n     \"\"\"\n+    if \"SELECTED_TESTS\" in os.environ:\n+        raise RuntimeError(\n+            \"This legacy script should only be used on Azure. \"\n+            \"On GitHub actions, use the 'SELECTED_TESTS' environment variable\"\n+        )\n+\n     commit_message = get_commit_message()\n \n     if \"[all random seeds]\" in commit_message:\n",
  "fail_to_pass": [],
  "pass_to_pass": [],
  "relevant_files": [
    "build_tools/azure/get_commit_message.py",
    "build_tools/azure/get_selected_tests.py"
  ],
  "difficulty": "medium",
  "created_at": "2025-10-15T09:22:07Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32505",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}