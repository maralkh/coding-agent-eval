{
  "id": "scikit-learn__scikit-learn-29977",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "7ab1b647f57e0df5f33bdf14ae57a62b0bd861dd",
  "issue_number": 29929,
  "issue_title": "Custom estimator's fit() method throws \"RuntimeWarning: invalid value encountered in cast\" in Linux Python 3.11/3.12",
  "issue_body": "### Describe the bug\r\n\r\nWe have a custom estimator class that inherits from `sklearn.base.BaseEstimator` and `RegressorMixin`. We run automated unit tests in Azure DevOps pipelines on both Windows Server 2022 and Ubuntu 22.04.1. All the tests pass on Windows. On Python 3.12.6 in Linux the test with the stacktrace shown below fails with:\r\n\r\n`RuntimeWarning: invalid value encountered in cast`\r\n\r\nThis causes the test and hence build to fail because we set `PYTHONWARNINGS=error` before running the tests. On Python 3.11.10 in Linux this test actually passes; but a different test using the same custom estimator fails with an identical stacktrace. And yet this latter test passes on Python 3.12 in Linux!\r\n\r\nNote this change in numpy 1.24.0: https://numpy.org/doc/stable/release/1.24.0-notes.html#numpy-now-gives-floating-point-errors-in-casts;  especially this bit:\r\n\r\n> The precise behavior is subject to the C99 standard and its implementation in both software and hardware.\r\n\r\nI can probably work around this error in our tests by using a [numpy.errstate](https://numpy.org/doc/stable/reference/generated/numpy.errstate.html#numpy-errstate) context manager, but could there be a bug in sklearn?\r\n\r\nI don't know if this issue is related to #25319. AFAIK the test data has no nan values; the feature data columns are all float64.\r\n\r\n\r\n### Steps/Code to Reproduce\r\n\r\nSorry, this is proprietary code which I didn't write and don't understand!\r\n\r\n### Expected Results\r\n\r\nThe call to `fit()` succeeds without throwing a `RuntimeWarning`.\r\n\r\n### Actual Results\r\n\r\nStacktrace from Python 3.12.6 x64 on Linux (Ubuntu 22.04.1):\r\n```\r\nTraceback (most recent call last):\r\n  File \"/home/vsts/work/1/tests/<our_test_module>\", line 76, in test_gen_data\r\n    grid_search.fit(data[features].values)\r\n  File \"/opt/hostedtoolcache/Python/3.12.6/x64/lib/python3.12/site-packages/sklearn/base.py\", line 1473, in wrapper\r\n    return fit_method(estimator, *args, **kwargs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/opt/hostedtoolcache/Python/3.12.6/x64/lib/python3.12/site-packages/sklearn/model_selection/_search.py\", line 1019, in fit\r\n    self._run_search(evaluate_candidates)\r\n  File \"/opt/hostedtoolcache/Python/3.12.6/x64/lib/python3.12/site-packages/sklearn/model_selection/_search.py\", line 1573, in _run_search\r\n    evaluate_candidates(ParameterGrid(self.param_grid))\r\n  File \"/opt/hostedtoolcache/Python/3.12.6/x64/lib/python3.12/site-packages/sklearn/model_selection/_search.py\", line 1013, in evaluate_candidates\r\n    results = self._format_results(\r\n              ^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/opt/hostedtoolcache/Python/3.12.6/x64/lib/python3.12/site-packages/sklearn/model_selection/_search.py\", line 1137, in _format_results\r\n    for param, ma in _yield_masked_array_for_each_param(candidate_params):\r\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/opt/hostedtoolcache/Python/3.12.6/x64/lib/python3.12/site-packages/sklearn/model_selection/_search.py\", line 429, in _yield_masked_array_for_each_param\r\n    ma = MaskedArray(np.empty(n_candidates), mask=True, dtype=arr_dtype)\r\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/opt/hostedtoolcache/Python/3.12.6/x64/lib/python3.12/site-packages/numpy/ma/core.py\", line 2820, in __new__\r\n    _data = np.array(data, dtype=dtype, copy=copy,\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nRuntimeWarning: invalid value encountered in cast\r\n```\r\n\r\n### Versions\r\nRelevant pip-installed package versions, which were all the same in Python 3.11 and 3.12 in both Linux and Windows on Azure DevOps:\r\n```shell\r\nnumpy           1.26.4\r\npandas          2.2.3\r\nscikit-learn    1.5.2\r\nscipy           1.14.1\r\n```\r\n",
  "pr_number": 29977,
  "pr_title": "MAINT Avoid RuntimeWarning about invalid value in cast",
  "gold_patch": "diff --git a/sklearn/model_selection/_search.py b/sklearn/model_selection/_search.py\nindex ab828ee919866..2935f7ce2465c 100644\n--- a/sklearn/model_selection/_search.py\n+++ b/sklearn/model_selection/_search.py\n@@ -422,7 +422,7 @@ def _yield_masked_array_for_each_param(candidate_params):\n \n         # Use one MaskedArray and mask all the places where the param is not\n         # applicable for that candidate (which may not contain all the params).\n-        ma = MaskedArray(np.empty(n_candidates), mask=True, dtype=arr_dtype)\n+        ma = MaskedArray(np.empty(n_candidates, dtype=arr_dtype), mask=True)\n         for index, value in param_result.items():\n             # Setting the value at an index unmasks that index\n             ma[index] = value\ndiff --git a/sklearn/model_selection/tests/test_search.py b/sklearn/model_selection/tests/test_search.py\nindex e7637be8d654b..0efb934795be2 100644\n--- a/sklearn/model_selection/tests/test_search.py\n+++ b/sklearn/model_selection/tests/test_search.py\n@@ -2864,3 +2864,11 @@ def test_yield_masked_array_for_each_param(candidate_params, expected):\n         assert value.dtype == expected_value.dtype\n         np.testing.assert_array_equal(value, expected_value)\n         np.testing.assert_array_equal(value.mask, expected_value.mask)\n+\n+\n+def test_yield_masked_array_no_runtime_warning():\n+    # non-regression test for https://github.com/scikit-learn/scikit-learn/issues/29929\n+    candidate_params = [{\"param\": i} for i in range(1000)]\n+    with warnings.catch_warnings():\n+        warnings.simplefilter(\"error\", RuntimeWarning)\n+        list(_yield_masked_array_for_each_param(candidate_params))\n",
  "fail_to_pass": [
    "test_yield_masked_array_no_runtime_warning"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/model_selection/_search.py",
    "sklearn/model_selection/tests/test_search.py"
  ],
  "difficulty": "medium",
  "created_at": "2024-09-30T15:12:22Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/29977",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/29929"
}