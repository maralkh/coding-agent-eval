{
  "id": "scikit-learn__scikit-learn-31263",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "b98dc797c480b1b9495f918e201d45ee07f29feb",
  "issue_number": 31257,
  "issue_title": "\u26a0\ufe0f CI failed on Wheel builder (last failure: Apr 28, 2025) \u26a0\ufe0f",
  "issue_body": "**CI is still failing on [Wheel builder](https://github.com/scikit-learn/scikit-learn/actions/runs/14699848568)** (Apr 28, 2025)\n",
  "pr_number": 31263,
  "pr_title": "Use BLAS_Order.ColMajor sklearn/utils/_cython_blas.pyx",
  "gold_patch": "diff --git a/azure-pipelines.yml b/azure-pipelines.yml\nindex c4d856e42b6b8..804214f97808a 100644\n--- a/azure-pipelines.yml\n+++ b/azure-pipelines.yml\n@@ -88,6 +88,7 @@ jobs:\n         DISTRIB: 'conda-free-threaded'\n         LOCK_FILE: './build_tools/azure/pylatest_free_threaded_linux-64_conda.lock'\n         COVERAGE: 'false'\n+        SKLEARN_FAULTHANDLER_TIMEOUT: '1800'  # 30 * 60 seconds\n \n # Will run all the time regardless of linting outcome.\n - template: build_tools/azure/posix.yml\ndiff --git a/sklearn/conftest.py b/sklearn/conftest.py\nindex 6af3a2a51c0ce..970836fc6287b 100644\n--- a/sklearn/conftest.py\n+++ b/sklearn/conftest.py\n@@ -2,6 +2,7 @@\n # SPDX-License-Identifier: BSD-3-Clause\n \n import builtins\n+import faulthandler\n import platform\n import sys\n from contextlib import suppress\n@@ -341,6 +342,11 @@ def pytest_configure(config):\n         for line in get_pytest_filterwarning_lines():\n             config.addinivalue_line(\"filterwarnings\", line)\n \n+    faulthandler_timeout = int(environ.get(\"SKLEARN_FAULTHANDLER_TIMEOUT\", \"0\"))\n+    if faulthandler_timeout > 0:\n+        faulthandler.enable()\n+        faulthandler.dump_traceback_later(faulthandler_timeout, exit=True)\n+\n \n @pytest.fixture\n def hide_available_pandas(monkeypatch):\ndiff --git a/sklearn/utils/_cython_blas.pyx b/sklearn/utils/_cython_blas.pyx\nindex c242e59e1b9de..ac23d0c4000ff 100644\n--- a/sklearn/utils/_cython_blas.pyx\n+++ b/sklearn/utils/_cython_blas.pyx\n@@ -126,8 +126,8 @@ cdef void _gemv(BLAS_Order order, BLAS_Trans ta, int m, int n, floating alpha,\n                 floating beta, floating *y, int incy) noexcept nogil:\n     \"\"\"y := alpha * op(A).x + beta * y\"\"\"\n     cdef char ta_ = ta\n-    if order == RowMajor:\n-        ta_ = NoTrans if ta == Trans else Trans\n+    if order == BLAS_Order.RowMajor:\n+        ta_ = BLAS_Trans.NoTrans if ta == BLAS_Trans.Trans else BLAS_Trans.Trans\n         if floating is float:\n             sgemv(&ta_, &n, &m, &alpha, <float *> A, &lda, <float *> x,\n                   &incx, &beta, y, &incy)\n@@ -148,8 +148,10 @@ cpdef _gemv_memview(BLAS_Trans ta, floating alpha, const floating[:, :] A,\n     cdef:\n         int m = A.shape[0]\n         int n = A.shape[1]\n-        BLAS_Order order = ColMajor if A.strides[0] == A.itemsize else RowMajor\n-        int lda = m if order == ColMajor else n\n+        BLAS_Order order = (\n+            BLAS_Order.ColMajor if A.strides[0] == A.itemsize else BLAS_Order.RowMajor\n+        )\n+        int lda = m if order == BLAS_Order.ColMajor else n\n \n     _gemv(order, ta, m, n, alpha, &A[0, 0], lda, &x[0], 1, beta, &y[0], 1)\n \n@@ -158,7 +160,7 @@ cdef void _ger(BLAS_Order order, int m, int n, floating alpha,\n                const floating *x, int incx, const floating *y,\n                int incy, floating *A, int lda) noexcept nogil:\n     \"\"\"A := alpha * x.y.T + A\"\"\"\n-    if order == RowMajor:\n+    if order == BLAS_Order.RowMajor:\n         if floating is float:\n             sger(&n, &m, &alpha, <float *> y, &incy, <float *> x, &incx, A, &lda)\n         else:\n@@ -175,8 +177,10 @@ cpdef _ger_memview(floating alpha, const floating[::1] x,\n     cdef:\n         int m = A.shape[0]\n         int n = A.shape[1]\n-        BLAS_Order order = ColMajor if A.strides[0] == A.itemsize else RowMajor\n-        int lda = m if order == ColMajor else n\n+        BLAS_Order order = (\n+            BLAS_Order.ColMajor if A.strides[0] == A.itemsize else BLAS_Order.RowMajor\n+        )\n+        int lda = m if order == BLAS_Order.ColMajor else n\n \n     _ger(order, m, n, alpha, &x[0], 1, &y[0], 1, &A[0, 0], lda)\n \n@@ -194,7 +198,7 @@ cdef void _gemm(BLAS_Order order, BLAS_Trans ta, BLAS_Trans tb, int m, int n,\n     cdef:\n         char ta_ = ta\n         char tb_ = tb\n-    if order == RowMajor:\n+    if order == BLAS_Order.RowMajor:\n         if floating is float:\n             sgemm(&tb_, &ta_, &n, &m, &k, &alpha, <float*>B,\n                   &ldb, <float*>A, &lda, &beta, C, &ldc)\n@@ -214,19 +218,21 @@ cpdef _gemm_memview(BLAS_Trans ta, BLAS_Trans tb, floating alpha,\n                     const floating[:, :] A, const floating[:, :] B, floating beta,\n                     floating[:, :] C):\n     cdef:\n-        int m = A.shape[0] if ta == NoTrans else A.shape[1]\n-        int n = B.shape[1] if tb == NoTrans else B.shape[0]\n-        int k = A.shape[1] if ta == NoTrans else A.shape[0]\n+        int m = A.shape[0] if ta == BLAS_Trans.NoTrans else A.shape[1]\n+        int n = B.shape[1] if tb == BLAS_Trans.NoTrans else B.shape[0]\n+        int k = A.shape[1] if ta == BLAS_Trans.NoTrans else A.shape[0]\n         int lda, ldb, ldc\n-        BLAS_Order order = ColMajor if A.strides[0] == A.itemsize else RowMajor\n+        BLAS_Order order = (\n+            BLAS_Order.ColMajor if A.strides[0] == A.itemsize else BLAS_Order.RowMajor\n+        )\n \n-    if order == RowMajor:\n-        lda = k if ta == NoTrans else m\n-        ldb = n if tb == NoTrans else k\n+    if order == BLAS_Order.RowMajor:\n+        lda = k if ta == BLAS_Trans.NoTrans else m\n+        ldb = n if tb == BLAS_Trans.NoTrans else k\n         ldc = n\n     else:\n-        lda = m if ta == NoTrans else k\n-        ldb = k if tb == NoTrans else n\n+        lda = m if ta == BLAS_Trans.NoTrans else k\n+        ldb = k if tb == BLAS_Trans.NoTrans else n\n         ldc = m\n \n     _gemm(order, ta, tb, m, n, k, alpha, &A[0, 0],\n",
  "fail_to_pass": [],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/conftest.py"
  ],
  "difficulty": "medium",
  "created_at": "2025-04-28T08:41:26Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/31263",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/31257"
}