{
  "id": "scikit-learn__scikit-learn-31190",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "5943ab2d304f0d2f9276c5db3c95ab0a68c4023a",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 31190,
  "pr_title": "ENH Add Array API compatibility to Binarizer",
  "gold_patch": "diff --git a/doc/modules/array_api.rst b/doc/modules/array_api.rst\nindex b4940eccec2fc..e7261ea35cc7c 100644\n--- a/doc/modules/array_api.rst\n+++ b/doc/modules/array_api.rst\n@@ -111,6 +111,7 @@ Estimators\n   `svd_solver=\"randomized\"` and `power_iteration_normalizer=\"QR\"`)\n - :class:`linear_model.Ridge` (with `solver=\"svd\"`)\n - :class:`discriminant_analysis.LinearDiscriminantAnalysis` (with `solver=\"svd\"`)\n+- :class:`preprocessing.Binarizer`\n - :class:`preprocessing.KernelCenterer`\n - :class:`preprocessing.LabelEncoder`\n - :class:`preprocessing.MaxAbsScaler`\ndiff --git a/doc/whats_new/upcoming_changes/array-api/31190.feature.rst b/doc/whats_new/upcoming_changes/array-api/31190.feature.rst\nnew file mode 100644\nindex 0000000000000..15504c0e28fce\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/array-api/31190.feature.rst\n@@ -0,0 +1,2 @@\n+- :class:`preprocessing.Binarizer` now supports Array API compatible inputs.\n+  By :user:`Yaroslav Korobko <Tialo>`, :user:`Olivier Grisel <ogrisel>`, and :user:`Thomas Li <lithomas1>`.\ndiff --git a/sklearn/preprocessing/_data.py b/sklearn/preprocessing/_data.py\nindex 74d7b1909c4e1..d671376b9330d 100644\n--- a/sklearn/preprocessing/_data.py\n+++ b/sklearn/preprocessing/_data.py\n@@ -19,7 +19,13 @@\n     _fit_context,\n )\n from ..utils import _array_api, check_array, resample\n-from ..utils._array_api import _modify_in_place_if_numpy, device, get_namespace\n+from ..utils._array_api import (\n+    _find_matching_floating_dtype,\n+    _modify_in_place_if_numpy,\n+    device,\n+    get_namespace,\n+    get_namespace_and_device,\n+)\n from ..utils._param_validation import Interval, Options, StrOptions, validate_params\n from ..utils.extmath import _incremental_mean_and_var, row_norms\n from ..utils.sparsefuncs import (\n@@ -2209,8 +2215,10 @@ def binarize(X, *, threshold=0.0, copy=True):\n         X.data[not_cond] = 0\n         X.eliminate_zeros()\n     else:\n-        cond = X > threshold\n-        not_cond = np.logical_not(cond)\n+        xp, _, device = get_namespace_and_device(X)\n+        float_dtype = _find_matching_floating_dtype(X, threshold, xp=xp)\n+        cond = xp.astype(X, float_dtype, copy=False) > threshold\n+        not_cond = xp.logical_not(cond)\n         X[cond] = 1\n         X[not_cond] = 0\n     return X\n@@ -2353,6 +2361,7 @@ def transform(self, X, copy=None):\n     def __sklearn_tags__(self):\n         tags = super().__sklearn_tags__()\n         tags.requires_fit = False\n+        tags.array_api_support = True\n         tags.input_tags.sparse = True\n         return tags\n \ndiff --git a/sklearn/preprocessing/tests/test_data.py b/sklearn/preprocessing/tests/test_data.py\nindex ac303a1c93e96..4732d2960360c 100644\n--- a/sklearn/preprocessing/tests/test_data.py\n+++ b/sklearn/preprocessing/tests/test_data.py\n@@ -9,7 +9,7 @@\n import pytest\n from scipy import sparse, stats\n \n-from sklearn import datasets\n+from sklearn import config_context, datasets\n from sklearn.base import clone\n from sklearn.exceptions import NotFittedError\n from sklearn.metrics.pairwise import linear_kernel\n@@ -38,11 +38,13 @@\n from sklearn.svm import SVR\n from sklearn.utils import gen_batches, shuffle\n from sklearn.utils._array_api import (\n+    _convert_to_numpy,\n     _get_namespace_device_dtype_ids,\n     yield_namespace_device_dtype_combinations,\n )\n from sklearn.utils._test_common.instance_generator import _get_check_estimator_ids\n from sklearn.utils._testing import (\n+    _array_api_for_tests,\n     _convert_container,\n     assert_allclose,\n     assert_allclose_dense_sparse,\n@@ -709,10 +711,11 @@ def test_standard_check_array_of_inverse_transform():\n         Normalizer(norm=\"l1\"),\n         Normalizer(norm=\"l2\"),\n         Normalizer(norm=\"max\"),\n+        Binarizer(),\n     ],\n     ids=_get_check_estimator_ids,\n )\n-def test_scaler_array_api_compliance(\n+def test_preprocessing_array_api_compliance(\n     estimator, check, array_namespace, device, dtype_name\n ):\n     name = estimator.__class__.__name__\n@@ -2004,6 +2007,21 @@ def test_binarizer(constructor):\n             binarizer.transform(constructor(X))\n \n \n+@pytest.mark.parametrize(\n+    \"array_namespace, device, dtype_name\", yield_namespace_device_dtype_combinations()\n+)\n+def test_binarizer_array_api_int(array_namespace, device, dtype_name):\n+    # Checks that Binarizer works with integer elements and float threshold\n+    xp = _array_api_for_tests(array_namespace, device)\n+    for dtype_name_ in [dtype_name, \"int32\", \"int64\"]:\n+        X_np = np.reshape(np.asarray([0, 1, 2, 3, 4], dtype=dtype_name_), (-1, 1))\n+        X_xp = xp.asarray(X_np, device=device)\n+        binarized_np = Binarizer(threshold=2.5).fit_transform(X_np)\n+        with config_context(array_api_dispatch=True):\n+            binarized_xp = Binarizer(threshold=2.5).fit_transform(X_xp)\n+        assert_array_equal(_convert_to_numpy(binarized_xp, xp), binarized_np)\n+\n+\n def test_center_kernel():\n     # Test that KernelCenterer is equivalent to StandardScaler\n     # in feature space\n",
  "fail_to_pass": [
    "test_preprocessing_array_api_compliance",
    "test_binarizer_array_api_int"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/preprocessing/_data.py",
    "sklearn/preprocessing/tests/test_data.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-04-13T20:21:12Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/31190",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}