{
  "id": "scikit-learn__scikit-learn-32433",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "ea9e824705cc6313aa65413e9ee245fa974f8dd6",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 32433,
  "pr_title": "FEA Add support for sparse input matrices in TSNE",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.manifold/32433.feature.rst b/doc/whats_new/upcoming_changes/sklearn.manifold/32433.feature.rst\nnew file mode 100644\nindex 0000000000000..6a65dd1ad56d9\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.manifold/32433.feature.rst\n@@ -0,0 +1,2 @@\n+- :class:`manifold.TSNE` now supports PCA initialization with sparse input matrices.\n+  By :user:`Arturo Amor <ArturoAmorQ>`.\ndiff --git a/examples/neighbors/approximate_nearest_neighbors.py b/examples/neighbors/approximate_nearest_neighbors.py\nindex a2da69f62fb10..eaacaf25f03d6 100644\n--- a/examples/neighbors/approximate_nearest_neighbors.py\n+++ b/examples/neighbors/approximate_nearest_neighbors.py\n@@ -121,7 +121,7 @@ def load_mnist(n_samples):\n     (\"MNIST_20000\", load_mnist(n_samples=20_000)),\n ]\n \n-n_iter = 500\n+max_iter = 500\n perplexity = 30\n metric = \"euclidean\"\n # TSNE requires a certain number of neighbors which depends on the\n@@ -130,11 +130,11 @@ def load_mnist(n_samples):\n n_neighbors = int(3.0 * perplexity + 1) + 1\n \n tsne_params = dict(\n-    init=\"random\",  # pca not supported for sparse matrices\n+    init=\"random\",  # pca cannot be used with precomputed distances\n     perplexity=perplexity,\n     method=\"barnes_hut\",\n     random_state=42,\n-    n_iter=n_iter,\n+    max_iter=max_iter,\n     learning_rate=\"auto\",\n )\n \ndiff --git a/sklearn/manifold/_t_sne.py b/sklearn/manifold/_t_sne.py\nindex 2f15b22be06ff..2527fbc0959fb 100644\n--- a/sklearn/manifold/_t_sne.py\n+++ b/sklearn/manifold/_t_sne.py\n@@ -852,13 +852,6 @@ def _check_params_vs_input(self, X):\n     def _fit(self, X, skip_num_points=0):\n         \"\"\"Private function to fit the model using X as training data.\"\"\"\n \n-        if isinstance(self.init, str) and self.init == \"pca\" and issparse(X):\n-            raise TypeError(\n-                \"PCA initialization is currently not supported \"\n-                \"with the sparse input matrix. Use \"\n-                'init=\"random\" instead.'\n-            )\n-\n         if self.learning_rate == \"auto\":\n             # See issue #18018\n             self.learning_rate_ = X.shape[0] / self.early_exaggeration / 4\n@@ -1009,7 +1002,6 @@ def _fit(self, X, skip_num_points=0):\n         elif self.init == \"pca\":\n             pca = PCA(\n                 n_components=self.n_components,\n-                svd_solver=\"randomized\",\n                 random_state=random_state,\n             )\n             # Always output a numpy array, no matter what is configured globally\n@@ -1181,4 +1173,5 @@ def _n_features_out(self):\n     def __sklearn_tags__(self):\n         tags = super().__sklearn_tags__()\n         tags.input_tags.pairwise = self.metric == \"precomputed\"\n+        tags.input_tags.sparse = True\n         return tags\ndiff --git a/sklearn/manifold/tests/test_t_sne.py b/sklearn/manifold/tests/test_t_sne.py\nindex 591f0a6a9c9b5..52d2ac53282db 100644\n--- a/sklearn/manifold/tests/test_t_sne.py\n+++ b/sklearn/manifold/tests/test_t_sne.py\n@@ -315,18 +315,19 @@ def test_optimization_minimizes_kl_divergence():\n \n \n @pytest.mark.parametrize(\"method\", [\"exact\", \"barnes_hut\"])\n+@pytest.mark.parametrize(\"init\", [\"random\", \"pca\"])\n @pytest.mark.parametrize(\"csr_container\", CSR_CONTAINERS)\n-def test_fit_transform_csr_matrix(method, csr_container):\n+def test_fit_transform_csr_matrix(method, init, csr_container):\n     # TODO: compare results on dense and sparse data as proposed in:\n     # https://github.com/scikit-learn/scikit-learn/pull/23585#discussion_r968388186\n     # X can be a sparse matrix.\n     rng = check_random_state(0)\n-    X = rng.randn(50, 2)\n-    X[(rng.randint(0, 50, 25), rng.randint(0, 2, 25))] = 0.0\n+    X = rng.randn(50, 3)\n+    X[(rng.randint(0, 50, 25), rng.randint(0, 3, 25))] = 0.0\n     X_csr = csr_container(X)\n     tsne = TSNE(\n         n_components=2,\n-        init=\"random\",\n+        init=init,\n         perplexity=10,\n         learning_rate=100.0,\n         random_state=0,\n@@ -484,14 +485,6 @@ def test_pca_initialization_not_compatible_with_precomputed_kernel():\n         tsne.fit_transform(np.array([[0.0], [1.0]]))\n \n \n-@pytest.mark.parametrize(\"csr_container\", CSR_CONTAINERS)\n-def test_pca_initialization_not_compatible_with_sparse_input(csr_container):\n-    # Sparse input matrices cannot use PCA initialization.\n-    tsne = TSNE(init=\"pca\", learning_rate=100.0, perplexity=1)\n-    with pytest.raises(TypeError, match=\"PCA initialization.*\"):\n-        tsne.fit_transform(csr_container([[0, 5], [5, 0]]))\n-\n-\n def test_n_components_range():\n     # barnes_hut method should only be used with n_components <= 3\n     tsne = TSNE(n_components=4, method=\"barnes_hut\", perplexity=1)\n",
  "fail_to_pass": [
    "test_fit_transform_csr_matrix"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "examples/neighbors/approximate_nearest_neighbors.py",
    "sklearn/manifold/_t_sne.py",
    "sklearn/manifold/tests/test_t_sne.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-10-08T10:18:18Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32433",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}