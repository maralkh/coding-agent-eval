{
  "id": "scikit-learn__scikit-learn-31584",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "d0575ec626f3d7916a4cd11fee5974ff5c8a93ae",
  "issue_number": 31583,
  "issue_title": "Unjustified \"number of unique classes > 50%\" warning in CalibratedClassifierCV",
  "issue_body": "### Describe the bug\n\nWhile using CalibratedClassifierCV with a multiclass dataset, I noticed that the following warning is raised, even though the number of classes is much smaller than the number of samples:\n\n```\nUserWarning: The number of unique classes is greater than 50% of the number of samples.\n```\n\nThis seems unexpected, so I tried to reproduce the situation with synthetic data. From what I can tell, the number of classes is well below 50% of the number of training samples passed to fit().\n\nIt\u2019s possible I\u2019m misunderstanding the intended behavior, but based on reading the source code, it looks like this might be caused by a call to type_of_target(classes_) (instead of y), which could falsely trigger the condition if classes_ is treated like data.\n\n(The same happens with GridSearchCV, for example).\n\n### Steps/Code to Reproduce\n\n```python\nimport numpy as np\nfrom sklearn.calibration import CalibratedClassifierCV\nfrom sklearn.ensemble import RandomForestClassifier\n\n\ndef main():\n\t# Simulate 1000 samples, 40 features, 30 classes (<< 50%)\n\tn_samples = 1000\n\tn_features = 40\n\tn_classes = 30\n\n\trng = np.random.RandomState(42)\n\tx = rng.rand(n_samples, n_features)\n\ty = np.tile(np.arange(n_classes), int(np.ceil(n_samples / n_classes)))[:n_samples]\n\n\tprint(f\"Samples: {len(y)}\")\n\tprint(f\"Unique classes: {len(np.unique(y))}\")\n\tprint(f\"Class/sample ratio: {len(np.unique(y)) / len(y):.2%}\")\n\n\tbase_clf = RandomForestClassifier(n_estimators=100, random_state=42)\n\tcal_clf = CalibratedClassifierCV(base_clf, method='isotonic', cv=2)\n\tcal_clf.fit(x, y)\n\n\nif __name__ == '__main__':\n\tmain()\n```\n\n### Expected Results\n\nI expected no warning to be raised, as the class/sample ratio is only ~3% (well under the 50% threshold). There are no rare classes, and the splits from CV should still contain enough samples.\n\n### Actual Results\n\n```\nSamples: 1000\nUnique classes: 30\nClass/sample ratio: 3.00%\n/miniconda3/envs/sklearn_check/lib/python3.13/site-packages/sklearn/utils/_response.py:203: UserWarning: The number of unique classes is greater than 50% of the number of samples.\n  target_type = type_of_target(classes)\n/miniconda3/envs/sklearn_check/lib/python3.13/site-packages/sklearn/utils/_response.py:203: UserWarning: The number of unique classes is greater than 50% of the number of samples.\n  target_type = type_of_target(classes)\n```\n\n### Versions\n\n```shell\nSystem:\n    python: 3.13.5 | packaged by conda-forge | (main, Jun 16 2025, 08:27:50) [GCC 13.3.0]\nexecutable: /miniconda3/envs/sklearn_check/bin/python\n   machine: Linux-6.8.0-60-generic-x86_64-with-glibc2.39\n\nPython dependencies:\n      sklearn: 1.7.0\n          pip: 25.1.1\n   setuptools: 80.9.0\n        numpy: 2.3.0\n        scipy: 1.15.2\n       Cython: None\n       pandas: None\n   matplotlib: None\n       joblib: 1.5.1\nthreadpoolctl: 3.6.0\n\nBuilt with OpenMP: True\n\nthreadpoolctl info:\n       user_api: blas\n   internal_api: openblas\n    num_threads: 20\n         prefix: libopenblas\n       filepath: /miniconda3/envs/sklearn_check/lib/libopenblasp-r0.3.29.so\n        version: 0.3.29\nthreading_layer: pthreads\n   architecture: Haswell\n\n       user_api: openmp\n   internal_api: openmp\n    num_threads: 20\n         prefix: libgomp\n       filepath: /miniconda3/envs/sklearn_check/lib/libgomp.so.1.0.0\n        version: None\n```",
  "pr_number": 31584,
  "pr_title": "Fix spurious warning from type_of_target when called on estimator.classes_",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.utils/31584.fix.rst b/doc/whats_new/upcoming_changes/sklearn.utils/31584.fix.rst\nnew file mode 100644\nindex 0000000000000..5417dd80df975\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.utils/31584.fix.rst\n@@ -0,0 +1,4 @@\n+- Fixed a spurious warning (about the number of unique classes being\n+  greater than 50% of the number of samples) that could occur when\n+  passing `classes` :func:`utils.multiclass.type_of_target`.\n+  By :user:`Sascha D. Krauss <saskra>`.\ndiff --git a/sklearn/utils/multiclass.py b/sklearn/utils/multiclass.py\nindex 3a81e2b9eb6fe..d7c81a6f51624 100644\n--- a/sklearn/utils/multiclass.py\n+++ b/sklearn/utils/multiclass.py\n@@ -414,7 +414,7 @@ def _raise_or_return():\n     if issparse(first_row_or_val):\n         first_row_or_val = first_row_or_val.data\n     classes = cached_unique(y)\n-    if y.shape[0] > 20 and classes.shape[0] > round(0.5 * y.shape[0]):\n+    if y.shape[0] > 20 and y.shape[0] > classes.shape[0] > round(0.5 * y.shape[0]):\n         # Only raise the warning when we have at least 20 samples.\n         warnings.warn(\n             \"The number of unique classes is greater than 50% of the number \"\ndiff --git a/sklearn/utils/tests/test_multiclass.py b/sklearn/utils/tests/test_multiclass.py\nindex 433e8118923fb..a686b721f2393 100644\n--- a/sklearn/utils/tests/test_multiclass.py\n+++ b/sklearn/utils/tests/test_multiclass.py\n@@ -302,7 +302,11 @@ def test_type_of_target_too_many_unique_classes():\n     We need to check that we don't raise if we have less than 20 samples.\n     \"\"\"\n \n-    y = np.arange(25)\n+    # Create array of unique labels, except '0', which appears twice.\n+    # This does raise a warning.\n+    # Note warning would not be raised if we passed only unique\n+    # labels, which happens when `type_of_target` is passed `classes_`.\n+    y = np.hstack((np.arange(20), [0]))\n     msg = r\"The number of unique classes is greater than 50% of the number of samples.\"\n     with pytest.warns(UserWarning, match=msg):\n         type_of_target(y)\n@@ -313,6 +317,14 @@ def test_type_of_target_too_many_unique_classes():\n         warnings.simplefilter(\"error\")\n         type_of_target(y)\n \n+    # More than 20 samples but only unique classes, simulating passing\n+    # `classes_` to `type_of_target` (when number of classes is large).\n+    # No warning should be raised\n+    y = np.arange(25)\n+    with warnings.catch_warnings():\n+        warnings.simplefilter(\"ignore\", UserWarning)\n+        type_of_target(y)\n+\n \n def test_unique_labels_non_specific():\n     # Test unique_labels with a variety of collected examples\ndiff --git a/sklearn/utils/tests/test_response.py b/sklearn/utils/tests/test_response.py\nindex 858c16cca4df1..5f791b59dfaa3 100644\n--- a/sklearn/utils/tests/test_response.py\n+++ b/sklearn/utils/tests/test_response.py\n@@ -1,3 +1,5 @@\n+import warnings\n+\n import numpy as np\n import pytest\n \n@@ -369,3 +371,24 @@ def test_get_response_values_multilabel_indicator(response_method):\n         assert (y_pred > 1).sum() > 0\n     else:  # response_method == \"predict\"\n         assert np.logical_or(y_pred == 0, y_pred == 1).all()\n+\n+\n+def test_response_values_type_of_target_on_classes_no_warning():\n+    \"\"\"\n+    Ensure `_get_response_values` doesn't raise spurious warning.\n+\n+    \"The number of unique classes is greater than > 50% of samples\"\n+    warning should not be raised when calling `type_of_target(classes_)`.\n+\n+    Non-regression test for issue #31583.\n+    \"\"\"\n+    X = np.random.RandomState(0).randn(120, 3)\n+    # 30 classes, less than 50% of number of samples\n+    y = np.repeat(np.arange(30), 4)\n+\n+    clf = LogisticRegression().fit(X, y)\n+\n+    with warnings.catch_warnings():\n+        warnings.simplefilter(\"error\", UserWarning)\n+\n+        _get_response_values(clf, X, response_method=\"predict_proba\")\n",
  "fail_to_pass": [
    "test_response_values_type_of_target_on_classes_no_warning"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/utils/multiclass.py",
    "sklearn/utils/tests/test_multiclass.py",
    "sklearn/utils/tests/test_response.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-06-18T13:08:45Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/31584",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/31583"
}