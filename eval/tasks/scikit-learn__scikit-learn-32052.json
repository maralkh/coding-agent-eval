{
  "id": "scikit-learn__scikit-learn-32052",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "59c4b7a0270eae60e67fab11503378bea901b6fb",
  "issue_number": 31406,
  "issue_title": "Add array API support to `median_absolute_error`",
  "issue_body": "\r\n#### Reference Issues/PRs\r\nTowards #26024\r\n\r\n#### What does this implement/fix? Explain your changes.\r\n\r\nAdd array API support to `median_absolute_error`. (Currently the only change made was to add an array API supporting `_median` function, see below.)\r\n\r\n#### Any other comments?\r\n\r\nThis is the only metric to use `median`, however `median` is used in a fair number of estimators. I think the first item to address is which `median` should we use.\r\n\r\nArray API spec currently does not support `median` so these are our options:\r\n\r\n* Write our own `median` function (that uses `np.median` when namespace is numpy) - included in this PR, maintenance\r\n* Use our `_weighted_percentile` - slow\r\n* Push for `median` inclusion in array API. Admittedly, `median` is not used much outside of scikit-learn (https://github.com/data-apis/array-api/issues/795#issuecomment-2090852426), BUT it seems that most (all?) array libraries have an implementation. I would be in favour of pushing for inclusion, less so because of use, and more so because the implementation of `median` is well defined (vs e.g. quantile) and I think other array libraries do have an implementation, including [dask](https://docs.dask.org/en/stable/generated/dask.array.median.html). They may be open to this: https://github.com/data-apis/array-api/issues/795#issuecomment-2073761949\r\n\r\n\r\nHere are some benchmarking I did with numpy and cupy arrays. I wanted to increase the size of the arrays tested and include the new [scipy quantile](https://github.com/scipy/scipy/pull/22352) (which supports array API but not weights - as a reference, as I think we ultimately want to use this) but I ran out of GPU time in colab :upside_down_face:\r\nAlso maybe I should have also included torch CPU in the mix?\r\n\r\n(Randomly generated 1D array)\r\n\r\n|                                 | Numpy (1e7) | CuPy (1e7) |\r\n|---------------------------------|-------------|------------|\r\n| sklearn `_median`               | 0.182784s   | 0.017168s  |\r\n| sklearn `_weighted_percentile_` | 2.369427s   | 0.088325s  |\r\n| Cupy `median`                   | n/a         | 0.015946s  |\r\n\r\n",
  "pr_number": 32052,
  "pr_title": "MNT Remove xfail now array-api-strict >2.3.1",
  "gold_patch": "diff --git a/sklearn/metrics/tests/test_common.py b/sklearn/metrics/tests/test_common.py\nindex 3d9f8165bc17f..250fde9948f62 100644\n--- a/sklearn/metrics/tests/test_common.py\n+++ b/sklearn/metrics/tests/test_common.py\n@@ -2352,23 +2352,6 @@ def yield_metric_checker_combinations(metric_checkers=array_api_metric_checkers)\n )\n @pytest.mark.parametrize(\"metric, check_func\", yield_metric_checker_combinations())\n def test_array_api_compliance(metric, array_namespace, device, dtype_name, check_func):\n-    # TODO: Remove once array-api-strict > 2.3.1\n-    # https://github.com/data-apis/array-api-strict/issues/134 has been fixed but\n-    # not released yet.\n-    if (\n-        getattr(metric, \"__name__\", None) == \"median_absolute_error\"\n-        and array_namespace == \"array_api_strict\"\n-    ):\n-        try:\n-            import array_api_strict\n-        except ImportError:\n-            pass\n-        else:\n-            if device == array_api_strict.Device(\"device1\"):\n-                pytest.xfail(\n-                    \"`_weighted_percentile` is affected by array_api_strict bug when \"\n-                    \"indexing with tuple of arrays on non-'CPU_DEVICE' devices.\"\n-                )\n     check_func(metric, array_namespace, device, dtype_name)\n \n \n",
  "fail_to_pass": [],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/metrics/tests/test_common.py"
  ],
  "difficulty": "easy",
  "created_at": "2025-08-29T23:48:25Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32052",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/31406"
}