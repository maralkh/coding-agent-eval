{
  "id": "scikit-learn__scikit-learn-30521",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "eefcb113a410cc7cb15b16ebbbec3156832f8fdb",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 30521,
  "pr_title": "Add `tol` to `LinearRegression`",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.linear_model/30521.fix.rst b/doc/whats_new/upcoming_changes/sklearn.linear_model/30521.fix.rst\nnew file mode 100644\nindex 0000000000000..537c3760b16df\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.linear_model/30521.fix.rst\n@@ -0,0 +1,4 @@\n+-  |Enhancement| Added a new paramenter `tol` to\n+   :class:`linear_model.LinearRegression` that determines the precision of the\n+   solution `coef_` when fitting on sparse data. :pr:`30521` by :user:`Success Moses\n+   <SuccessMoses>`.\ndiff --git a/sklearn/linear_model/_base.py b/sklearn/linear_model/_base.py\nindex bb71cbe9ed550..6aa2e3e6563dc 100644\n--- a/sklearn/linear_model/_base.py\n+++ b/sklearn/linear_model/_base.py\n@@ -8,7 +8,7 @@\n import numbers\n import warnings\n from abc import ABCMeta, abstractmethod\n-from numbers import Integral\n+from numbers import Integral, Real\n \n import numpy as np\n import scipy.sparse as sp\n@@ -32,6 +32,7 @@\n     indexing_dtype,\n     supported_float_dtypes,\n )\n+from ..utils._param_validation import Interval\n from ..utils._seq_dataset import (\n     ArrayDataset32,\n     ArrayDataset64,\n@@ -472,6 +473,15 @@ class LinearRegression(MultiOutputMixin, RegressorMixin, LinearModel):\n     copy_X : bool, default=True\n         If True, X will be copied; else, it may be overwritten.\n \n+    tol : float, default=1e-4\n+        The precision of the solution (`coef_`) is determined by `tol` which\n+        specifies a different convergence criterion for the `lsqr` solver.\n+        `tol` is set as `atol` and `btol` of `scipy.sparse.linalg.lsqr` when\n+        fitting on sparse training data. This parameter has no effect when fitting\n+        on dense data.\n+\n+        .. versionadded:: 1.7\n+\n     n_jobs : int, default=None\n         The number of jobs to use for the computation. This will only provide\n         speedup in case of sufficiently large problems, that is if firstly\n@@ -555,6 +565,7 @@ class LinearRegression(MultiOutputMixin, RegressorMixin, LinearModel):\n         \"copy_X\": [\"boolean\"],\n         \"n_jobs\": [None, Integral],\n         \"positive\": [\"boolean\"],\n+        \"tol\": [Interval(Real, 0, None, closed=\"left\")],\n     }\n \n     def __init__(\n@@ -562,11 +573,13 @@ def __init__(\n         *,\n         fit_intercept=True,\n         copy_X=True,\n+        tol=1e-4,\n         n_jobs=None,\n         positive=False,\n     ):\n         self.fit_intercept = fit_intercept\n         self.copy_X = copy_X\n+        self.tol = tol\n         self.n_jobs = n_jobs\n         self.positive = positive\n \n@@ -668,11 +681,13 @@ def rmatvec(b):\n             )\n \n             if y.ndim < 2:\n-                self.coef_ = lsqr(X_centered, y)[0]\n+                self.coef_ = lsqr(X_centered, y, atol=self.tol, btol=self.tol)[0]\n             else:\n                 # sparse_lstsq cannot handle y with shape (M, K)\n                 outs = Parallel(n_jobs=n_jobs_)(\n-                    delayed(lsqr)(X_centered, y[:, j].ravel())\n+                    delayed(lsqr)(\n+                        X_centered, y[:, j].ravel(), atol=self.tol, btol=self.tol\n+                    )\n                     for j in range(y.shape[1])\n                 )\n                 self.coef_ = np.vstack([out[0] for out in outs])\ndiff --git a/sklearn/tests/test_pipeline.py b/sklearn/tests/test_pipeline.py\nindex d7a201f3abf6f..98f3ab21b9e16 100644\n--- a/sklearn/tests/test_pipeline.py\n+++ b/sklearn/tests/test_pipeline.py\n@@ -371,7 +371,7 @@ def test_pipeline_raise_set_params_error():\n     # expected error message for invalid inner parameter\n     error_msg = re.escape(\n         \"Invalid parameter 'invalid_param' for estimator LinearRegression(). Valid\"\n-        \" parameters are: ['copy_X', 'fit_intercept', 'n_jobs', 'positive'].\"\n+        \" parameters are: ['copy_X', 'fit_intercept', 'n_jobs', 'positive', 'tol'].\"\n     )\n     with pytest.raises(ValueError, match=error_msg):\n         pipe.set_params(cls__invalid_param=\"nope\")\ndiff --git a/sklearn/utils/_test_common/instance_generator.py b/sklearn/utils/_test_common/instance_generator.py\nindex bac401d8d657f..c46213b417090 100644\n--- a/sklearn/utils/_test_common/instance_generator.py\n+++ b/sklearn/utils/_test_common/instance_generator.py\n@@ -575,6 +575,7 @@\n             dict(positive=False),\n             dict(positive=True),\n         ],\n+        \"check_sample_weight_equivalence_on_sparse_data\": [dict(tol=1e-12)],\n     },\n     LocallyLinearEmbedding: {\"check_dict_unchanged\": dict(max_iter=5, n_components=1)},\n     LogisticRegression: {\n@@ -983,18 +984,6 @@ def _yield_instances_for_check(check, estimator_orig):\n     KNeighborsTransformer: {\n         \"check_methods_sample_order_invariance\": \"check is not applicable.\"\n     },\n-    LinearRegression: {\n-        # TODO: this model should converge to the minimum norm solution of the\n-        # least squares problem and as result be numerically stable enough when\n-        # running the equivalence check even if n_features > n_samples. Maybe\n-        # this is is not the case and a different choice of solver could fix\n-        # this problem. This might require setting a low enough value for the\n-        # tolerance of the lsqr solver:\n-        # https://github.com/scikit-learn/scikit-learn/issues/30131\n-        \"check_sample_weight_equivalence_on_sparse_data\": (\n-            \"sample_weight is not equivalent to removing/repeating samples.\"\n-        ),\n-    },\n     LinearSVC: {\n         # TODO: replace by a statistical test when _dual=True, see meta-issue #16298\n         \"check_sample_weight_equivalence_on_dense_data\": (\n",
  "fail_to_pass": [],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/linear_model/_base.py",
    "sklearn/tests/test_pipeline.py",
    "sklearn/utils/_test_common/instance_generator.py"
  ],
  "difficulty": "hard",
  "created_at": "2024-12-20T20:41:37Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/30521",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}