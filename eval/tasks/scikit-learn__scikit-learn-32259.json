{
  "id": "scikit-learn__scikit-learn-32259",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "ce7b3fe4223d04082e343e461c98e659adb5501c",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 32259,
  "pr_title": "Fix FEATURE_THRESHOLD initialization in trees",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.tree/32259.fix.rst b/doc/whats_new/upcoming_changes/sklearn.tree/32259.fix.rst\nnew file mode 100644\nindex 0000000000000..f25f0f2eec483\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.tree/32259.fix.rst\n@@ -0,0 +1,3 @@\n+- Fixed a regression in :ref:`decision trees <tree>` where almost constant features were\n+  not handled properly.\n+  By :user:`Sercan Turkmen <sercant>`.\ndiff --git a/sklearn/tree/_partitioner.pxd b/sklearn/tree/_partitioner.pxd\nindex fd41dec2e62c7..10373e7daffb5 100644\n--- a/sklearn/tree/_partitioner.pxd\n+++ b/sklearn/tree/_partitioner.pxd\n@@ -10,7 +10,7 @@ from ._splitter cimport SplitRecord\n \n \n # Mitigate precision differences between 32 bit and 64 bit\n-cdef float32_t FEATURE_THRESHOLD = 1e-7\n+cdef const float32_t FEATURE_THRESHOLD = 1e-7\n \n \n # We provide here the abstract interface for a Partitioner that would be\ndiff --git a/sklearn/tree/tests/test_tree.py b/sklearn/tree/tests/test_tree.py\nindex f0bf3babc2020..9db380941672d 100644\n--- a/sklearn/tree/tests/test_tree.py\n+++ b/sklearn/tree/tests/test_tree.py\n@@ -1258,6 +1258,27 @@ def test_only_constant_features():\n         assert est.tree_.max_depth == 0\n \n \n+@pytest.mark.parametrize(\"tree_cls\", ALL_TREES.values())\n+def test_almost_constant_feature(tree_cls):\n+    # Non regression test for\n+    # https://github.com/scikit-learn/scikit-learn/pull/32259\n+    # Make sure that almost constant features are discarded.\n+    random_state = check_random_state(0)\n+    X = random_state.rand(10, 2)\n+    # FEATURE_TRESHOLD=1e-7 is defined in sklearn/tree/_partitioner.pxd but not\n+    # accessible from Python\n+    feature_threshold = 1e-7\n+    X[:, 0] *= feature_threshold  # almost constant feature\n+    y = random_state.randint(0, 2, (10,))\n+\n+    est = tree_cls(random_state=0)\n+    est.fit(X, y)\n+    # the almost constant feature should not be used\n+    assert est.feature_importances_[0] == 0\n+    # other feature should be used\n+    assert est.feature_importances_[1] > 0\n+\n+\n def test_behaviour_constant_feature_after_splits():\n     X = np.transpose(\n         np.vstack(([[0, 0, 0, 0, 0, 1, 2, 4, 5, 6, 7]], np.zeros((4, 11))))\n",
  "fail_to_pass": [
    "test_almost_constant_feature"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/tree/tests/test_tree.py"
  ],
  "difficulty": "medium",
  "created_at": "2025-09-23T23:38:53Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32259",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}