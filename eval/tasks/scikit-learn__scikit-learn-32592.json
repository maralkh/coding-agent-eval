{
  "id": "scikit-learn__scikit-learn-32592",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "5a07bfc8422a47a53d125b01e46111a65e6c8ba9",
  "issue_number": 32589,
  "issue_title": "OneHotEncoder handle_unknown='warn' behaves like 'ignore' instead of 'infrequent_if_exist'",
  "issue_body": "### Describe the bug\n\nAccording to the [documentation](https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.OneHotEncoder.html), `handle_unknown='warn'` should behave like `handle_unknown='infrequent_if_exist'` (mapping unknown categories to the infrequent category) while emitting a warning.\n\nHowever, in practice, `handle_unknown='warn'` behaves like `handle_unknown='ignore'` (mapping unknown categories to all zeros).\n\nDocumentation states:\n> 'warn' : When an unknown category is encountered during transform a warning is issued, and the encoding then proceeds as described for handle_unknown=\"infrequent_if_exist\".\n\n### Steps/Code to Reproduce\n\n```python\nimport pandas as pd\nfrom sklearn.preprocessing import OneHotEncoder\n\n# Training data with infrequent category\ntrain_data = pd.DataFrame({\n    'building_type': ['restaurant']*3 + ['shop']*3 + ['snack']\n})\n\n# Test data with unknown category\ntest_data = pd.DataFrame({\n    'building_type': ['restaurant', 'snack', 'casino']  # casino is unknown\n})\n\n# Test with 'warn'\nencoder_warn = OneHotEncoder(\n    handle_unknown='warn',\n    sparse_output=False,\n    min_frequency=2,\n    drop='first'\n)\nencoder_warn.fit(train_data)\nresult_warn = encoder_warn.transform(test_data)\n\n# Test with 'infrequent_if_exist'\nencoder_infreq = OneHotEncoder(\n    handle_unknown='infrequent_if_exist',\n    sparse_output=False,\n    min_frequency=2,\n    drop='first'\n)\nencoder_infreq.fit(train_data)\nresult_infreq = encoder_infreq.transform(test_data)\n\nprint(\"Unknown category 'casino' with 'warn':\", result_warn[2])\nprint(\"Unknown category 'casino' with 'infrequent_if_exist':\", result_infreq[2])\n```\n\n### Expected Results\n\n```\nUnknown category 'casino' with 'warn': [0. 1.]\nUnknown category 'casino' with 'infrequent_if_exist': [0. 1.]\n\nBoth should map the unknown category to the infrequent category.\n```\n\n### Actual Results\n\n```\nUnknown category 'casino' with 'warn': [0. 0.]\nUnknown category 'casino' with 'infrequent_if_exist': [0. 1.]\n\n'warn' maps to all zeros (like 'ignore') instead of mapping to infrequent.\n```\n\n### Versions\n\n```shell\nSystem:\n    python: 3.13.3 (tags/v3.13.3:6280bb5, Apr  8 2025, 14:47:33) [MSC v.1943 64 bit (AMD64)]\nexecutable: c:\\Users\\abguv\\OneDrive\\Desktop\\Formation Data Engineer\\Projets\\Projet 6\\analyse\\.venv\\Scripts\\python.exe\n   machine: Windows-11-10.0.26200-SP0\n\nPython dependencies:\n      sklearn: 1.7.2\n          pip: 25.0.1\n   setuptools: 80.9.0\n        numpy: 2.3.3\n        scipy: 1.16.2\n       Cython: None\n       pandas: 2.3.3\n   matplotlib: 3.10.6\n       joblib: 1.5.2\nthreadpoolctl: 3.6.0\n\nBuilt with OpenMP: True\n\nthreadpoolctl info:\n       user_api: blas\n   internal_api: openblas\n    num_threads: 8\n         prefix: libscipy_openblas\n       filepath: C:\\Users\\abguv\\OneDrive\\Desktop\\Formation Data Engineer\\Projets\\Projet 6\\analyse\\.venv\\Lib\\site-packages\\numpy.libs\\libscipy_openblas64_-860d95b1c38e637ce4509f5fa24fbf2a.dll\n        version: 0.3.30\nthreading_layer: pthreads\n   architecture: SkylakeX\n\n       user_api: openmp\n   internal_api: openmp\n    num_threads: 8\n         prefix: vcomp\n       filepath: C:\\Users\\abguv\\OneDrive\\Desktop\\Formation Data Engineer\\Projets\\Projet 6\\analyse\\.venv\\Lib\\site-packages\\sklearn\\.libs\\vcomp140.dll\n        version: None\n\n       user_api: blas\n   internal_api: openblas\n    num_threads: 8\n         prefix: libscipy_openblas\n       filepath: C:\\Users\\abguv\\OneDrive\\Desktop\\Formation Data Engineer\\Projets\\Projet 6\\analyse\\.venv\\Lib\\site-packages\\scipy.libs\\libscipy_openblas-48c358d105077551cc9cc3ba79387ed5.dll\n        version: 0.3.29.dev\nthreading_layer: pthreads\n   architecture: SkylakeX\n```",
  "pr_number": 32592,
  "pr_title": "FIX preprocessing: Fix OneHotEncoder handle_unknown='warn' behavior",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.preprocessing/32592.fix.rst b/doc/whats_new/upcoming_changes/sklearn.preprocessing/32592.fix.rst\nnew file mode 100644\nindex 0000000000000..f22417a3566fb\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.preprocessing/32592.fix.rst\n@@ -0,0 +1,2 @@\n+- Fixed a bug in :class:`preprocessing.OneHotEncoder` where `handle_unknown='warn'` incorrectly behaved like `'ignore'` instead of `'infrequent_if_exist'`.\n+  By :user:`Nithurshen <nithurshen>`\ndiff --git a/sklearn/preprocessing/_encoders.py b/sklearn/preprocessing/_encoders.py\nindex ffff091be5b98..637f11a65f64a 100644\n--- a/sklearn/preprocessing/_encoders.py\n+++ b/sklearn/preprocessing/_encoders.py\n@@ -245,14 +245,20 @@ def _transform(\n             # already called above.\n             X_int[:, i] = _encode(Xi, uniques=self.categories_[i], check_unknown=False)\n         if columns_with_unknown:\n-            warnings.warn(\n-                (\n+            if handle_unknown == \"infrequent_if_exist\":\n+                msg = (\n+                    \"Found unknown categories in columns \"\n+                    f\"{columns_with_unknown} during transform. These \"\n+                    \"unknown categories will be encoded as the \"\n+                    \"infrequent category.\"\n+                )\n+            else:\n+                msg = (\n                     \"Found unknown categories in columns \"\n                     f\"{columns_with_unknown} during transform. These \"\n                     \"unknown categories will be encoded as all zeros\"\n-                ),\n-                UserWarning,\n-            )\n+                )\n+            warnings.warn(msg, UserWarning)\n \n         self._map_infrequent_categories(X_int, X_mask, ignore_category_indices)\n         return X_int, X_mask\n@@ -436,7 +442,7 @@ def _map_infrequent_categories(self, X_int, X_mask, ignore_category_indices):\n                 continue\n \n             X_int[~X_mask[:, col_idx], col_idx] = infrequent_idx[0]\n-            if self.handle_unknown == \"infrequent_if_exist\":\n+            if self.handle_unknown in (\"infrequent_if_exist\", \"warn\"):\n                 # All the unknown values are now mapped to the\n                 # infrequent_idx[0], which makes the unknown values valid\n                 # This is needed in `transform` when the encoding is formed\ndiff --git a/sklearn/preprocessing/tests/test_encoders.py b/sklearn/preprocessing/tests/test_encoders.py\nindex f843a4f16d170..9dbd9952bc017 100644\n--- a/sklearn/preprocessing/tests/test_encoders.py\n+++ b/sklearn/preprocessing/tests/test_encoders.py\n@@ -821,7 +821,8 @@ def test_ohe_handle_unknown_warn(drop):\n \n     warn_msg = (\n         r\"Found unknown categories in columns \\[0\\] during transform. \"\n-        r\"These unknown categories will be encoded as all zeros\"\n+        r\"These unknown categories will be encoded as the \"\n+        r\"infrequent category.\"\n     )\n     with pytest.warns(UserWarning, match=warn_msg):\n         X_trans = ohe.transform(X_test)\n@@ -1520,11 +1521,18 @@ def test_ohe_drop_first_handle_unknown_ignore_warns(handle_unknown):\n     X_test = [[\"c\", 3]]\n     X_expected = np.array([[0, 0, 0]])\n \n-    warn_msg = (\n-        r\"Found unknown categories in columns \\[0, 1\\] during \"\n-        \"transform. These unknown categories will be encoded as all \"\n-        \"zeros\"\n-    )\n+    if handle_unknown == \"ignore\":\n+        warn_msg = (\n+            r\"Found unknown categories in columns \\[0, 1\\] during \"\n+            r\"transform. These unknown categories will be encoded as all \"\n+            r\"zeros\"\n+        )\n+    else:\n+        warn_msg = (\n+            r\"Found unknown categories in columns \\[0, 1\\] during \"\n+            r\"transform. These unknown categories will be encoded as the \"\n+            r\"infrequent category.\"\n+        )\n     with pytest.warns(UserWarning, match=warn_msg):\n         X_trans = ohe.transform(X_test)\n     assert_allclose(X_trans, X_expected)\n@@ -1557,11 +1565,18 @@ def test_ohe_drop_if_binary_handle_unknown_ignore_warns(handle_unknown):\n     X_test = [[\"c\", 3]]\n     X_expected = np.array([[0, 0, 0, 0]])\n \n-    warn_msg = (\n-        r\"Found unknown categories in columns \\[0, 1\\] during \"\n-        \"transform. These unknown categories will be encoded as all \"\n-        \"zeros\"\n-    )\n+    if handle_unknown == \"ignore\":\n+        warn_msg = (\n+            r\"Found unknown categories in columns \\[0, 1\\] during \"\n+            r\"transform. These unknown categories will be encoded as all \"\n+            r\"zeros\"\n+        )\n+    else:\n+        warn_msg = (\n+            r\"Found unknown categories in columns \\[0, 1\\] during \"\n+            r\"transform. These unknown categories will be encoded as the \"\n+            r\"infrequent category.\"\n+        )\n     with pytest.warns(UserWarning, match=warn_msg):\n         X_trans = ohe.transform(X_test)\n     assert_allclose(X_trans, X_expected)\n@@ -1589,10 +1604,17 @@ def test_ohe_drop_first_explicit_categories(handle_unknown):\n     X_test = [[\"c\", 1]]\n     X_expected = np.array([[0, 0]])\n \n-    warn_msg = (\n-        r\"Found unknown categories in columns \\[0\\] during transform. \"\n-        r\"These unknown categories will be encoded as all zeros\"\n-    )\n+    if handle_unknown == \"ignore\":\n+        warn_msg = (\n+            r\"Found unknown categories in columns \\[0\\] during transform. \"\n+            r\"These unknown categories will be encoded as all zeros\"\n+        )\n+    else:\n+        warn_msg = (\n+            r\"Found unknown categories in columns \\[0\\] during transform. \"\n+            r\"These unknown categories will be encoded as the \"\n+            r\"infrequent category.\"\n+        )\n     with pytest.warns(UserWarning, match=warn_msg):\n         X_trans = ohe.transform(X_test)\n     assert_allclose(X_trans, X_expected)\n@@ -2365,3 +2387,36 @@ def test_encoder_not_fitted(Encoder):\n     encoder = Encoder(categories=[[\"A\", \"B\", \"C\"]])\n     with pytest.raises(NotFittedError):\n         encoder.transform(X)\n+\n+\n+def test_onehotencoder_handle_unknown_warn_maps_to_infrequent():\n+    \"\"\"\n+    Check handle_unknown='warn' behave like 'infrequent_if_exist' and map\n+    to the infrequent category.\n+    \"\"\"\n+\n+    train_data = train_data = np.array(\n+        [\"restaurant\"] * 3 + [\"shop\"] * 3 + [\"snack\"]\n+    ).reshape(-1, 1)\n+    test_data = np.array([\"restaurant\", \"snack\", \"casino\"]).reshape(-1, 1)\n+\n+    encoder_warn = OneHotEncoder(\n+        handle_unknown=\"warn\", sparse_output=False, min_frequency=2, drop=\"first\"\n+    )\n+    encoder_warn.fit(train_data)\n+\n+    encoder_infreq = OneHotEncoder(\n+        handle_unknown=\"infrequent_if_exist\",\n+        sparse_output=False,\n+        min_frequency=2,\n+        drop=\"first\",\n+    )\n+    encoder_infreq.fit(train_data)\n+    result_infreq = encoder_infreq.transform(test_data)\n+\n+    warning_match = \"unknown categories will be encoded as the infrequent category\"\n+\n+    with pytest.warns(UserWarning, match=warning_match):\n+        result_warn = encoder_warn.transform(test_data)\n+\n+    assert_allclose(result_warn[2], result_infreq[2])\n",
  "fail_to_pass": [
    "test_onehotencoder_handle_unknown_warn_maps_to_infrequent"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/preprocessing/_encoders.py",
    "sklearn/preprocessing/tests/test_encoders.py"
  ],
  "difficulty": "medium",
  "created_at": "2025-10-28T03:36:10Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32592",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/32589"
}