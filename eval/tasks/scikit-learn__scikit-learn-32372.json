{
  "id": "scikit-learn__scikit-learn-32372",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "8d4fc4a85cde93a0502909fdccec1b807d903a38",
  "issue_number": 30508,
  "issue_title": "ENH add `from_cv_results` in `PrecisionRecallDisplay` (single Display)",
  "issue_body": "#### Reference Issues/PRs\r\nFollows on from  #30399\r\n\r\n#### What does this implement/fix? Explain your changes.\r\nProof of concept of adding multi displays to `PrecisionRecallDisplay`\r\n\r\n* A lot of the code is similar to that in #30399, so we can definitely factorize out, though small intricacies may make it complex \r\n* The `plot` method is complex due to handling both single and multi curve and doing a lot more checking, as user is able to use it outside of the `from_estimator` and `from_predictions` methods.\r\n\r\nDetailed discussions of problems in review comments.\r\n\r\n#### Any other comments?\r\n\r\ncc @glemaitre @jeremiedbb \r\n\r\n",
  "pr_number": 32372,
  "pr_title": "FIX Infer `pos_label` in Display method `from_cv_results`",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.metrics/32372.fix.rst b/doc/whats_new/upcoming_changes/sklearn.metrics/32372.fix.rst\nnew file mode 100644\nindex 0000000000000..5fa8d2204b312\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.metrics/32372.fix.rst\n@@ -0,0 +1,4 @@\n+- :meth:`metrics.RocCurveDisplay.from_cv_results` will now infer `pos_label` as\n+  `estimator.classes_[-1]`, using the estimator from `cv_results`, when\n+  `pos_label=None`. Previously, an error was raised when `pos_label=None`.\n+  By :user:`Lucy Liu <lucyleeow>`.\ndiff --git a/sklearn/metrics/_plot/roc_curve.py b/sklearn/metrics/_plot/roc_curve.py\nindex f47d43b3b254f..22bf9758963e1 100644\n--- a/sklearn/metrics/_plot/roc_curve.py\n+++ b/sklearn/metrics/_plot/roc_curve.py\n@@ -665,8 +665,8 @@ def from_cv_results(\n \n         pos_label : int, float, bool or str, default=None\n             The class considered as the positive class when computing the ROC AUC\n-            metrics. By default, `estimators.classes_[1]` is considered\n-            as the positive class.\n+            metrics. By default, `estimator.classes_[1]` (using `estimator` from\n+            `cv_results`) is considered as the positive class.\n \n         ax : matplotlib axes, default=None\n             Axes object to plot on. If `None`, a new figure and axes is\n@@ -730,12 +730,11 @@ def from_cv_results(\n         <...>\n         >>> plt.show()\n         \"\"\"\n-        pos_label_ = cls._validate_from_cv_results_params(\n+        cls._validate_from_cv_results_params(\n             cv_results,\n             X,\n             y,\n             sample_weight=sample_weight,\n-            pos_label=pos_label,\n         )\n \n         fpr_folds, tpr_folds, auc_folds = [], [], []\n@@ -743,11 +742,11 @@ def from_cv_results(\n             cv_results[\"estimator\"], cv_results[\"indices\"][\"test\"]\n         ):\n             y_true = _safe_indexing(y, test_indices)\n-            y_pred, _ = _get_response_values_binary(\n+            y_pred, pos_label_ = _get_response_values_binary(\n                 estimator,\n                 _safe_indexing(X, test_indices),\n                 response_method=response_method,\n-                pos_label=pos_label_,\n+                pos_label=pos_label,\n             )\n             sample_weight_fold = (\n                 None\ndiff --git a/sklearn/metrics/_plot/tests/test_roc_curve_display.py b/sklearn/metrics/_plot/tests/test_roc_curve_display.py\nindex 22ed1eb4cd557..28bb7aa7ff566 100644\n--- a/sklearn/metrics/_plot/tests/test_roc_curve_display.py\n+++ b/sklearn/metrics/_plot/tests/test_roc_curve_display.py\n@@ -8,7 +8,7 @@\n from sklearn import clone\n from sklearn.compose import make_column_transformer\n from sklearn.datasets import load_breast_cancer, make_classification\n-from sklearn.exceptions import NotFittedError\n+from sklearn.exceptions import NotFittedError, UndefinedMetricWarning\n from sklearn.linear_model import LogisticRegression\n from sklearn.metrics import RocCurveDisplay, auc, roc_curve\n from sklearn.model_selection import cross_validate, train_test_split\n@@ -264,7 +264,7 @@ def test_roc_curve_from_cv_results_param_validation(pyplot, data_binary):\n \n     # `pos_label` inconsistency\n     y_multi[y_multi == 1] = 2\n-    with pytest.raises(ValueError, match=r\"y takes value in \\{0, 2\\}\"):\n+    with pytest.warns(UndefinedMetricWarning, match=\"No positive samples in y_true\"):\n         RocCurveDisplay.from_cv_results(cv_results, X, y_multi)\n \n     # `name` is list while `curve_kwargs` is None or dict\n@@ -588,6 +588,18 @@ def test_roc_curve_from_cv_results_curve_kwargs(pyplot, data_binary, curve_kwarg\n             assert color == curve_kwargs[idx][\"c\"]\n \n \n+def test_roc_curve_from_cv_results_pos_label_inferred(pyplot, data_binary):\n+    \"\"\"Check `pos_label` inferred correctly by `from_cv_results(pos_label=None)`.\"\"\"\n+    X, y = data_binary\n+    cv_results = cross_validate(\n+        LogisticRegression(), X, y, cv=3, return_estimator=True, return_indices=True\n+    )\n+\n+    disp = RocCurveDisplay.from_cv_results(cv_results, X, y, pos_label=None)\n+    # Should be `estimator.classes_[1]`\n+    assert disp.pos_label == 1\n+\n+\n def _check_chance_level(plot_chance_level, chance_level_kw, display):\n     \"\"\"Check chance level line and line styles correct.\"\"\"\n     import matplotlib as mpl\ndiff --git a/sklearn/utils/_plotting.py b/sklearn/utils/_plotting.py\nindex 537633d2454e8..304c772d5970a 100644\n--- a/sklearn/utils/_plotting.py\n+++ b/sklearn/utils/_plotting.py\n@@ -77,7 +77,6 @@ def _validate_from_cv_results_params(\n         y,\n         *,\n         sample_weight,\n-        pos_label,\n     ):\n         check_matplotlib_support(f\"{cls.__name__}.from_cv_results\")\n \n@@ -107,14 +106,6 @@ def _validate_from_cv_results_params(\n             )\n         check_consistent_length(X, y, sample_weight)\n \n-        try:\n-            pos_label = _check_pos_label_consistency(pos_label, y)\n-        except ValueError as e:\n-            # Adapt error message\n-            raise ValueError(str(e).replace(\"y_true\", \"y\"))\n-\n-        return pos_label\n-\n     @staticmethod\n     def _get_legend_label(curve_legend_metric, curve_name, legend_metric_name):\n         \"\"\"Helper to get legend label using `name` and `legend_metric`\"\"\"\ndiff --git a/sklearn/utils/tests/test_plotting.py b/sklearn/utils/tests/test_plotting.py\nindex db2f797ac2547..f74a0fdd523aa 100644\n--- a/sklearn/utils/tests/test_plotting.py\n+++ b/sklearn/utils/tests/test_plotting.py\n@@ -128,7 +128,6 @@ def test_validate_from_predictions_params_returns(pyplot, name, pos_label, y_tru\n                 \"X\": np.array([[1, 2], [3, 4]]),\n                 \"y\": np.array([0, 1]),\n                 \"sample_weight\": None,\n-                \"pos_label\": None,\n             },\n             \"`cv_results` does not contain one of the following\",\n         ),\n@@ -142,7 +141,6 @@ def test_validate_from_predictions_params_returns(pyplot, name, pos_label, y_tru\n                 \"X\": np.array([[1, 2]]),\n                 \"y\": np.array([0, 1]),\n                 \"sample_weight\": None,\n-                \"pos_label\": None,\n             },\n             \"`X` does not contain the correct number of\",\n         ),\n@@ -156,7 +154,6 @@ def test_validate_from_predictions_params_returns(pyplot, name, pos_label, y_tru\n                 # `y` not binary\n                 \"y\": np.array([0, 2, 1, 3]),\n                 \"sample_weight\": None,\n-                \"pos_label\": None,\n             },\n             \"The target `y` is not binary\",\n         ),\n@@ -170,24 +167,9 @@ def test_validate_from_predictions_params_returns(pyplot, name, pos_label, y_tru\n                 \"y\": np.array([0, 1, 0, 1]),\n                 # `sample_weight` wrong length\n                 \"sample_weight\": np.array([0.5]),\n-                \"pos_label\": None,\n             },\n             \"Found input variables with inconsistent\",\n         ),\n-        (\n-            {\n-                \"cv_results\": {\n-                    \"estimator\": \"dummy\",\n-                    \"indices\": {\"test\": [[1, 2], [1, 2]], \"train\": [[3, 4], [3, 4]]},\n-                },\n-                \"X\": np.array([1, 2, 3, 4]),\n-                \"y\": np.array([2, 3, 2, 3]),\n-                \"sample_weight\": None,\n-                # Not specified when `y` not in {0, 1} or {-1, 1}\n-                \"pos_label\": None,\n-            },\n-            \"y takes value in {2, 3} and pos_label is not specified\",\n-        ),\n     ],\n )\n def test_validate_from_cv_results_params(pyplot, params, err_msg):\n",
  "fail_to_pass": [
    "test_roc_curve_from_cv_results_pos_label_inferred"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/metrics/_plot/roc_curve.py",
    "sklearn/metrics/_plot/tests/test_roc_curve_display.py",
    "sklearn/utils/_plotting.py",
    "sklearn/utils/tests/test_plotting.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-10-04T11:28:01Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32372",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/30508"
}