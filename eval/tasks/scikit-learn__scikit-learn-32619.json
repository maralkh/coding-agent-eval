{
  "id": "scikit-learn__scikit-learn-32619",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "e40c216e73c34976ba664dcaca0d523df6ddd753",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 32619,
  "pr_title": "FEA Add array API support for `cohen_kappa_score`",
  "gold_patch": "diff --git a/doc/modules/array_api.rst b/doc/modules/array_api.rst\nindex ed6003fdd9b02..36cc79efa5793 100644\n--- a/doc/modules/array_api.rst\n+++ b/doc/modules/array_api.rst\n@@ -149,6 +149,7 @@ Metrics\n - :func:`sklearn.metrics.accuracy_score`\n - :func:`sklearn.metrics.balanced_accuracy_score`\n - :func:`sklearn.metrics.brier_score_loss`\n+- :func:`sklearn.metrics.cohen_kappa_score`\n - :func:`sklearn.metrics.confusion_matrix`\n - :func:`sklearn.metrics.d2_brier_score`\n - :func:`sklearn.metrics.d2_log_loss_score`\ndiff --git a/doc/whats_new/upcoming_changes/array-api/32619.feature.rst b/doc/whats_new/upcoming_changes/array-api/32619.feature.rst\nnew file mode 100644\nindex 0000000000000..ba3928cea8bce\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/array-api/32619.feature.rst\n@@ -0,0 +1,2 @@\n+- :func:`sklearn.metrics.cohen_kappa_score` now supports array API compatible inputs.\n+  By :user:`Omar Salman <OmarManzoor>`.\ndiff --git a/sklearn/metrics/_classification.py b/sklearn/metrics/_classification.py\nindex d1c1cd6af127f..caf3e1e5c5643 100644\n--- a/sklearn/metrics/_classification.py\n+++ b/sklearn/metrics/_classification.py\n@@ -33,6 +33,7 @@\n     _bincount,\n     _convert_to_numpy,\n     _count_nonzero,\n+    _fill_diagonal,\n     _find_matching_floating_dtype,\n     _is_numpy_namespace,\n     _is_xp_namespace,\n@@ -970,23 +971,30 @@ class labels [2]_.\n             raise ValueError(msg) from e\n         raise\n \n+    xp, _, device_ = get_namespace_and_device(y1, y2)\n     n_classes = confusion.shape[0]\n-    sum0 = np.sum(confusion, axis=0)\n-    sum1 = np.sum(confusion, axis=1)\n-    expected = np.outer(sum0, sum1) / np.sum(sum0)\n+    # array_api_strict only supports floating point dtypes for __truediv__\n+    # which is used below to compute `expected` as well as `k`. Therefore\n+    # we use the maximum floating point dtype available for relevant arrays\n+    # to avoid running into this problem.\n+    max_float_dtype = _max_precision_float_dtype(xp, device=device_)\n+    confusion = xp.astype(confusion, max_float_dtype, copy=False)\n+    sum0 = xp.sum(confusion, axis=0)\n+    sum1 = xp.sum(confusion, axis=1)\n+    expected = xp.linalg.outer(sum0, sum1) / xp.sum(sum0)\n \n     if weights is None:\n-        w_mat = np.ones([n_classes, n_classes], dtype=int)\n-        w_mat.flat[:: n_classes + 1] = 0\n+        w_mat = xp.ones([n_classes, n_classes], dtype=max_float_dtype, device=device_)\n+        _fill_diagonal(w_mat, 0, xp=xp)\n     else:  # \"linear\" or \"quadratic\"\n-        w_mat = np.zeros([n_classes, n_classes], dtype=int)\n-        w_mat += np.arange(n_classes)\n+        w_mat = xp.zeros([n_classes, n_classes], dtype=max_float_dtype, device=device_)\n+        w_mat += xp.arange(n_classes)\n         if weights == \"linear\":\n-            w_mat = np.abs(w_mat - w_mat.T)\n+            w_mat = xp.abs(w_mat - w_mat.T)\n         else:\n             w_mat = (w_mat - w_mat.T) ** 2\n \n-    k = np.sum(w_mat * confusion) / np.sum(w_mat * expected)\n+    k = xp.sum(w_mat * confusion) / xp.sum(w_mat * expected)\n     return float(1 - k)\n \n \ndiff --git a/sklearn/metrics/tests/test_common.py b/sklearn/metrics/tests/test_common.py\nindex 92f6a79dc5eb6..e3739223defb6 100644\n--- a/sklearn/metrics/tests/test_common.py\n+++ b/sklearn/metrics/tests/test_common.py\n@@ -2255,6 +2255,10 @@ def check_array_api_metric_pairwise(metric, array_namespace, device, dtype_name)\n         check_array_api_binary_classification_metric,\n         check_array_api_multiclass_classification_metric,\n     ],\n+    cohen_kappa_score: [\n+        check_array_api_binary_classification_metric,\n+        check_array_api_multiclass_classification_metric,\n+    ],\n     confusion_matrix: [\n         check_array_api_binary_classification_metric,\n         check_array_api_multiclass_classification_metric,\n",
  "fail_to_pass": [],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/metrics/_classification.py",
    "sklearn/metrics/tests/test_common.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-10-31T08:15:08Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32619",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}