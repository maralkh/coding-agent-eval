{
  "id": "scikit-learn__scikit-learn-32047",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "2e4e40babb3ab86d2ed2185bc0dba7fdba9414f1",
  "issue_number": 32036,
  "issue_title": "Classification metrics don't seem to support sparse?",
  "issue_body": "While working on #31829, I noticed that although most metrics in `_classification.py` say they support sparse in the docstring (and include \"sparse matrix\" in `validate_params`), when you actually try, you get an error.\n\nEssentially in `_check_targets`, we do:\n\nhttps://github.com/scikit-learn/scikit-learn/blob/726ed184ed80b0191732baaaf5825b86b41db4d2/sklearn/metrics/_classification.py#L128-L131\n\n`column_or_1d` then calls `check_array` with `accept_sparse` set to the default `False`.\n\n```python\nfrom sklearn.metrics import accuracy_score\nfrom scipy import sparse\nimport numpy as np\n\ny = [0, 2, 1, 3]\ny_sparse = sparse.csr_matrix(np.array(y).reshape(-1, 1))\n\naccuracy_score(y_sparse, y_sparse)\n```\n\nGives the following error:\n\n<details open>\n<summary>Error</summary>\n\n```\nTypeError                                 Traceback (most recent call last)\nCell In[11], line 1\n----> 1 accuracy_score(sparse_col, sparse_col)\n\nFile ~/Documents/dev/scikit-learn/sklearn/utils/_param_validation.py:218, in validate_params.<locals>.decorator.<locals>.wrapper(*args, **kwargs)\n    212 try:\n    213     with config_context(\n    214         skip_parameter_validation=(\n    215             prefer_skip_nested_validation or global_skip_validation\n    216         )\n    217     ):\n--> 218         return func(*args, **kwargs)\n    219 except InvalidParameterError as e:\n    220     # When the function is just a wrapper around an estimator, we allow\n    221     # the function to delegate validation to the estimator, but we replace\n    222     # the name of the estimator by the name of the function in the error\n    223     # message to avoid confusion.\n    224     msg = re.sub(\n    225         r\"parameter of \\w+ must be\",\n    226         f\"parameter of {func.__qualname__} must be\",\n    227         str(e),\n    228     )\n\nFile ~/Documents/dev/scikit-learn/sklearn/metrics/_classification.py:373, in accuracy_score(y_true, y_pred, normalize, sample_weight)\n    371 # Compute accuracy for each possible representation\n    372 y_true, y_pred = attach_unique(y_true, y_pred)\n--> 373 y_type, y_true, y_pred, sample_weight = _check_targets(\n    374     y_true, y_pred, sample_weight\n    375 )\n    377 if y_type.startswith(\"multilabel\"):\n    378     differing_labels = _count_nonzero(y_true - y_pred, xp=xp, device=device, axis=1)\n\nFile ~/Documents/dev/scikit-learn/sklearn/metrics/_classification.py:131, in _check_targets(y_true, y_pred, sample_weight)\n    129 if y_type in [\"binary\", \"multiclass\"]:\n    130     xp, _ = get_namespace(y_true, y_pred)\n--> 131     y_true = column_or_1d(y_true)\n    132     y_pred = column_or_1d(y_pred)\n    133     if y_type == \"binary\":\n\nFile ~/Documents/dev/scikit-learn/sklearn/utils/validation.py:1469, in column_or_1d(y, dtype, warn, device)\n   1431 \"\"\"Ravel column or 1d numpy array, else raises an error.\n   1432 \n   1433 Parameters\n   (...)\n   1466 array([1, 1])\n   1467 \"\"\"\n   1468 xp, _ = get_namespace(y)\n-> 1469 y = check_array(\n   1470     y,\n   1471     ensure_2d=False,\n   1472     dtype=dtype,\n   1473     input_name=\"y\",\n   1474     ensure_all_finite=False,\n   1475     ensure_min_samples=0,\n   1476 )\n   1478 shape = y.shape\n   1479 if len(shape) == 1:\n\nFile ~/Documents/dev/scikit-learn/sklearn/utils/validation.py:1027, in check_array(array, accept_sparse, accept_large_sparse, dtype, order, copy, force_writeable, force_all_finite, ensure_all_finite, ensure_non_negative, ensure_2d, allow_nd, ensure_min_samples, ensure_min_features, estimator, input_name)\n   1025 if sp.issparse(array):\n   1026     _ensure_no_complex_data(array)\n-> 1027     array = _ensure_sparse_format(\n   1028         array,\n   1029         accept_sparse=accept_sparse,\n   1030         dtype=dtype,\n   1031         copy=copy,\n   1032         ensure_all_finite=ensure_all_finite,\n   1033         accept_large_sparse=accept_large_sparse,\n   1034         estimator_name=estimator_name,\n   1035         input_name=input_name,\n   1036     )\n   1037     if ensure_2d and array.ndim < 2:\n   1038         raise ValueError(\n   1039             f\"Expected 2D input, got input with shape {array.shape}.\\n\"\n   1040             \"Reshape your data either using array.reshape(-1, 1) if \"\n   1041             \"your data has a single feature or array.reshape(1, -1) \"\n   1042             \"if it contains a single sample.\"\n   1043         )\n\nFile ~/Documents/dev/scikit-learn/sklearn/utils/validation.py:626, in _ensure_sparse_format(sparse_container, accept_sparse, dtype, copy, ensure_all_finite, accept_large_sparse, estimator_name, input_name)\n    624 if accept_sparse is False:\n    625     padded_input = \" for \" + input_name if input_name else \"\"\n--> 626     raise TypeError(\n    627         f\"Sparse data was passed{padded_input}, but dense data is required. \"\n    628         \"Use '.toarray()' to convert to a dense numpy array.\"\n    629     )\n    630 elif isinstance(accept_sparse, (list, tuple)):\n    631     if len(accept_sparse) == 0:\n\nTypeError: Sparse data was passed for y, but dense data is required. Use '.toarray()' to convert to a dense numpy array.\n```\n\n</details>\n\nI also could not find any sparse tests for classification. This seems so I feel like a big oversight so I feel like I have missed something??",
  "pr_number": 32047,
  "pr_title": "MNT Improve error message when binary/multiclass sparse input to classification metrics",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.metrics/32047.enhancement.rst b/doc/whats_new/upcoming_changes/sklearn.metrics/32047.enhancement.rst\nnew file mode 100644\nindex 0000000000000..7fcad9a062ce7\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.metrics/32047.enhancement.rst\n@@ -0,0 +1,9 @@\n+- Improved the error message for sparse inputs for the following metrics:\n+  :func:`metrics.accuracy_score`,\n+  :func:`metrics.multilabel_confusion_matrix`, :func:`metrics.jaccard_score`,\n+  :func:`metrics.zero_one_loss`, :func:`metrics.f1_score`,\n+  :func:`metrics.fbeta_score`, :func:`metrics.precision_recall_fscore_support`,\n+  :func:`metrics.class_likelihood_ratios`, :func:`metrics.precision_score`,\n+  :func:`metrics.recall_score`, :func:`metrics.classification_report`,\n+  :func:`metrics.hamming_loss`.\n+  By :user:`Lucy Liu <lucyleeow>`.\ndiff --git a/sklearn/metrics/_classification.py b/sklearn/metrics/_classification.py\nindex 4a9c2fe0aef3d..fb5fad066f881 100644\n--- a/sklearn/metrics/_classification.py\n+++ b/sklearn/metrics/_classification.py\n@@ -126,9 +126,18 @@ def _check_targets(y_true, y_pred, sample_weight=None):\n         raise ValueError(\"{0} is not supported\".format(y_type))\n \n     if y_type in [\"binary\", \"multiclass\"]:\n+        try:\n+            y_true = column_or_1d(y_true, input_name=\"y_true\")\n+            y_pred = column_or_1d(y_pred, input_name=\"y_pred\")\n+        except TypeError as e:\n+            if \"Sparse data was passed\" in str(e):\n+                raise TypeError(\n+                    \"Sparse input is only supported when targets are of multilabel type\"\n+                ) from e\n+            else:\n+                raise\n+\n         xp, _ = get_namespace(y_true, y_pred)\n-        y_true = column_or_1d(y_true)\n-        y_pred = column_or_1d(y_pred)\n         if y_type == \"binary\":\n             try:\n                 unique_values = _union1d(y_true, y_pred, xp)\n@@ -317,10 +326,12 @@ def accuracy_score(y_true, y_pred, *, normalize=True, sample_weight=None):\n     Parameters\n     ----------\n     y_true : 1d array-like, or label indicator array / sparse matrix\n-        Ground truth (correct) labels.\n+        Ground truth (correct) labels. Sparse matrix is only supported when\n+        labels are of :term:`multilabel` type.\n \n     y_pred : 1d array-like, or label indicator array / sparse matrix\n-        Predicted labels, as returned by a classifier.\n+        Predicted labels, as returned by a classifier. Sparse matrix is only\n+        supported when labels are of :term:`multilabel` type.\n \n     normalize : bool, default=True\n         If ``False``, return the number of correctly classified samples.\n@@ -623,11 +634,13 @@ def multilabel_confusion_matrix(\n     ----------\n     y_true : {array-like, sparse matrix} of shape (n_samples, n_outputs) or \\\n             (n_samples,)\n-        Ground truth (correct) target values.\n+        Ground truth (correct) target values. Sparse matrix is only supported when\n+        labels are of :term:`multilabel` type.\n \n     y_pred : {array-like, sparse matrix} of shape (n_samples, n_outputs) or \\\n             (n_samples,)\n-        Estimated targets as returned by a classifier.\n+        Estimated targets as returned by a classifier. Sparse matrix is only\n+        supported when labels are of :term:`multilabel` type.\n \n     sample_weight : array-like of shape (n_samples,), default=None\n         Sample weights.\n@@ -991,10 +1004,12 @@ def jaccard_score(\n     Parameters\n     ----------\n     y_true : 1d array-like, or label indicator array / sparse matrix\n-        Ground truth (correct) labels.\n+        Ground truth (correct) labels. Sparse matrix is only supported when\n+        labels are of :term:`multilabel` type.\n \n     y_pred : 1d array-like, or label indicator array / sparse matrix\n-        Predicted labels, as returned by a classifier.\n+        Predicted labels, as returned by a classifier. Sparse matrix is only\n+        supported when labels are of :term:`multilabel` type.\n \n     labels : array-like of shape (n_classes,), default=None\n         The set of labels to include when `average != 'binary'`, and their\n@@ -1262,10 +1277,12 @@ def zero_one_loss(y_true, y_pred, *, normalize=True, sample_weight=None):\n     Parameters\n     ----------\n     y_true : 1d array-like, or label indicator array / sparse matrix\n-        Ground truth (correct) labels.\n+        Ground truth (correct) labels. Sparse matrix is only supported when\n+        labels are of :term:`multilabel` type.\n \n     y_pred : 1d array-like, or label indicator array / sparse matrix\n-        Predicted labels, as returned by a classifier.\n+        Predicted labels, as returned by a classifier. Sparse matrix is only\n+        supported when labels are of :term:`multilabel` type.\n \n     normalize : bool, default=True\n         If ``False``, return the number of misclassifications.\n@@ -1386,10 +1403,12 @@ def f1_score(\n     Parameters\n     ----------\n     y_true : 1d array-like, or label indicator array / sparse matrix\n-        Ground truth (correct) target values.\n+        Ground truth (correct) target values. Sparse matrix is only supported when\n+        targets are of :term:`multilabel` type.\n \n     y_pred : 1d array-like, or label indicator array / sparse matrix\n-        Estimated targets as returned by a classifier.\n+        Estimated targets as returned by a classifier. Sparse matrix is only\n+        supported when targets are of :term:`multilabel` type.\n \n     labels : array-like, default=None\n         The set of labels to include when `average != 'binary'`, and their\n@@ -1586,10 +1605,12 @@ def fbeta_score(\n     Parameters\n     ----------\n     y_true : 1d array-like, or label indicator array / sparse matrix\n-        Ground truth (correct) target values.\n+        Ground truth (correct) target values. Sparse matrix is only supported when\n+        targets are of :term:`multilabel` type.\n \n     y_pred : 1d array-like, or label indicator array / sparse matrix\n-        Estimated targets as returned by a classifier.\n+        Estimated targets as returned by a classifier. Sparse matrix is only\n+        supported when targets are of :term:`multilabel` type.\n \n     beta : float\n         Determines the weight of recall in the combined score.\n@@ -1902,10 +1923,12 @@ def precision_recall_fscore_support(\n     Parameters\n     ----------\n     y_true : 1d array-like, or label indicator array / sparse matrix\n-        Ground truth (correct) target values.\n+        Ground truth (correct) target values. Sparse matrix is only supported when\n+        targets are of :term:`multilabel` type.\n \n     y_pred : 1d array-like, or label indicator array / sparse matrix\n-        Estimated targets as returned by a classifier.\n+        Estimated targets as returned by a classifier. Sparse matrix is only\n+        supported when targets are of :term:`multilabel` type.\n \n     beta : float, default=1.0\n         The strength of recall versus precision in the F-score.\n@@ -2176,10 +2199,12 @@ class after being classified as negative. This is the case when the\n     Parameters\n     ----------\n     y_true : 1d array-like, or label indicator array / sparse matrix\n-        Ground truth (correct) target values.\n+        Ground truth (correct) target values. Sparse matrix is only supported when\n+        targets are of :term:`multilabel` type.\n \n     y_pred : 1d array-like, or label indicator array / sparse matrix\n-        Estimated targets as returned by a classifier.\n+        Estimated targets as returned by a classifier. Sparse matrix is only\n+        supported when targets are of :term:`multilabel` type.\n \n     labels : array-like, default=None\n         List of labels to index the matrix. This may be used to select the\n@@ -2452,10 +2477,12 @@ def precision_score(\n     Parameters\n     ----------\n     y_true : 1d array-like, or label indicator array / sparse matrix\n-        Ground truth (correct) target values.\n+        Ground truth (correct) target values. Sparse matrix is only supported when\n+        targets are of :term:`multilabel` type.\n \n     y_pred : 1d array-like, or label indicator array / sparse matrix\n-        Estimated targets as returned by a classifier.\n+        Estimated targets as returned by a classifier. Sparse matrix is only\n+        supported when targets are of :term:`multilabel` type.\n \n     labels : array-like, default=None\n         The set of labels to include when `average != 'binary'`, and their\n@@ -2631,10 +2658,12 @@ def recall_score(\n     Parameters\n     ----------\n     y_true : 1d array-like, or label indicator array / sparse matrix\n-        Ground truth (correct) target values.\n+        Ground truth (correct) target values. Sparse matrix is only supported when\n+        targets are of :term:`multilabel` type.\n \n     y_pred : 1d array-like, or label indicator array / sparse matrix\n-        Estimated targets as returned by a classifier.\n+        Estimated targets as returned by a classifier. Sparse matrix is only\n+        supported when targets are of :term:`multilabel` type.\n \n     labels : array-like, default=None\n         The set of labels to include when `average != 'binary'`, and their\n@@ -2890,10 +2919,12 @@ def classification_report(\n     Parameters\n     ----------\n     y_true : 1d array-like, or label indicator array / sparse matrix\n-        Ground truth (correct) target values.\n+        Ground truth (correct) target values. Sparse matrix is only supported when\n+        targets are of :term:`multilabel` type.\n \n     y_pred : 1d array-like, or label indicator array / sparse matrix\n-        Estimated targets as returned by a classifier.\n+        Estimated targets as returned by a classifier. Sparse matrix is only\n+        supported when targets are of :term:`multilabel` type.\n \n     labels : array-like of shape (n_labels,), default=None\n         Optional list of label indices to include in the report.\n@@ -3116,10 +3147,12 @@ def hamming_loss(y_true, y_pred, *, sample_weight=None):\n     Parameters\n     ----------\n     y_true : 1d array-like, or label indicator array / sparse matrix\n-        Ground truth (correct) labels.\n+        Ground truth (correct) labels. Sparse matrix is only supported when\n+        targets are of :term:`multilabel` type.\n \n     y_pred : 1d array-like, or label indicator array / sparse matrix\n-        Predicted labels, as returned by a classifier.\n+        Predicted labels, as returned by a classifier. Sparse matrix is only\n+        supported when targets are of :term:`multilabel` type.\n \n     sample_weight : array-like of shape (n_samples,), default=None\n         Sample weights.\ndiff --git a/sklearn/metrics/tests/test_classification.py b/sklearn/metrics/tests/test_classification.py\nindex cdb64d9c1530a..ccae5b561445c 100644\n--- a/sklearn/metrics/tests/test_classification.py\n+++ b/sklearn/metrics/tests/test_classification.py\n@@ -5,7 +5,7 @@\n \n import numpy as np\n import pytest\n-from scipy import linalg\n+from scipy import linalg, sparse\n from scipy.spatial.distance import hamming as sp_hamming\n from scipy.stats import bernoulli\n \n@@ -2589,6 +2589,30 @@ def test__check_targets_multiclass_with_both_y_true_and_y_pred_binary():\n     assert _check_targets(y_true, y_pred)[0] == \"multiclass\"\n \n \n+@pytest.mark.parametrize(\n+    \"y, target_type\",\n+    [\n+        (sparse.csr_matrix([[1], [0], [1], [0]]), \"binary\"),\n+        (sparse.csr_matrix([[0], [1], [2], [1]]), \"multiclass\"),\n+        (sparse.csr_matrix([[1, 0, 1], [0, 1, 0], [1, 1, 0]]), \"multilabel\"),\n+    ],\n+)\n+def test__check_targets_sparse_inputs(y, target_type):\n+    \"\"\"Check correct behaviour when different target types are sparse.\"\"\"\n+    if target_type in (\"binary\", \"multiclass\"):\n+        with pytest.raises(\n+            TypeError, match=\"Sparse input is only supported when targets\"\n+        ):\n+            _check_targets(y, y)\n+    else:\n+        # This should not raise an error\n+        y_type, y_true_out, y_pred_out, _ = _check_targets(y, y)\n+\n+        assert y_type == \"multilabel-indicator\"\n+        assert y_true_out.format == \"csr\"\n+        assert y_pred_out.format == \"csr\"\n+\n+\n def test_hinge_loss_binary():\n     y_true = np.array([-1, 1, 1, -1])\n     pred_decision = np.array([-8.5, 0.5, 1.5, -0.3])\ndiff --git a/sklearn/utils/validation.py b/sklearn/utils/validation.py\nindex f1c3d11de13b2..03656582609f4 100644\n--- a/sklearn/utils/validation.py\n+++ b/sklearn/utils/validation.py\n@@ -1427,7 +1427,7 @@ def _check_y(y, multi_output=False, y_numeric=False, estimator=None):\n     return y\n \n \n-def column_or_1d(y, *, dtype=None, warn=False, device=None):\n+def column_or_1d(y, *, dtype=None, input_name=\"y\", warn=False, device=None):\n     \"\"\"Ravel column or 1d numpy array, else raises an error.\n \n     Parameters\n@@ -1440,6 +1440,11 @@ def column_or_1d(y, *, dtype=None, warn=False, device=None):\n \n         .. versionadded:: 1.2\n \n+    input_name : str, default=\"y\"\n+        The data name used to construct the error message.\n+\n+        .. versionadded:: 1.8\n+\n     warn : bool, default=False\n        To control display of warnings.\n \n@@ -1470,7 +1475,7 @@ def column_or_1d(y, *, dtype=None, warn=False, device=None):\n         y,\n         ensure_2d=False,\n         dtype=dtype,\n-        input_name=\"y\",\n+        input_name=input_name,\n         ensure_all_finite=False,\n         ensure_min_samples=0,\n     )\n",
  "fail_to_pass": [
    "test__check_targets_sparse_inputs"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/metrics/_classification.py",
    "sklearn/metrics/tests/test_classification.py",
    "sklearn/utils/validation.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-08-29T11:54:51Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32047",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/32036"
}