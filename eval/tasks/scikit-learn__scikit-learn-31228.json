{
  "id": "scikit-learn__scikit-learn-31228",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "0173b916739dc17fe522ab64c691682a30d1d17b",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 31228,
  "pr_title": "Division by zero in OneVsRest's `predict_proba` (see #31224); bugfix for `test_ovo_decision_function`",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.multiclass/31228.fix.rst b/doc/whats_new/upcoming_changes/sklearn.multiclass/31228.fix.rst\nnew file mode 100644\nindex 0000000000000..68056db580fd7\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.multiclass/31228.fix.rst\n@@ -0,0 +1,5 @@\n+- The `predict_proba` method of :class:`sklearn.multiclass.OneVsRestClassifier` now\n+  returns zero for all classes when all inner estimators never predict their positive\n+  class.\n+  By :user:`Luis M. B. Varona <Luis-Varona>`, :user:`Marc Bresson <MarcBresson>`, and\n+  :user:`J\u00e9r\u00e9mie du Boisberranger <jeremiedbb>`.\ndiff --git a/sklearn/multiclass.py b/sklearn/multiclass.py\nindex fa86201fb1d89..d4208e0f542c7 100644\n--- a/sklearn/multiclass.py\n+++ b/sklearn/multiclass.py\n@@ -553,8 +553,10 @@ def predict_proba(self, X):\n             Y = np.concatenate(((1 - Y), Y), axis=1)\n \n         if not self.multilabel_:\n-            # Then, probabilities should be normalized to 1.\n-            Y /= np.sum(Y, axis=1)[:, np.newaxis]\n+            # Then, (nonzero) sample probability distributions should be normalized.\n+            row_sums = np.sum(Y, axis=1)[:, np.newaxis]\n+            np.divide(Y, row_sums, out=Y, where=row_sums != 0)\n+\n         return Y\n \n     @available_if(_estimators_has(\"decision_function\"))\ndiff --git a/sklearn/tests/test_multiclass.py b/sklearn/tests/test_multiclass.py\nindex 566b8f535c9cb..ae718436617e1 100644\n--- a/sklearn/tests/test_multiclass.py\n+++ b/sklearn/tests/test_multiclass.py\n@@ -6,6 +6,7 @@\n from numpy.testing import assert_allclose\n \n from sklearn import datasets, svm\n+from sklearn.base import BaseEstimator, ClassifierMixin\n from sklearn.datasets import load_breast_cancer\n from sklearn.exceptions import NotFittedError\n from sklearn.impute import SimpleImputer\n@@ -429,6 +430,31 @@ def test_ovr_single_label_predict_proba():\n     assert not (pred - Y_pred).any()\n \n \n+def test_ovr_single_label_predict_proba_zero():\n+    \"\"\"Check that predic_proba returns all zeros when the base estimator\n+    never predicts the positive class.\n+    \"\"\"\n+\n+    class NaiveBinaryClassifier(BaseEstimator, ClassifierMixin):\n+        def fit(self, X, y):\n+            self.classes_ = np.unique(y)\n+            return self\n+\n+        def predict_proba(self, X):\n+            proba = np.ones((len(X), 2))\n+            # Probability of being the positive class is always 0\n+            proba[:, 1] = 0\n+            return proba\n+\n+    base_clf = NaiveBinaryClassifier()\n+    X, y = iris.data, iris.target  # Three-class problem with 150 samples\n+\n+    clf = OneVsRestClassifier(base_clf).fit(X, y)\n+    y_proba = clf.predict_proba(X)\n+\n+    assert_allclose(y_proba, 0.0)\n+\n+\n def test_ovr_multilabel_decision_function():\n     X, Y = datasets.make_multilabel_classification(\n         n_samples=100,\n",
  "fail_to_pass": [
    "test_ovr_single_label_predict_proba_zero"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/multiclass.py",
    "sklearn/tests/test_multiclass.py"
  ],
  "difficulty": "medium",
  "created_at": "2025-04-20T01:29:00Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/31228",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}