{
  "id": "scikit-learn__scikit-learn-30516",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "72b35a46684c0ecf4182500d3320836607d1f17c",
  "issue_number": 30479,
  "issue_title": "Version 1.6.X: ClassifierMixIn failing with new __sklearn_tags__ function",
  "issue_body": "### Describe the bug\r\n\r\nHi,\r\n\r\nwe are using Sklearn in our projects for different classification training methods on production level. In the dev stage we upgraded to the latest release and our Training failed due to changes in the ClassifierMixIn Class. We use it in combination with a sklearn Pipeline.\r\n\r\nin 1.6.X the following function was introduced:\r\n\r\n```\r\n    def __sklearn_tags__(self):\r\n        tags = super().__sklearn_tags__()\r\n        tags.estimator_type = \"classifier\"\r\n        tags.classifier_tags = ClassifierTags()\r\n        tags.target_tags.required = True\r\n        return tags\r\n```\r\n\r\nIt is calling the sklearn_tags methods from it's parent class. But the ClassifierMixIn doesn't have a parent class. So it says function super().__sklearn_tags__() is not existing.\r\n\r\n\r\n### Steps/Code to Reproduce\r\n\r\n```python\r\nfrom sklearn.base import ClassifierMixin,\r\nfrom sklearn.pipeline import Pipeline\r\nimport numpy as np\r\n\r\nclass MyEstimator(ClassifierMixin):\r\n    def __init__(self, *, param=1):\r\n        self.param = param\r\n    def fit(self, X, y=None):\r\n        self.is_fitted_ = True\r\n        return self\r\n    def predict(self, X):\r\n        return np.full(shape=X.shape[0], fill_value=self.param)\r\n\r\nX = np.array([[1, 2], [2, 3], [3, 4]])\r\ny = np.array([1, 0, 1])\r\n\r\n\r\nmy_pipeline = Pipeline([(\"estimator\", MyEstimator(param=1))])\r\nmy_pipeline.fit(X, y)\r\nmy_pipeline.predict(X)\r\n```\r\n\r\n### Expected Results\r\n\r\nA Prediction is returned.\r\n\r\n### Actual Results\r\n\r\n```shell\r\nTraceback (most recent call last):\r\n  File \"c:\\Users\\xxxx\\error_sklearn\\redo_error.py\", line 22, in <module>\r\n    my_pipeline.predict(X)\r\n  File \"C:\\Users\\xxxx\\error_sklearn\\.venv\\Lib\\site-packages\\sklearn\\pipeline.py\", line 780, in predict\r\n    with _raise_or_warn_if_not_fitted(self):\r\n  File \"C:\\Program Files\\Wpy64-31230\\python-3.12.3.amd64\\Lib\\contextlib.py\", line 144, in __exit__\r\n    next(self.gen)\r\n  File \"C:\\Users\\xxxx\\error_sklearn\\.venv\\Lib\\site-packages\\sklearn\\pipeline.py\", line 60, in _raise_or_warn_if_not_fitted\r\n    check_is_fitted(estimator)\r\n  File \"C:\\Users\\xxxx\\git_projects\\error_sklearn\\.venv\\Lib\\site-packages\\sklearn\\utils\\validation.py\", line 1756, in check_is_fitted\r\n    if not _is_fitted(estimator, attributes, all_or_any):\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"C:\\Users\\xxxx\\error_sklearn\\.venv\\Lib\\site-packages\\sklearn\\utils\\validation.py\", line 1665, in _is_fitted\r\n    return estimator.__sklearn_is_fitted__()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"C:\\Users\\xxxx\\error_sklearn\\.venv\\Lib\\site-packages\\sklearn\\pipeline.py\", line 1310, in __sklearn_is_fitted__\r\n    check_is_fitted(last_step)\r\n  File \"C:\\Users\\xxxx\\error_sklearn\\.venv\\Lib\\site-packages\\sklearn\\utils\\validation.py\", line 1751, in check_is_fitted\r\n    tags = get_tags(estimator)\r\n           ^^^^^^^^^^^^^^^^^^^\r\n  File \"C:\\Users\\xxxx\\error_sklearn\\.venv\\Lib\\site-packages\\sklearn\\utils\\_tags.py\", line 396, in get_tags\r\n    tags = estimator.__sklearn_tags__()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"C:\\Users\\xxxx\\error_sklearn\\.venv\\Lib\\site-packages\\sklearn\\base.py\", line 540, in __sklearn_tags__\r\n    tags = super().__sklearn_tags__()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'super' object has no attribute '__sklearn_tags__'\r\n```\r\n### Versions\r\n\r\n```shell\r\n1.6.0 / 1.6.X\r\n```\r\n",
  "pr_number": 30516,
  "pr_title": "FIX warn if an estimator does have a concrete __sklearn_tags__ implementation",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.utils/30516.fix.rst b/doc/whats_new/upcoming_changes/sklearn.utils/30516.fix.rst\nnew file mode 100644\nindex 0000000000000..6e008f3beeb3c\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.utils/30516.fix.rst\n@@ -0,0 +1,4 @@\n+- Raise a `DeprecationWarning` when there is no concrete implementation of `__sklearn_tags__`\n+  in the MRO of the estimator. We request to inherit from `BaseEstimator` that\n+  implements `__sklearn_tags__`.\n+  By :user:`Guillaume Lemaitre <glemaitre>`\n\\ No newline at end of file\ndiff --git a/sklearn/utils/_tags.py b/sklearn/utils/_tags.py\nindex d4f211eb52152..408058ca15096 100644\n--- a/sklearn/utils/_tags.py\n+++ b/sklearn/utils/_tags.py\n@@ -393,7 +393,32 @@ def get_tags(estimator) -> Tags:\n     tag_provider = _find_tags_provider(estimator)\n \n     if tag_provider == \"__sklearn_tags__\":\n-        tags = estimator.__sklearn_tags__()\n+        # TODO(1.7): turn the warning into an error\n+        try:\n+            tags = estimator.__sklearn_tags__()\n+        except AttributeError as exc:\n+            if str(exc) == \"'super' object has no attribute '__sklearn_tags__'\":\n+                # workaround the regression reported in\n+                # https://github.com/scikit-learn/scikit-learn/issues/30479\n+                # `__sklearn_tags__` is implemented by calling\n+                # `super().__sklearn_tags__()` but there is no `__sklearn_tags__`\n+                # method in the base class.\n+                warnings.warn(\n+                    f\"The following error was raised: {str(exc)}. It seems that \"\n+                    \"there are no classes that implement `__sklearn_tags__` \"\n+                    \"in the MRO and/or all classes in the MRO call \"\n+                    \"`super().__sklearn_tags__()`. Make sure to inherit from \"\n+                    \"`BaseEstimator` which implements `__sklearn_tags__` (or \"\n+                    \"alternatively define `__sklearn_tags__` but we don't recommend \"\n+                    \"this approach). Note that `BaseEstimator` needs to be on the \"\n+                    \"right side of other Mixins in the inheritance order. The \"\n+                    \"default are now used instead since retrieving tags failed. \"\n+                    \"This warning will be replaced by an error in 1.7.\",\n+                    category=DeprecationWarning,\n+                )\n+                tags = default_tags(estimator)\n+            else:\n+                raise\n     else:\n         # TODO(1.7): Remove this branch of the code\n         # Let's go through the MRO and patch each class implementing _more_tags\ndiff --git a/sklearn/utils/tests/test_tags.py b/sklearn/utils/tests/test_tags.py\nindex 2ff6878d974fb..0a28d2dda7cf7 100644\n--- a/sklearn/utils/tests/test_tags.py\n+++ b/sklearn/utils/tests/test_tags.py\n@@ -1,12 +1,15 @@\n from dataclasses import dataclass, fields\n \n+import numpy as np\n import pytest\n \n from sklearn.base import (\n     BaseEstimator,\n+    ClassifierMixin,\n     RegressorMixin,\n     TransformerMixin,\n )\n+from sklearn.pipeline import Pipeline\n from sklearn.utils import (\n     ClassifierTags,\n     InputTags,\n@@ -629,3 +632,48 @@ def __sklearn_tags__(self):\n     }\n     assert old_tags == expected_tags\n     assert _to_new_tags(_to_old_tags(new_tags), estimator=estimator) == new_tags\n+\n+\n+# TODO(1.7): Remove this test\n+def test_tags_no_sklearn_tags_concrete_implementation():\n+    \"\"\"Non-regression test for:\n+    https://github.com/scikit-learn/scikit-learn/issues/30479\n+\n+    There is no class implementing `__sklearn_tags__` without calling\n+    `super().__sklearn_tags__()`. Thus, we raise a warning and request to inherit from\n+    `BaseEstimator` that implements `__sklearn_tags__`.\n+    \"\"\"\n+\n+    class MyEstimator(ClassifierMixin):\n+        def __init__(self, *, param=1):\n+            self.param = param\n+\n+        def fit(self, X, y=None):\n+            self.is_fitted_ = True\n+            return self\n+\n+        def predict(self, X):\n+            return np.full(shape=X.shape[0], fill_value=self.param)\n+\n+    X = np.array([[1, 2], [2, 3], [3, 4]])\n+    y = np.array([1, 0, 1])\n+\n+    my_pipeline = Pipeline([(\"estimator\", MyEstimator(param=1))])\n+    with pytest.warns(DeprecationWarning, match=\"The following error was raised\"):\n+        my_pipeline.fit(X, y).predict(X)\n+\n+    # check that we still raise an error if it is not a AttributeError or related to\n+    # __sklearn_tags__\n+    class MyEstimator2(MyEstimator, BaseEstimator):\n+        def __init__(self, *, param=1, error_type=AttributeError):\n+            self.param = param\n+            self.error_type = error_type\n+\n+        def __sklearn_tags__(self):\n+            super().__sklearn_tags__()\n+            raise self.error_type(\"test\")\n+\n+    for error_type in (AttributeError, TypeError, ValueError):\n+        estimator = MyEstimator2(param=1, error_type=error_type)\n+        with pytest.raises(error_type):\n+            get_tags(estimator)\n",
  "fail_to_pass": [
    "test_tags_no_sklearn_tags_concrete_implementation"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/utils/_tags.py",
    "sklearn/utils/tests/test_tags.py"
  ],
  "difficulty": "medium",
  "created_at": "2024-12-20T18:25:08Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/30516",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/30479"
}