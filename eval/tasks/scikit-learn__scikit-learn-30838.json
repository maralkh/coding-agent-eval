{
  "id": "scikit-learn__scikit-learn-30838",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "774316c968f53b30e0a918b87ad78ce84fb40c69",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 30838,
  "pr_title": "ENH: Add Array API support to hamming_loss",
  "gold_patch": "diff --git a/doc/modules/array_api.rst b/doc/modules/array_api.rst\nindex b50815e1f7fb3..b1d1272e3b173 100644\n--- a/doc/modules/array_api.rst\n+++ b/doc/modules/array_api.rst\n@@ -136,6 +136,7 @@ Metrics\n - :func:`sklearn.metrics.explained_variance_score`\n - :func:`sklearn.metrics.f1_score`\n - :func:`sklearn.metrics.fbeta_score`\n+- :func:`sklearn.metrics.hamming_loss`\n - :func:`sklearn.metrics.max_error`\n - :func:`sklearn.metrics.mean_absolute_error`\n - :func:`sklearn.metrics.mean_absolute_percentage_error`\ndiff --git a/doc/whats_new/upcoming_changes/array-api/30838.feature.rst b/doc/whats_new/upcoming_changes/array-api/30838.feature.rst\nnew file mode 100644\nindex 0000000000000..f733f1c6476a6\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/array-api/30838.feature.rst\n@@ -0,0 +1,2 @@\n+- :func:`sklearn.metrics.hamming_loss` now support Array API compatible inputs.\n+  By :user:`Thomas Li <lithomas1>`\ndiff --git a/sklearn/metrics/_classification.py b/sklearn/metrics/_classification.py\nindex 2a08a1893766e..0fefbd529ee40 100644\n--- a/sklearn/metrics/_classification.py\n+++ b/sklearn/metrics/_classification.py\n@@ -51,7 +51,6 @@\n from ..utils._unique import attach_unique\n from ..utils.extmath import _nanaverage\n from ..utils.multiclass import type_of_target, unique_labels\n-from ..utils.sparsefuncs import count_nonzero\n from ..utils.validation import (\n     _check_pos_label_consistency,\n     _check_sample_weight,\n@@ -229,12 +228,7 @@ def accuracy_score(y_true, y_pred, *, normalize=True, sample_weight=None):\n     check_consistent_length(y_true, y_pred, sample_weight)\n \n     if y_type.startswith(\"multilabel\"):\n-        if _is_numpy_namespace(xp):\n-            differing_labels = count_nonzero(y_true - y_pred, axis=1)\n-        else:\n-            differing_labels = _count_nonzero(\n-                y_true - y_pred, xp=xp, device=device, axis=1\n-            )\n+        differing_labels = _count_nonzero(y_true - y_pred, xp=xp, device=device, axis=1)\n         score = xp.asarray(differing_labels == 0, device=device)\n     else:\n         score = y_true == y_pred\n@@ -2997,15 +2991,20 @@ def hamming_loss(y_true, y_pred, *, sample_weight=None):\n     y_type, y_true, y_pred = _check_targets(y_true, y_pred)\n     check_consistent_length(y_true, y_pred, sample_weight)\n \n+    xp, _, device = get_namespace_and_device(y_true, y_pred, sample_weight)\n+\n     if sample_weight is None:\n         weight_average = 1.0\n     else:\n-        weight_average = np.mean(sample_weight)\n+        sample_weight = xp.asarray(sample_weight, device=device)\n+        weight_average = _average(sample_weight, xp=xp)\n \n     if y_type.startswith(\"multilabel\"):\n-        n_differences = count_nonzero(y_true - y_pred, sample_weight=sample_weight)\n-        return float(\n-            n_differences / (y_true.shape[0] * y_true.shape[1] * weight_average)\n+        n_differences = _count_nonzero(\n+            y_true - y_pred, xp=xp, device=device, sample_weight=sample_weight\n+        )\n+        return float(n_differences) / (\n+            y_true.shape[0] * y_true.shape[1] * weight_average\n         )\n \n     elif y_type in [\"binary\", \"multiclass\"]:\ndiff --git a/sklearn/metrics/tests/test_common.py b/sklearn/metrics/tests/test_common.py\nindex 406309d4fcf9e..6e6950b1d2eff 100644\n--- a/sklearn/metrics/tests/test_common.py\n+++ b/sklearn/metrics/tests/test_common.py\n@@ -2139,6 +2139,11 @@ def check_array_api_metric_pairwise(metric, array_namespace, device, dtype_name)\n         check_array_api_multiclass_classification_metric,\n         check_array_api_multilabel_classification_metric,\n     ],\n+    hamming_loss: [\n+        check_array_api_binary_classification_metric,\n+        check_array_api_multiclass_classification_metric,\n+        check_array_api_multilabel_classification_metric,\n+    ],\n     mean_tweedie_deviance: [check_array_api_regression_metric],\n     partial(mean_tweedie_deviance, power=-0.5): [check_array_api_regression_metric],\n     partial(mean_tweedie_deviance, power=1.5): [check_array_api_regression_metric],\n",
  "fail_to_pass": [],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/metrics/_classification.py",
    "sklearn/metrics/tests/test_common.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-02-15T16:31:06Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/30838",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}