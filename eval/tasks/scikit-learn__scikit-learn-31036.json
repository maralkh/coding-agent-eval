{
  "id": "scikit-learn__scikit-learn-31036",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "293e5b86fed3f4257e7bb83db8dc2488208411c2",
  "issue_number": 30834,
  "issue_title": "Bug: AttributeError in `str_escape` when handling `numpy.int64` in `sklearn.tree._export.py` in `/sklearn/tree/_export.py`",
  "issue_body": "### Describe the bug\n\n\nWhen exporting a decision tree using `sklearn.tree.export_text()` (or other related functions), an AttributeError occurs if a `numpy.int64` value is passed to `_export.py` instead of a string.\n\n```\n  File \"venv/lib/python3.10/site-packages/sklearn/tree/_export.py\", line 311, in node_to_str\n    feature = self.str_escape(feature)\n  File \"venv/lib/python3.10/site-packages/sklearn/tree/_export.py\", line 581, in str_escape\n    return string.replace('\"', r\"\\\"\")\nAttributeError: 'numpy.int64' object has no attribute 'replace'\n```\nCauses:\nThe function `str_escape(feature)` expects a string but receives a `numpy.int64` value.\n`numpy.int64` does not have a .replace() method, causing an AttributeError. \n\n## Possible Fix:\nConvert feature to a string before passing it to `str_escape()` in `_export.py`.\nModify line 581 in `_export.py`:\n\nBefore (causing error):\n```\nreturn string.replace('\"', r\"\\\"\")\n```\n## After (fixing error):\n\n```\nreturn str(string).replace('\"', r\"\\\"\")\n```\nThis ensures that `feature` is always a string before calling `.replace()`.\n\n\n\n### Steps/Code to Reproduce\n\nThis piece of code triggers the error:\n\n```\nimport numpy as np\nfrom sklearn.tree import DecisionTreeClassifier, export_graphviz\n\nX = np.array([[0, 1], [1, 0], [1, 1], [0, 0]])\ny = np.array([0, 1, 1, 0])\n\nclf = DecisionTreeClassifier().fit(X, y)\n\nfeature_names = np.array([10, 20], dtype=np.int64)  # numpy.int64 feature names\n\n# Debugging prints\nprint(\"Feature Names:\", feature_names)\nprint(\"Feature Name Types:\", [type(name) for name in feature_names])\n\n# Attempt to trigger the error\nexport_graphviz(clf, out_file=None, feature_names=feature_names)\n```\n\n### Expected Results\n\nA graph in PNG format. \n\n### Actual Results\n\n\n```\nAttributeError: 'numpy.int64' object has no attribute 'replace'\n```\n\n### Versions\n\n```shell\nSystem:\n    python: 3.10.12 (main, Jan 17 2025, 14:35:34) [GCC 11.4.0]\nexecutable: /usr/bin/python3\n   machine: Linux-6.8.0-52-generic-x86_64-with-glibc2.35\n\nPython dependencies:\n      sklearn: 1.6.1\n          pip: 22.0.2\n   setuptools: 59.6.0\n        numpy: 2.2.3\n        scipy: 1.15.1\n       Cython: 3.0.11\n       pandas: None\n   matplotlib: 3.5.1\n       joblib: 1.4.2\nthreadpoolctl: 3.5.0\n\nBuilt with OpenMP: True\n\nthreadpoolctl info:\n       user_api: blas\n   internal_api: openblas\n    num_threads: 8\n         prefix: libscipy_openblas\n       filepath: lib/python3.10/site-packages/numpy.libs/libscipy_openblas64_-6bb31eeb.so\n        version: 0.3.28\nthreading_layer: pthreads\n   architecture: SkylakeX\n\n       user_api: blas\n   internal_api: openblas\n    num_threads: 8\n         prefix: libscipy_openblas\n       filepath: lib/python3.10/site-packages/scipy.libs/libscipy_openblas-68440149.so\n        version: 0.3.28\nthreading_layer: pthreads\n   architecture: SkylakeX\n\n       user_api: openmp\n   internal_api: openmp\n    num_threads: 8\n         prefix: libgomp\n       filepath: lib/python3.10/site-packages/scikit_learn.libs/libgomp-a34b3233.so.1.0.0\n        version: None\n```",
  "pr_number": 31036,
  "pr_title": "Fix: AttributeError in str_escape when handling numpy.int64 in sklearn.tree._export.py in /sklearn/tree/_export.py",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.tree/31036.fix.rst b/doc/whats_new/upcoming_changes/sklearn.tree/31036.fix.rst\nnew file mode 100644\nindex 0000000000000..32e26e180595d\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.tree/31036.fix.rst\n@@ -0,0 +1,3 @@\n+- :func:`~sklearn.tree.export_graphviz` now raises a `ValueError` if given feature\n+  names are not all strings.\n+  By :user:`Guilherme Peixoto <guilhermecsnpeixoto>`\ndiff --git a/sklearn/tree/_export.py b/sklearn/tree/_export.py\nindex feffe358a9837..fef12fd194879 100644\n--- a/sklearn/tree/_export.py\n+++ b/sklearn/tree/_export.py\n@@ -908,6 +908,8 @@ def export_graphviz(\n     'digraph Tree {...\n     \"\"\"\n     if feature_names is not None:\n+        if any((not isinstance(name, str) for name in feature_names)):\n+            raise ValueError(\"All feature names must be strings.\")\n         feature_names = check_array(\n             feature_names, ensure_2d=False, dtype=None, ensure_min_samples=0\n         )\ndiff --git a/sklearn/tree/tests/test_export.py b/sklearn/tree/tests/test_export.py\nindex d05e657072b17..ed1f171c7b7bf 100644\n--- a/sklearn/tree/tests/test_export.py\n+++ b/sklearn/tree/tests/test_export.py\n@@ -373,6 +373,11 @@ def test_graphviz_errors():\n     with pytest.raises(ValueError, match=message):\n         export_graphviz(clf, None, feature_names=[\"a\", \"b\", \"c\"])\n \n+    # Check error when feature_names contains non-string elements\n+    message = \"All feature names must be strings.\"\n+    with pytest.raises(ValueError, match=message):\n+        export_graphviz(clf, None, feature_names=[\"a\", 1])\n+\n     # Check error when argument is not an estimator\n     message = \"is not an estimator instance\"\n     with pytest.raises(TypeError, match=message):\n",
  "fail_to_pass": [],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/tree/_export.py",
    "sklearn/tree/tests/test_export.py"
  ],
  "difficulty": "medium",
  "created_at": "2025-03-20T11:53:46Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/31036",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/30834"
}