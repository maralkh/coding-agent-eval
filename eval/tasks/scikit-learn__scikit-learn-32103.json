{
  "id": "scikit-learn__scikit-learn-32103",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "f72958d81b897ec1c9d5ddd62a99c00850832200",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 32103,
  "pr_title": "API make murmurhash3_32 private",
  "gold_patch": "diff --git a/doc/api_reference.py b/doc/api_reference.py\nindex 51d1c514a1ce1..63478d7338b73 100644\n--- a/doc/api_reference.py\n+++ b/doc/api_reference.py\n@@ -1350,4 +1350,4 @@ def _get_submodule(module_name, submodule_name):\n }\n \"\"\"\n \n-DEPRECATED_API_REFERENCE = {}  # type: ignore[var-annotated]\n+DEPRECATED_API_REFERENCE = {\"1.8.0\": [\"utils.murmurhash3_32\"]}  # type: ignore[var-annotated]\ndiff --git a/doc/whats_new/upcoming_changes/sklearn.utils/32103.api.rst b/doc/whats_new/upcoming_changes/sklearn.utils/32103.api.rst\nnew file mode 100644\nindex 0000000000000..6ed761a3b5f37\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.utils/32103.api.rst\n@@ -0,0 +1,3 @@\n+- The function :function:`utils.murmurhash.murmurhash3_32` is now deprecated and will be\n+  removed in version 1.10.\n+  By :user:`Fran\u00e7ois Paugam <FrancoisPgm>`.\ndiff --git a/sklearn/utils/murmurhash.pyx b/sklearn/utils/murmurhash.pyx\nindex fee239acd98fb..c7112ae245f81 100644\n--- a/sklearn/utils/murmurhash.pyx\n+++ b/sklearn/utils/murmurhash.pyx\n@@ -17,6 +17,8 @@ from ..utils._typedefs cimport int32_t, uint32_t\n \n import numpy as np\n \n+from sklearn.utils.deprecation import deprecated\n+\n cdef extern from \"src/MurmurHash3.h\":\n     void MurmurHash3_x86_32(void *key, int len, uint32_t seed, void *out)\n     void MurmurHash3_x86_128(void *key, int len, uint32_t seed, void *out)\n@@ -79,9 +81,18 @@ def _murmurhash3_bytes_array_s32(\n     return np.asarray(out)\n \n \n+# TODO(1.10): remove\n+@deprecated(\n+    \"Function `murmurhash3_32` was deprecated in 1.8 and will be \"\n+    \"removed in 1.10.\"\n+)\n def murmurhash3_32(key, seed=0, positive=False):\n     \"\"\"Compute the 32bit murmurhash3 of key at seed.\n \n+    .. deprecated:: 1.8\n+        Function `murmurhash3_32` was deprecated in 1.8.0 and will be\n+        removed in 1.10.0.\n+\n     The underlying implementation is MurmurHash3_x86_32 generating low\n     latency 32bits hash suitable for implementing lookup tables, Bloom\n     filters, count min sketch or feature hashing.\n@@ -106,6 +117,36 @@ def murmurhash3_32(key, seed=0, positive=False):\n     >>> murmurhash3_32(b\"Hello World!\", seed=42)\n     3565178\n     \"\"\"\n+    return _murmurhash3_32(key, seed, positive)\n+\n+\n+def _murmurhash3_32(key, seed=0, positive=False):\n+    \"\"\"Compute the 32bit murmurhash3 of key at seed.\n+\n+    The underlying implementation is MurmurHash3_x86_32 generating low\n+    latency 32bits hash suitable for implementing lookup tables, Bloom\n+    filters, count min sketch or feature hashing.\n+\n+    Parameters\n+    ----------\n+    key : np.int32, bytes, unicode or ndarray of dtype=np.int32\n+        The physical object to hash.\n+\n+    seed : int, default=0\n+        Integer seed for the hashing algorithm.\n+\n+    positive : bool, default=False\n+        True: the results is casted to an unsigned int\n+          from 0 to 2 ** 32 - 1\n+        False: the results is casted to a signed int\n+          from -(2 ** 31) to 2 ** 31 - 1\n+\n+    Examples\n+    --------\n+    >>> from sklearn.utils.murmurhash import _murmurhash3_32\n+    >>> _murmurhash3_32(b\"Hello World!\", seed=42)\n+    3565178\n+    \"\"\"\n     if isinstance(key, bytes):\n         if positive:\n             return murmurhash3_bytes_u32(key, seed)\ndiff --git a/sklearn/utils/tests/test_murmurhash.py b/sklearn/utils/tests/test_murmurhash.py\nindex 20721c6e98f52..b2b54829d5221 100644\n--- a/sklearn/utils/tests/test_murmurhash.py\n+++ b/sklearn/utils/tests/test_murmurhash.py\n@@ -2,23 +2,24 @@\n # SPDX-License-Identifier: BSD-3-Clause\n \n import numpy as np\n+import pytest\n from numpy.testing import assert_array_almost_equal, assert_array_equal\n \n-from sklearn.utils.murmurhash import murmurhash3_32\n+from sklearn.utils.murmurhash import _murmurhash3_32, murmurhash3_32\n \n \n def test_mmhash3_int():\n-    assert murmurhash3_32(3) == 847579505\n-    assert murmurhash3_32(3, seed=0) == 847579505\n-    assert murmurhash3_32(3, seed=42) == -1823081949\n+    assert _murmurhash3_32(3) == 847579505\n+    assert _murmurhash3_32(3, seed=0) == 847579505\n+    assert _murmurhash3_32(3, seed=42) == -1823081949\n \n-    assert murmurhash3_32(3, positive=False) == 847579505\n-    assert murmurhash3_32(3, seed=0, positive=False) == 847579505\n-    assert murmurhash3_32(3, seed=42, positive=False) == -1823081949\n+    assert _murmurhash3_32(3, positive=False) == 847579505\n+    assert _murmurhash3_32(3, seed=0, positive=False) == 847579505\n+    assert _murmurhash3_32(3, seed=42, positive=False) == -1823081949\n \n-    assert murmurhash3_32(3, positive=True) == 847579505\n-    assert murmurhash3_32(3, seed=0, positive=True) == 847579505\n-    assert murmurhash3_32(3, seed=42, positive=True) == 2471885347\n+    assert _murmurhash3_32(3, positive=True) == 847579505\n+    assert _murmurhash3_32(3, seed=0, positive=True) == 847579505\n+    assert _murmurhash3_32(3, seed=42, positive=True) == 2471885347\n \n \n def test_mmhash3_int_array():\n@@ -27,36 +28,38 @@ def test_mmhash3_int_array():\n     keys = keys.reshape((3, 2, 1))\n \n     for seed in [0, 42]:\n-        expected = np.array([murmurhash3_32(int(k), seed) for k in keys.flat])\n+        expected = np.array([_murmurhash3_32(int(k), seed) for k in keys.flat])\n         expected = expected.reshape(keys.shape)\n-        assert_array_equal(murmurhash3_32(keys, seed), expected)\n+        assert_array_equal(_murmurhash3_32(keys, seed), expected)\n \n     for seed in [0, 42]:\n-        expected = np.array([murmurhash3_32(k, seed, positive=True) for k in keys.flat])\n+        expected = np.array(\n+            [_murmurhash3_32(k, seed, positive=True) for k in keys.flat]\n+        )\n         expected = expected.reshape(keys.shape)\n-        assert_array_equal(murmurhash3_32(keys, seed, positive=True), expected)\n+        assert_array_equal(_murmurhash3_32(keys, seed, positive=True), expected)\n \n \n def test_mmhash3_bytes():\n-    assert murmurhash3_32(b\"foo\", 0) == -156908512\n-    assert murmurhash3_32(b\"foo\", 42) == -1322301282\n+    assert _murmurhash3_32(b\"foo\", 0) == -156908512\n+    assert _murmurhash3_32(b\"foo\", 42) == -1322301282\n \n-    assert murmurhash3_32(b\"foo\", 0, positive=True) == 4138058784\n-    assert murmurhash3_32(b\"foo\", 42, positive=True) == 2972666014\n+    assert _murmurhash3_32(b\"foo\", 0, positive=True) == 4138058784\n+    assert _murmurhash3_32(b\"foo\", 42, positive=True) == 2972666014\n \n \n def test_mmhash3_unicode():\n-    assert murmurhash3_32(\"foo\", 0) == -156908512\n-    assert murmurhash3_32(\"foo\", 42) == -1322301282\n+    assert _murmurhash3_32(\"foo\", 0) == -156908512\n+    assert _murmurhash3_32(\"foo\", 42) == -1322301282\n \n-    assert murmurhash3_32(\"foo\", 0, positive=True) == 4138058784\n-    assert murmurhash3_32(\"foo\", 42, positive=True) == 2972666014\n+    assert _murmurhash3_32(\"foo\", 0, positive=True) == 4138058784\n+    assert _murmurhash3_32(\"foo\", 42, positive=True) == 2972666014\n \n \n def test_no_collision_on_byte_range():\n     previous_hashes = set()\n     for i in range(100):\n-        h = murmurhash3_32(\" \" * i, 0)\n+        h = _murmurhash3_32(\" \" * i, 0)\n         assert h not in previous_hashes, \"Found collision on growing empty string\"\n \n \n@@ -65,9 +68,14 @@ def test_uniform_distribution():\n     bins = np.zeros(n_bins, dtype=np.float64)\n \n     for i in range(n_samples):\n-        bins[murmurhash3_32(i, positive=True) % n_bins] += 1\n+        bins[_murmurhash3_32(i, positive=True) % n_bins] += 1\n \n     means = bins / n_samples\n     expected = np.full(n_bins, 1.0 / n_bins)\n \n     assert_array_almost_equal(means / expected, np.ones(n_bins), 2)\n+\n+\n+def test_deprecation_warning():\n+    with pytest.warns(FutureWarning, match=\"`murmurhash3_32` was deprecated\"):\n+        murmurhash3_32(3)\n",
  "fail_to_pass": [
    "test_deprecation_warning"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "doc/api_reference.py",
    "sklearn/utils/tests/test_murmurhash.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-09-04T09:56:05Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32103",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}