{
  "id": "scikit-learn__scikit-learn-32840",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "5b9561dfcef6f0b089f3a09251c05333692fbf74",
  "issue_number": 32837,
  "issue_title": "Enabling array API dispatch causes some estimators without array API support to reject valid NumPy inputs",
  "issue_body": "### Describe the bug\n\nThis might be related to #32836 (or not).\n\nI think we need a common test to check that enabling array API support does not affect estimators (without array API support) when called on regular NumPy (or other valid non-array inputs).\n\nThis bug might be a regression.\n\n### Steps/Code to Reproduce\n\n```python\n# %%\nimport os\n\nos.environ[\"SCIPY_ARRAY_API\"] = \"1\"\n\n\n# %%\nimport sklearn\nfrom sklearn.preprocessing import KBinsDiscretizer\nfrom sklearn.datasets import load_iris\n\nX_iris, y_iris = load_iris(return_X_y=True)\n\nwith sklearn.config_context(array_api_dispatch=True):\n    KBinsDiscretizer(\n        n_bins=3,\n        encode=\"onehot-dense\",\n        strategy=\"uniform\",\n        quantile_method=\"averaged_inverted_cdf\",\n    ).fit_transform(X_iris)\n```\n\n### Expected Results\n\nNo error.\n\n### Actual Results\n\n```python\nTraceback (most recent call last):\n\n  Cell In[5], line 14\n    ).fit_transform(X_iris)\n\n  File ~/code/scikit-learn/sklearn/utils/_set_output.py:316 in wrapped\n    data_to_wrap = f(self, X, *args, **kwargs)\n\n  File ~/code/scikit-learn/sklearn/base.py:907 in fit_transform\n    return self.fit(X, **fit_params).transform(X)\n\n  File ~/code/scikit-learn/sklearn/base.py:1336 in wrapper\n    return fit_method(estimator, *args, **kwargs)\n\n  File ~/code/scikit-learn/sklearn/preprocessing/_discretization.py:414 in fit\n    self._encoder.fit(np.zeros((1, len(self.n_bins_))))\n\n  File ~/code/scikit-learn/sklearn/base.py:1336 in wrapper\n    return fit_method(estimator, *args, **kwargs)\n\n  File ~/code/scikit-learn/sklearn/preprocessing/_encoders.py:999 in fit\n    self._fit(\n\n  File ~/code/scikit-learn/sklearn/preprocessing/_encoders.py:86 in _fit\n    X_list, n_samples, n_features = self._check_X(\n\n  File ~/code/scikit-learn/sklearn/preprocessing/_encoders.py:68 in _check_X\n    Xi = _safe_indexing(X, indices=i, axis=1)\n\n  File ~/code/scikit-learn/sklearn/utils/_indexing.py:357 in _safe_indexing\n    return _array_indexing(X, indices, indices_dtype, axis=axis)\n\n  File ~/code/scikit-learn/sklearn/utils/_indexing.py:39 in _array_indexing\n    key = move_to(key, xp=xp, device=device_)\n\n  File ~/code/scikit-learn/sklearn/utils/_array_api.py:508 in move_to\n    xp_array, _, device_array = get_namespace_and_device(array)\n\n  File ~/code/scikit-learn/sklearn/utils/_array_api.py:453 in get_namespace_and_device\n    xp, is_array_api = get_namespace(*array_list, **skip_remove_kwargs)\n\n  File ~/code/scikit-learn/sklearn/utils/_array_api.py:404 in get_namespace\n    namespace, is_array_api_compliant = array_api_compat.get_namespace(*arrays), True\n\n  File ~/code/scikit-learn/sklearn/externals/array_api_compat/common/_helpers.py:646 in array_namespace\n    raise TypeError(\"Unrecognized array input\")\n\nTypeError: Unrecognized array input\n```\n\n### Versions\n\n```shell\nSystem:\n    python: 3.13.7 | packaged by conda-forge | (main, Sep  3 2025, 14:24:46) [Clang 19.1.7 ]\nexecutable: /Users/ogrisel/miniforge3/envs/dev/bin/python\n   machine: macOS-15.6.1-arm64-arm-64bit-Mach-O\n\nPython dependencies:\n      sklearn: 1.9.dev0\n          pip: 25.2\n   setuptools: 80.9.0\n        numpy: 2.3.3\n        scipy: 1.16.3\n       Cython: 3.1.4\n       pandas: 3.0.0.dev0+2566.g2bb3fef887\n   matplotlib: 3.10.6\n       joblib: 1.5.2\nthreadpoolctl: 3.6.0\n\nBuilt with OpenMP: True\n\nthreadpoolctl info:\n       user_api: blas\n   internal_api: openblas\n    num_threads: 10\n         prefix: libopenblas\n       filepath: /Users/ogrisel/miniforge3/envs/dev/lib/libopenblas.0.dylib\n        version: 0.3.30\nthreading_layer: openmp\n   architecture: VORTEX\n\n       user_api: openmp\n   internal_api: openmp\n    num_threads: 10\n         prefix: libomp\n       filepath: /Users/ogrisel/miniforge3/envs/dev/lib/libomp.dylib\n        version: None\n```",
  "pr_number": 32840,
  "pr_title": "Fix `_safe_indexing` with non integer arrays on array API inputs",
  "gold_patch": "diff --git a/sklearn/utils/_array_api.py b/sklearn/utils/_array_api.py\nindex e3ba6b58149c5..03e3e18db4f84 100644\n--- a/sklearn/utils/_array_api.py\n+++ b/sklearn/utils/_array_api.py\n@@ -469,7 +469,7 @@ def move_to(*arrays, xp, device):\n     `array` may contain `None` entries, these are left unchanged.\n \n     Sparse arrays are accepted (as pass through) if the reference namespace is\n-    Numpy, in which case they are returned unchanged. Otherwise a `TypeError`\n+    NumPy, in which case they are returned unchanged. Otherwise a `TypeError`\n     is raised.\n \n     Parameters\ndiff --git a/sklearn/utils/_indexing.py b/sklearn/utils/_indexing.py\nindex de983f2f3adb0..f4202ac7586c0 100644\n--- a/sklearn/utils/_indexing.py\n+++ b/sklearn/utils/_indexing.py\n@@ -36,8 +36,24 @@ def _array_indexing(array, key, key_dtype, axis):\n     \"\"\"Index an array or scipy.sparse consistently across NumPy version.\"\"\"\n     xp, is_array_api, device_ = get_namespace_and_device(array)\n     if is_array_api:\n-        key = move_to(key, xp=xp, device=device_)\n-        return xp.take(array, key, axis=axis)\n+        if hasattr(key, \"shape\"):\n+            key = move_to(key, xp=xp, device=device_)\n+        elif isinstance(key, (int, slice)):\n+            # Passthrough for valid __getitem__ inputs as noted in the array\n+            # API spec.\n+            pass\n+        else:\n+            key = xp.asarray(key, device=device_)\n+\n+        if hasattr(key, \"dtype\"):\n+            if xp.isdtype(key.dtype, \"integral\"):\n+                return xp.take(array, key, axis=axis)\n+            elif xp.isdtype(key.dtype, \"bool\"):\n+                # Array API does not support boolean indexing for n-dim arrays\n+                # yet hence the need to turn to equivalent integer indexing.\n+                indices = xp.arange(array.shape[axis], device=device_)\n+                return xp.take(array, indices[key], axis=axis)\n+\n     if issparse(array) and key_dtype == \"bool\":\n         key = np.asarray(key)\n     if isinstance(key, tuple):\ndiff --git a/sklearn/utils/tests/test_indexing.py b/sklearn/utils/tests/test_indexing.py\nindex 8934b5ef5a98d..4d4b5a4a7bf78 100644\n--- a/sklearn/utils/tests/test_indexing.py\n+++ b/sklearn/utils/tests/test_indexing.py\n@@ -10,7 +10,10 @@\n from sklearn.externals._packaging.version import parse as parse_version\n from sklearn.utils import _safe_indexing, resample, shuffle\n from sklearn.utils._array_api import (\n+    _convert_to_numpy,\n     _get_namespace_device_dtype_ids,\n+    device,\n+    move_to,\n     yield_namespace_device_dtype_combinations,\n )\n from sklearn.utils._indexing import (\n@@ -22,6 +25,7 @@\n from sklearn.utils._testing import (\n     _array_api_for_tests,\n     _convert_container,\n+    assert_allclose,\n     assert_allclose_dense_sparse,\n     assert_array_equal,\n     skip_if_array_api_compat_not_configured,\n@@ -108,22 +112,22 @@ def test_determine_key_type_slice_error():\n \n @skip_if_array_api_compat_not_configured\n @pytest.mark.parametrize(\n-    \"array_namespace, device, dtype_name\",\n+    \"array_namespace, device_, dtype_name\",\n     yield_namespace_device_dtype_combinations(),\n     ids=_get_namespace_device_dtype_ids,\n )\n-def test_determine_key_type_array_api(array_namespace, device, dtype_name):\n-    xp = _array_api_for_tests(array_namespace, device)\n+def test_determine_key_type_array_api(array_namespace, device_, dtype_name):\n+    xp = _array_api_for_tests(array_namespace, device_)\n \n     with sklearn.config_context(array_api_dispatch=True):\n-        int_array_key = xp.asarray([1, 2, 3])\n+        int_array_key = xp.asarray([1, 2, 3], device=device_)\n         assert _determine_key_type(int_array_key) == \"int\"\n \n-        bool_array_key = xp.asarray([True, False, True])\n+        bool_array_key = xp.asarray([True, False, True], device=device_)\n         assert _determine_key_type(bool_array_key) == \"bool\"\n \n         try:\n-            complex_array_key = xp.asarray([1 + 1j, 2 + 2j, 3 + 3j])\n+            complex_array_key = xp.asarray([1 + 1j, 2 + 2j, 3 + 3j], device=device_)\n         except TypeError:\n             # Complex numbers are not supported by all Array API libraries.\n             complex_array_key = None\n@@ -133,6 +137,42 @@ def test_determine_key_type_array_api(array_namespace, device, dtype_name):\n                 _determine_key_type(complex_array_key)\n \n \n+@skip_if_array_api_compat_not_configured\n+@pytest.mark.parametrize(\n+    \"array_namespace, device_, dtype_name\",\n+    yield_namespace_device_dtype_combinations(),\n+    ids=_get_namespace_device_dtype_ids,\n+)\n+@pytest.mark.parametrize(\n+    \"indexing_key\",\n+    (\n+        0,\n+        -1,\n+        [1, 3],\n+        np.array([1, 3]),\n+        slice(1, 2),\n+        [True, False, True, True],\n+        np.asarray([False, False, False, False]),\n+    ),\n+)\n+@pytest.mark.parametrize(\"axis\", [0, 1])\n+def test_safe_indexing_array_api_support(\n+    array_namespace, device_, dtype_name, indexing_key, axis\n+):\n+    xp = _array_api_for_tests(array_namespace, device_)\n+\n+    array_to_index_np = np.arange(16).reshape(4, 4)\n+    expected_result = _safe_indexing(array_to_index_np, indexing_key, axis=axis)\n+    array_to_index_xp = move_to(array_to_index_np, xp=xp, device=device_)\n+\n+    with sklearn.config_context(array_api_dispatch=True):\n+        indexed_array_xp = _safe_indexing(array_to_index_xp, indexing_key, axis=axis)\n+        assert device(indexed_array_xp) == device(array_to_index_xp)\n+        assert indexed_array_xp.dtype == array_to_index_xp.dtype\n+\n+    assert_allclose(_convert_to_numpy(indexed_array_xp, xp=xp), expected_result)\n+\n+\n @pytest.mark.parametrize(\n     \"array_type\", [\"list\", \"array\", \"sparse\", \"dataframe\", \"polars\", \"pyarrow\"]\n )\n",
  "fail_to_pass": [
    "test_determine_key_type_array_api",
    "test_safe_indexing_array_api_support"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/utils/_array_api.py",
    "sklearn/utils/_indexing.py",
    "sklearn/utils/tests/test_indexing.py"
  ],
  "difficulty": "medium",
  "created_at": "2025-12-04T15:29:28Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/32840",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/32837"
}