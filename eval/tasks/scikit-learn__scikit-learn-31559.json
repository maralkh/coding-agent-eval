{
  "id": "scikit-learn__scikit-learn-31559",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "031d2f83b7c9d1027d1477abb2bf34652621d603",
  "issue_number": 31318,
  "issue_title": "`ValueError` raised by `FeatureUnion._set_output` with `FunctionTransform` that outputs a pandas `Series` in scikit-learn version 1.6",
  "issue_body": "### Describe the bug\n\nHello,\n\nI'm currently working with scikit-learn version 1.6, and I encountered a regression that wasn't present in version 1.4.\n\nThe following minimal code computes two features \u2014 the cumulative mean of age and weight grouped by id. Each transformation function returns a pandas.Series:\n\n\n\nWhen I run this code with scikit-learn 1.6, I get the following error:\n\nAfter investigation, I found that the issue occurs because each transformer returns a Series, not a DataFrame. If I update the functions to return DataFrame objects instead, the error disappears.\n\nInterestingly, in scikit-learn 1.4, the same code works correctly even when the functions return Series.\n\n\nDo you have any explanation for why this changed between version 1.4 and 1.6 ?\n\nThanks in advance for your help!\n\n### Steps/Code to Reproduce\n\n\n```python\nimport pandas as pd\nfrom sklearn.pipeline import FunctionTransformer, FeatureUnion\nimport numpy as np\n\ndef compute_cumulative_mean_age(df: pd.DataFrame) -> pd.Series:\n    return (\n        df[\"age\"]\n        .astype(float)\n        .groupby(df[\"id\"])\n        .expanding()\n        .mean()\n        .droplevel(level=\"id\")\n        .reindex(df.index)\n        .rename(\"cumulative_mean_age\")\n    )\n\ndef compute_cumulative_mean_weight(df: pd.DataFrame) -> pd.Series:\n    return (\n        df[\"poids\"]\n        .astype(float)\n        .groupby(df[\"id\"])\n        .expanding()\n        .mean()\n        .droplevel(level=\"id\")\n        .reindex(df.index)\n        .rename(\"cumulative_mean_weight\")\n    )\n\ndef compute_features(df: pd.DataFrame) -> pd.DataFrame:\n    feature_union = FeatureUnion(\n        [\n            (\"cumulative_mean_age\", FunctionTransformer(compute_cumulative_mean_age)),\n            (\"cumulative_mean_weight\", FunctionTransformer(compute_cumulative_mean_weight))\n        ]\n    ).set_output(transform=\"pandas\")\n\n    return feature_union.fit_transform(X=df).astype(float)\n\ndef transform(df: pd.DataFrame) -> pd.DataFrame:\n    return compute_features(df)\n\nif __name__ == \"__main__\":\n    np.random.seed(42)\n    df = pd.DataFrame({\n        'id': [1, 2, 3, 1, 4, 5, 6, 6, 7, 8],\n        'age': np.random.randint(18, 70, size=10),\n        'poids': np.random.randint(50, 100, size=10)\n    })\n\n    print(transform(df))\n```\n\n### Expected Results\n\n```pytb\nTraceback (most recent call last):\n  File \"C:\\Users\\XXX\\PycharmProjects\\fraude_detection_pec_audio\\tmp.py\", line 73, in <module>\n    print(transform(df=df))\n          ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\XXX\\PycharmProjects\\fraude_detection_pec_audio\\tmp.py\", line 55, in transform\n    return compute_features(\n           ^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\XXX\\PycharmProjects\\fraude_detection_pec_audio\\tmp.py\", line 45, in compute_features\n    .fit_transform(\n     ^^^^^^^^^^^^^^\n  File \"C:\\Users\\XXX\\PycharmProjects\\fraude_detection_pec_audio\\.venv\\Lib\\site-packages\\sklearn\\utils\\_set_output.py\", line 332, in wrapped\n    return _wrap_data_with_container(method, data_to_wrap, X, self)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\XXX\\PycharmProjects\\fraude_detection_pec_audio\\.venv\\Lib\\site-packages\\sklearn\\utils\\_set_output.py\", line 307, in _wrap_data_with_container\n    return adapter.create_container(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\XXX\\PycharmProjects\\fraude_detection_pec_audio\\.venv\\Lib\\site-packages\\sklearn\\utils\\_set_output.py\", line 135, in create_container\n    X_output = _create_pandas_dataframe_from_non_pandas_container(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\XXX\\PycharmProjects\\fraude_detection_pec_audio\\.venv\\Lib\\site-packages\\sklearn\\utils\\fixes.py\", line 428, in _create_pandas_dataframe_from_non_pandas_container\n    return pd.DataFrame(X, index=index, copy=copy)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\XXX\\PycharmProjects\\fraude_detection_pec_audio\\.venv\\Lib\\site-packages\\pandas\\core\\frame.py\", line 722, in __init__\n    mgr = ndarray_to_mgr(\n          ^^^^^^^^^^^^^^^\n  File \"C:\\Users\\XXX\\PycharmProjects\\fraude_detection_pec_audio\\.venv\\Lib\\site-packages\\pandas\\core\\internals\\construction.py\", line 349, in ndarray_to_mgr\n    _check_values_indices_shape_match(values, index, columns)\n  File \"C:\\Users\\XXX\\PycharmProjects\\fraude_detection_pec_audio\\.venv\\Lib\\site-packages\\pandas\\core\\internals\\construction.py\", line 420, in _check_values_indices_shape_match\n    raise ValueError(f\"Shape of passed values is {passed}, indices imply {implied}\")\nValueError: Shape of passed values is (20, 1), indices imply (10, 1)\n```\n\n### Actual Results\n\n```pytb\n    raise ValueError(f\"Shape of passed values is {passed}, indices imply {implied}\")\nValueError: Shape of passed values is (20, 1), indices imply (10, 1)\n```\n\n### Versions\n\n```shell\nsklearn: 1.6.0\nnumpy: 1.26.4\npandas: 1.5.3\n```",
  "pr_number": 31559,
  "pr_title": "FIX Add validation for FeatureUnion transformer outputs (#31318)",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.pipeline/31559.fix.rst b/doc/whats_new/upcoming_changes/sklearn.pipeline/31559.fix.rst\nnew file mode 100644\nindex 0000000000000..0bc465178bb4f\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.pipeline/31559.fix.rst\n@@ -0,0 +1,4 @@\n+- :class:`pipeline.FeatureUnion` now validates that all transformers return 2D outputs\n+  and raises an informative error when transformers return 1D outputs, preventing\n+  silent failures that previously produced meaningless concatenated results.\n+  By :user:`gguiomar <gguiomar>`.\ndiff --git a/sklearn/pipeline.py b/sklearn/pipeline.py\nindex b291d970b1c79..7708483d246fc 100644\n--- a/sklearn/pipeline.py\n+++ b/sklearn/pipeline.py\n@@ -2037,15 +2037,23 @@ def transform(self, X, **params):\n         return self._hstack(Xs)\n \n     def _hstack(self, Xs):\n+        # Check if Xs dimensions are valid\n+        for X, (name, _) in zip(Xs, self.transformer_list):\n+            if hasattr(X, \"shape\") and len(X.shape) != 2:\n+                raise ValueError(\n+                    f\"Transformer '{name}' returned an array or dataframe with \"\n+                    f\"{len(X.shape)} dimensions, but expected 2 dimensions \"\n+                    \"(n_samples, n_features).\"\n+                )\n+\n         adapter = _get_container_adapter(\"transform\", self)\n         if adapter and all(adapter.is_supported_container(X) for X in Xs):\n             return adapter.hstack(Xs)\n \n         if any(sparse.issparse(f) for f in Xs):\n-            Xs = sparse.hstack(Xs).tocsr()\n-        else:\n-            Xs = np.hstack(Xs)\n-        return Xs\n+            return sparse.hstack(Xs).tocsr()\n+\n+        return np.hstack(Xs)\n \n     def _update_transformer_list(self, transformers):\n         transformers = iter(transformers)\ndiff --git a/sklearn/tests/test_pipeline.py b/sklearn/tests/test_pipeline.py\nindex ad00ffb67a616..a7387bd5ebdba 100644\n--- a/sklearn/tests/test_pipeline.py\n+++ b/sklearn/tests/test_pipeline.py\n@@ -1890,6 +1890,22 @@ def test_feature_union_feature_names_in_():\n     assert not hasattr(union, \"feature_names_in_\")\n \n \n+def test_feature_union_1d_output():\n+    \"\"\"Test that FeatureUnion raises error for 1D transformer outputs.\"\"\"\n+    X = np.arange(6).reshape(3, 2)\n+\n+    with pytest.raises(\n+        ValueError,\n+        match=\"Transformer 'b' returned an array or dataframe with 1 dimensions\",\n+    ):\n+        FeatureUnion(\n+            [\n+                (\"a\", FunctionTransformer(lambda X: X)),\n+                (\"b\", FunctionTransformer(lambda X: X[:, 1])),\n+            ]\n+        ).fit_transform(X)\n+\n+\n # transform_input tests\n # =====================\n \n",
  "fail_to_pass": [
    "test_feature_union_1d_output"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/pipeline.py",
    "sklearn/tests/test_pipeline.py"
  ],
  "difficulty": "medium",
  "created_at": "2025-06-16T18:14:44Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/31559",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/31318"
}