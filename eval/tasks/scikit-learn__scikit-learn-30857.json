{
  "id": "scikit-learn__scikit-learn-30857",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "16f7d5aebee6e6768ea4e67a663bc170032f351e",
  "issue_number": 1234,
  "issue_title": "MRG fix bincount mess I made in kmeans.",
  "issue_body": "This should clean up the stuff I pushed earlier.\ncc @ogrisel @gaelvaroquaux Could you have a brief look? What I pushed earlier is buggy but I didn't dare push again after so many failed fixes.\n",
  "pr_number": 30857,
  "pr_title": "TST use global_random_seed in sklearn/utils/tests/test_stats.py",
  "gold_patch": "diff --git a/sklearn/utils/tests/test_stats.py b/sklearn/utils/tests/test_stats.py\nindex ec60a1358e440..1c979425f12f8 100644\n--- a/sklearn/utils/tests/test_stats.py\n+++ b/sklearn/utils/tests/test_stats.py\n@@ -24,8 +24,8 @@ def test_averaged_weighted_median():\n     assert score == np.median(y)\n \n \n-def test_averaged_weighted_percentile():\n-    rng = np.random.RandomState(0)\n+def test_averaged_weighted_percentile(global_random_seed):\n+    rng = np.random.RandomState(global_random_seed)\n     y = rng.randint(20, size=10)\n \n     sw = np.ones(10)\n@@ -96,7 +96,7 @@ def test_weighted_percentile_zero_weight_zero_percentile():\n     assert approx(value) == 4\n \n \n-def test_weighted_median_equal_weights():\n+def test_weighted_median_equal_weights(global_random_seed):\n     \"\"\"Checks `_weighted_percentile(percentile_rank=50)` is the same as `np.median`.\n \n     `sample_weights` are all 1s and the number of samples is odd.\n@@ -106,7 +106,7 @@ def test_weighted_median_equal_weights():\n     For an even number of samples, this check will not always hold as (note that\n     for some other percentile methods it will always hold). See #17370 for details.\n     \"\"\"\n-    rng = np.random.RandomState(0)\n+    rng = np.random.RandomState(global_random_seed)\n     x = rng.randint(10, size=11)\n     weights = np.ones(x.shape)\n     median = np.median(x)\n@@ -114,21 +114,21 @@ def test_weighted_median_equal_weights():\n     assert median == approx(w_median)\n \n \n-def test_weighted_median_integer_weights():\n-    # Checks weighted percentile_rank=0.5 is same as median when manually weight\n+def test_weighted_median_integer_weights(global_random_seed):\n+    # Checks average weighted percentile_rank=0.5 is same as median when manually weight\n     # data\n-    rng = np.random.RandomState(0)\n+    rng = np.random.RandomState(global_random_seed)\n     x = rng.randint(20, size=10)\n     weights = rng.choice(5, size=10)\n     x_manual = np.repeat(x, weights)\n     median = np.median(x_manual)\n-    w_median = _weighted_percentile(x, weights)\n+    w_median = _averaged_weighted_percentile(x, weights)\n     assert median == approx(w_median)\n \n \n-def test_weighted_percentile_2d():\n+def test_weighted_percentile_2d(global_random_seed):\n     # Check for when array 2D and sample_weight 1D\n-    rng = np.random.RandomState(0)\n+    rng = np.random.RandomState(global_random_seed)\n     x1 = rng.randint(10, size=10)\n     w1 = rng.choice(5, size=10)\n \n@@ -235,21 +235,21 @@ def test_weighted_percentile_array_api_consistency(\n \n \n @pytest.mark.parametrize(\"sample_weight_ndim\", [1, 2])\n-def test_weighted_percentile_nan_filtered(sample_weight_ndim):\n+def test_weighted_percentile_nan_filtered(sample_weight_ndim, global_random_seed):\n     \"\"\"Test that calling _weighted_percentile on an array with nan values returns\n     the same results as calling _weighted_percentile on a filtered version of the data.\n     We test both with sample_weight of the same shape as the data and with\n     one-dimensional sample_weight.\"\"\"\n \n-    rng = np.random.RandomState(42)\n-    array_with_nans = rng.rand(10, 100)\n+    rng = np.random.RandomState(global_random_seed)\n+    array_with_nans = rng.rand(100, 10)\n     array_with_nans[rng.rand(*array_with_nans.shape) < 0.5] = np.nan\n     nan_mask = np.isnan(array_with_nans)\n \n     if sample_weight_ndim == 2:\n-        sample_weight = rng.randint(1, 6, size=(10, 100))\n+        sample_weight = rng.randint(1, 6, size=(100, 10))\n     else:\n-        sample_weight = rng.randint(1, 6, size=(10,))\n+        sample_weight = rng.randint(1, 6, size=(100,))\n \n     # Find the weighted percentile on the array with nans:\n     results = _weighted_percentile(array_with_nans, sample_weight, 30)\n@@ -306,11 +306,11 @@ def test_weighted_percentile_all_nan_column():\n     reason=\"np.quantile only accepts weights since version 2.0\",\n )\n @pytest.mark.parametrize(\"percentile\", [66, 10, 50])\n-def test_weighted_percentile_like_numpy_quantile(percentile):\n+def test_weighted_percentile_like_numpy_quantile(percentile, global_random_seed):\n     \"\"\"Check that _weighted_percentile delivers equivalent results as np.quantile\n     with weights.\"\"\"\n \n-    rng = np.random.RandomState(42)\n+    rng = np.random.RandomState(global_random_seed)\n     array = rng.rand(10, 100)\n     sample_weight = rng.randint(1, 6, size=(10, 100))\n \n@@ -329,11 +329,11 @@ def test_weighted_percentile_like_numpy_quantile(percentile):\n     reason=\"np.nanquantile only accepts weights since version 2.0\",\n )\n @pytest.mark.parametrize(\"percentile\", [66, 10, 50])\n-def test_weighted_percentile_like_numpy_nanquantile(percentile):\n+def test_weighted_percentile_like_numpy_nanquantile(percentile, global_random_seed):\n     \"\"\"Check that _weighted_percentile delivers equivalent results as np.nanquantile\n     with weights.\"\"\"\n \n-    rng = np.random.RandomState(42)\n+    rng = np.random.RandomState(global_random_seed)\n     array_with_nans = rng.rand(10, 100)\n     array_with_nans[rng.rand(*array_with_nans.shape) < 0.5] = np.nan\n     sample_weight = rng.randint(1, 6, size=(10, 100))\n",
  "fail_to_pass": [
    "test_averaged_weighted_percentile",
    "test_weighted_median_equal_weights",
    "test_weighted_median_integer_weights",
    "test_weighted_percentile_2d",
    "test_weighted_percentile_nan_filtered",
    "test_weighted_percentile_like_numpy_quantile",
    "test_weighted_percentile_like_numpy_nanquantile"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/utils/tests/test_stats.py"
  ],
  "difficulty": "easy",
  "created_at": "2025-02-19T01:35:30Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/30857",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/1234"
}