{
  "id": "scikit-learn__scikit-learn-30203",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "551d56c254197c4b6ad63974d749824ed2c7bc58",
  "issue_number": 30197,
  "issue_title": "Exception on rendering html empty pipeline ",
  "issue_body": "### Describe the bug\r\n\r\nRendering empty pipeline to html fails, and just simply displaying an empty pipeline fails on IPython/Jupyter.\r\n\r\nSee upstream IPython issue:\r\n\r\nhttps://github.com/ipython/ipython/issues/14568\r\n\r\n### Steps/Code to Reproduce\r\n\r\n```python\r\n>>> from sklearn.pipeline import Pipeline\r\n>>> pipeline = Pipeline(steps=[])\r\n>>> pipeline\r\nPipeline(steps=[])\r\n>>> from sklearn.utils._estimator_html_repr import estimator_html_repr\r\n>>> estimator_html_repr(pipeline)\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/Users/bussonniermatthias/miniconda3/envs/arm64/lib/python3.12/site-packages/sklearn/utils/_estimator_html_repr.py\", line 348, in estimator_html_repr\r\n    check_is_fitted(estimator)\r\n  File \"/Users/bussonniermatthias/miniconda3/envs/arm64/lib/python3.12/site-packages/sklearn/utils/validation.py\", line 1660, in check_is_fitted\r\n    if not _is_fitted(estimator, attributes, all_or_any):\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/bussonniermatthias/miniconda3/envs/arm64/lib/python3.12/site-packages/sklearn/utils/validation.py\", line 1579, in _is_fitted\r\n    return estimator.__sklearn_is_fitted__()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/bussonniermatthias/miniconda3/envs/arm64/lib/python3.12/site-packages/sklearn/pipeline.py\", line 1096, in __sklearn_is_fitted__\r\n    check_is_fitted(self.steps[-1][1])\r\n                    ~~~~~~~~~~^^^^\r\nIndexError: list index out of range\r\n```\r\n\r\nor just in IPython:\r\n\r\n```python\r\n# This code fails - EMPTY pipeline is rendered\r\n\r\nfrom sklearn.pipeline import Pipeline\r\n\r\n# Create pipeline\r\npipeline = Pipeline(steps=[])\r\npipeline\r\n# same error, no need to explicitely call the repr code as it is registerd.\r\n```\r\n\r\n### Expected Results\r\n\r\nDon't raise in the repr_handler.\r\n\r\n\r\n### Actual Results\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/Users/bussonniermatthias/miniconda3/envs/arm64/lib/python3.12/site-packages/sklearn/utils/_estimator_html_repr.py\", line 348, in estimator_html_repr\r\n    check_is_fitted(estimator)\r\n  File \"/Users/bussonniermatthias/miniconda3/envs/arm64/lib/python3.12/site-packages/sklearn/utils/validation.py\", line 1660, in check_is_fitted\r\n    if not _is_fitted(estimator, attributes, all_or_any):\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/bussonniermatthias/miniconda3/envs/arm64/lib/python3.12/site-packages/sklearn/utils/validation.py\", line 1579, in _is_fitted\r\n    return estimator.__sklearn_is_fitted__()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/bussonniermatthias/miniconda3/envs/arm64/lib/python3.12/site-packages/sklearn/pipeline.py\", line 1096, in __sklearn_is_fitted__\r\n    check_is_fitted(self.steps[-1][1])\r\n                    ~~~~~~~~~~^^^^\r\nIndexError: list index out of range\r\n```\r\n\r\n### Versions\r\n\r\n```shell\r\nsklearn: 1.5.2\r\n```\r\n",
  "pr_number": 30203,
  "pr_title": "FIX handle empty steps in `Pipeline`",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.pipeline/30203.fix.rst b/doc/whats_new/upcoming_changes/sklearn.pipeline/30203.fix.rst\nnew file mode 100644\nindex 0000000000000..89355c522e541\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.pipeline/30203.fix.rst\n@@ -0,0 +1,4 @@\n+- Fixed an issue with tags and estimator type of :class:`~sklearn.pipeline.Pipeline`\n+  when pipeline is empty. This allows the HTML representation of an empty\n+  pipeline to be rendered correctly.\n+  By :user:`Gennaro Daniele Acciaro <gdacciaro>`\n\\ No newline at end of file\ndiff --git a/sklearn/pipeline.py b/sklearn/pipeline.py\nindex 54fc572e12672..63438219143ff 100644\n--- a/sklearn/pipeline.py\n+++ b/sklearn/pipeline.py\n@@ -348,6 +348,11 @@ def __getitem__(self, ind):\n     # TODO(1.8): Remove this property\n     @property\n     def _estimator_type(self):\n+        \"\"\"Return the estimator type of the last step in the pipeline.\"\"\"\n+\n+        if not self.steps:\n+            return None\n+\n         return self.steps[-1][1]._estimator_type\n \n     @property\n@@ -1060,6 +1065,9 @@ def __sklearn_tags__(self):\n             ),\n         }\n \n+        if not self.steps:\n+            return tags\n+\n         try:\n             if self.steps[0][1] is not None and self.steps[0][1] != \"passthrough\":\n                 tags.input_tags.pairwise = get_tags(\ndiff --git a/sklearn/tests/test_pipeline.py b/sklearn/tests/test_pipeline.py\nindex d425c00f114a2..f0a064ddf9942 100644\n--- a/sklearn/tests/test_pipeline.py\n+++ b/sklearn/tests/test_pipeline.py\n@@ -14,7 +14,13 @@\n import pytest\n \n from sklearn import config_context\n-from sklearn.base import BaseEstimator, TransformerMixin, clone, is_classifier\n+from sklearn.base import (\n+    BaseEstimator,\n+    TransformerMixin,\n+    clone,\n+    is_classifier,\n+    is_regressor,\n+)\n from sklearn.cluster import KMeans\n from sklearn.datasets import load_iris\n from sklearn.decomposition import PCA, TruncatedSVD\n@@ -41,6 +47,7 @@\n     _Registry,\n     check_recorded_metadata,\n )\n+from sklearn.utils import get_tags\n from sklearn.utils._metadata_requests import COMPOSITE_METHODS, METHODS\n from sklearn.utils._testing import (\n     MinimalClassifier,\n@@ -867,6 +874,52 @@ def test_make_pipeline():\n     assert pipe.steps[2][0] == \"fitparamt\"\n \n \n+@pytest.mark.parametrize(\n+    \"pipeline, check_estimator_type\",\n+    [\n+        (make_pipeline(StandardScaler(), LogisticRegression()), is_classifier),\n+        (make_pipeline(StandardScaler(), LinearRegression()), is_regressor),\n+        (\n+            make_pipeline(StandardScaler()),\n+            lambda est: get_tags(est).estimator_type is None,\n+        ),\n+        (Pipeline([]), lambda est: est._estimator_type is None),\n+    ],\n+)\n+def test_pipeline_estimator_type(pipeline, check_estimator_type):\n+    \"\"\"Check that the estimator type returned by the pipeline is correct.\n+\n+    Non-regression test as part of:\n+    https://github.com/scikit-learn/scikit-learn/issues/30197\n+    \"\"\"\n+    # Smoke test the repr\n+    repr(pipeline)\n+    assert check_estimator_type(pipeline)\n+\n+\n+def test_sklearn_tags_with_empty_pipeline():\n+    \"\"\"Check that we propagate properly the tags in a Pipeline.\n+\n+    Non-regression test as part of:\n+    https://github.com/scikit-learn/scikit-learn/issues/30197\n+    \"\"\"\n+    empty_pipeline = Pipeline(steps=[])\n+    be = BaseEstimator()\n+\n+    expected_tags = be.__sklearn_tags__()\n+    expected_tags._xfail_checks = {\n+        \"check_dont_overwrite_parameters\": (\n+            \"Pipeline changes the `steps` parameter, which it shouldn't.\"\n+            \"Therefore this test is x-fail until we fix this.\"\n+        ),\n+        \"check_estimators_overwrite_params\": (\n+            \"Pipeline changes the `steps` parameter, which it shouldn't.\"\n+            \"Therefore this test is x-fail until we fix this.\"\n+        ),\n+    }\n+    assert empty_pipeline.__sklearn_tags__() == expected_tags\n+\n+\n def test_feature_union_weights():\n     # test feature union with transformer weights\n     X = iris.data\ndiff --git a/sklearn/utils/tests/test_estimator_html_repr.py b/sklearn/utils/tests/test_estimator_html_repr.py\nindex 580eb24584e2f..c1c35d29c4472 100644\n--- a/sklearn/utils/tests/test_estimator_html_repr.py\n+++ b/sklearn/utils/tests/test_estimator_html_repr.py\n@@ -140,6 +140,16 @@ def test_get_visual_block_column_transformer():\n     assert est_html_info.name_details == ([\"num1\", \"num2\"], [0, 3])\n \n \n+def test_estimator_html_repr_an_empty_pipeline():\n+    \"\"\"Check that the representation of an empty Pipeline does not fail.\n+\n+    Non-regression test for:\n+    https://github.com/scikit-learn/scikit-learn/issues/30197\n+    \"\"\"\n+    empty_pipeline = Pipeline([])\n+    estimator_html_repr(empty_pipeline)\n+\n+\n def test_estimator_html_repr_pipeline():\n     num_trans = Pipeline(\n         steps=[(\"pass\", \"passthrough\"), (\"imputer\", SimpleImputer(strategy=\"median\"))]\n",
  "fail_to_pass": [
    "test_pipeline_estimator_type",
    "test_sklearn_tags_with_empty_pipeline",
    "test_estimator_html_repr_an_empty_pipeline"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/pipeline.py",
    "sklearn/tests/test_pipeline.py",
    "sklearn/utils/tests/test_estimator_html_repr.py"
  ],
  "difficulty": "hard",
  "created_at": "2024-11-03T23:08:59Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/30203",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/30197"
}