{
  "id": "scikit-learn__scikit-learn-31079",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "953af7df7d6ab17a2c07a06647aac9026e562344",
  "issue_number": 31051,
  "issue_title": "`PandasAdapter` causes crash or misattributed features",
  "issue_body": "### Describe the bug\n\nIf all the following hold\n- Using ColumnTransformer with the output container set to pandas\n- At least one transformer transforms 1D inputs to 2D outputs (like [DictVectorizer](https://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.DictVectorizer.html))\n- At least one transformer transformers 2D inputs to 2D outputs (like [FunctionTransformer](https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.FunctionTransformer.html))\n- The input is a pandas DataFrame with non-default index\n\nthen fit/transform with the ColumnTransformer crashes because of index misalignment, or (in pathological situations) **permutes the outputs of some feature transforms making the first data point have some features from the first data point and some features from the second data point**.\n\n### Steps/Code to Reproduce\n\n```python\nimport pandas as pd\nfrom sklearn.compose import make_column_transformer\nfrom sklearn.feature_extraction import DictVectorizer\nfrom sklearn.preprocessing import FunctionTransformer\n\ndf = pd.DataFrame({\n    'dict_col': [{'foo': 1, 'bar': 2}, {'foo': 3, 'baz': 1}],\n    'dummy_col': [1, 2]\n}, index=[1, 2])  # replace with [1, 0] for pathological example\n                 \nt = make_column_transformer(\n    (DictVectorizer(sparse=False), 'dict_col'),\n    (FunctionTransformer(), ['dummy_col']),\n)\nt.set_output(transform='pandas')\n\nt.fit_transform(df)\n```\n\n### Expected Results\n\nThe following features dataframe:\n||dictvectorizer__bar|dictvectorizer__baz|dictvectorizer__foo|functiontransformer__dummy_col|\n|---|---|---|---|---|\n|0|2|0|1|1|\n|1|0|1|3|2|\n\n### Actual Results\n\nA crash:\n```\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\nCell In[3], line 17\n     11 t = make_column_transformer(\n     12     (DictVectorizer(sparse=False), 'dict_col'),\n     13     (FunctionTransformer(), ['dummy_col']),\n     14 )\n     15 t.set_output(transform='pandas')\n---> 17 t.fit_transform(df)\n\nFile [~\\Documents\\Code\\Python\\Scratchwork\\pandas_adapter\\Lib\\site-packages\\sklearn\\utils\\_set_output.py:319](http://localhost:8888/lab/tree/~/Documents/Code/Python/Scratchwork/pandas_adapter/Lib/site-packages/sklearn/utils/_set_output.py#line=318), in _wrap_method_output.<locals>.wrapped(self, X, *args, **kwargs)\n    317 @wraps(f)\n    318 def wrapped(self, X, *args, **kwargs):\n--> 319     data_to_wrap = f(self, X, *args, **kwargs)\n    320     if isinstance(data_to_wrap, tuple):\n    321         # only wrap the first output for cross decomposition\n    322         return_tuple = (\n    323             _wrap_data_with_container(method, data_to_wrap[0], X, self),\n    324             *data_to_wrap[1:],\n    325         )\n\nFile [~\\Documents\\Code\\Python\\Scratchwork\\pandas_adapter\\Lib\\site-packages\\sklearn\\base.py:1389](http://localhost:8888/lab/tree/~/Documents/Code/Python/Scratchwork/pandas_adapter/Lib/site-packages/sklearn/base.py#line=1388), in _fit_context.<locals>.decorator.<locals>.wrapper(estimator, *args, **kwargs)\n   1382     estimator._validate_params()\n   1384 with config_context(\n   1385     skip_parameter_validation=(\n   1386         prefer_skip_nested_validation or global_skip_validation\n   1387     )\n   1388 ):\n-> 1389     return fit_method(estimator, *args, **kwargs)\n\nFile [~\\Documents\\Code\\Python\\Scratchwork\\pandas_adapter\\Lib\\site-packages\\sklearn\\compose\\_column_transformer.py:1031](http://localhost:8888/lab/tree/~/Documents/Code/Python/Scratchwork/pandas_adapter/Lib/site-packages/sklearn/compose/_column_transformer.py#line=1030), in ColumnTransformer.fit_transform(self, X, y, **params)\n   1028 self._validate_output(Xs)\n   1029 self._record_output_indices(Xs)\n-> 1031 return self._hstack(list(Xs), n_samples=n_samples)\n\nFile [~\\Documents\\Code\\Python\\Scratchwork\\pandas_adapter\\Lib\\site-packages\\sklearn\\compose\\_column_transformer.py:1215](http://localhost:8888/lab/tree/~/Documents/Code/Python/Scratchwork/pandas_adapter/Lib/site-packages/sklearn/compose/_column_transformer.py#line=1214), in ColumnTransformer._hstack(self, Xs, n_samples)\n   1213     output_samples = output.shape[0]\n   1214     if output_samples != n_samples:\n-> 1215         raise ValueError(\n   1216             \"Concatenating DataFrames from the transformer's output lead to\"\n   1217             \" an inconsistent number of samples. The output may have Pandas\"\n   1218             \" Indexes that do not match, or that transformers are returning\"\n   1219             \" number of samples which are not the same as the number input\"\n   1220             \" samples.\"\n   1221         )\n   1223     return output\n   1225 return np.hstack(Xs)\n\nValueError: Concatenating DataFrames from the transformer's output lead to an inconsistent number of samples. The output may have Pandas Indexes that do not match, or that transformers are returning number of samples which are not the same as the number input samples.\n```\n\nOr the following for the pathological example (note the two entries in functiontransformer__dummy_col are in the wrong order):\n||dictvectorizer__bar|dictvectorizer__baz|dictvectorizer__foo|functiontransformer__dummy_col|\n|---|---|---|---|---|\n|0|2|0|1|2|\n|1|0|1|3|1|\n\n### Versions\n\n```shell\nSystem:\n    python: 3.12.6 (tags/v3.12.6:a4a2d2b, Sep  6 2024, 20:11:23) [MSC v.1940 64 bit (AMD64)]\nexecutable: C:\\Users\\user\\Documents\\Code\\Python\\Scratchwork\\pandas_adapter\\Scripts\\python.exe\n   machine: Windows-11-10.0.26100-SP0\n\nPython dependencies:\n      sklearn: 1.6.1\n          pip: 24.2\n   setuptools: 77.0.3\n        numpy: 2.2.4\n        scipy: 1.15.2\n       Cython: None\n       pandas: 2.2.3\n   matplotlib: None\n       joblib: 1.4.2\nthreadpoolctl: 3.6.0\n\nBuilt with OpenMP: True\n\nthreadpoolctl info:\n       user_api: blas\n   internal_api: openblas\n    num_threads: 12\n         prefix: libscipy_openblas\n       filepath: C:\\Users\\user\\Documents\\Code\\Python\\Scratchwork\\pandas_adapter\\Lib\\site-packages\\numpy.libs\\libscipy_openblas64_-43e11ff0749b8cbe0a615c9cf6737e0e.dll\n        version: 0.3.28\nthreading_layer: pthreads\n   architecture: Haswell\n\n       user_api: openmp\n   internal_api: openmp\n    num_threads: 12\n         prefix: vcomp\n       filepath: C:\\Users\\user\\Documents\\Code\\Python\\Scratchwork\\pandas_adapter\\Lib\\site-packages\\sklearn\\.libs\\vcomp140.dll\n        version: None\n\n       user_api: blas\n   internal_api: openblas\n    num_threads: 12\n         prefix: libscipy_openblas\n       filepath: C:\\Users\\user\\Documents\\Code\\Python\\Scratchwork\\pandas_adapter\\Lib\\site-packages\\scipy.libs\\libscipy_openblas-f07f5a5d207a3a47104dca54d6d0c86a.dll\n        version: 0.3.28\nthreading_layer: pthreads\n   architecture: Haswell\n```",
  "pr_number": 31079,
  "pr_title": "Fix `PandasAdapter` causes crash or misattributed features",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.compose/31079.fix.rst b/doc/whats_new/upcoming_changes/sklearn.compose/31079.fix.rst\nnew file mode 100644\nindex 0000000000000..b7ecaf67292b9\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.compose/31079.fix.rst\n@@ -0,0 +1,3 @@\n+- :class:`compose.ColumnTransformer` now correctly preserves non-default index\n+  when mixing pandas Series and Dataframes.\n+  By :user:`Nicolas Bolle <nicolas-bolle>`.\ndiff --git a/sklearn/compose/tests/test_column_transformer.py b/sklearn/compose/tests/test_column_transformer.py\nindex a458d44c53fb4..4fac38defcaa7 100644\n--- a/sklearn/compose/tests/test_column_transformer.py\n+++ b/sklearn/compose/tests/test_column_transformer.py\n@@ -20,6 +20,7 @@\n     make_column_transformer,\n )\n from sklearn.exceptions import NotFittedError\n+from sklearn.feature_extraction import DictVectorizer\n from sklearn.feature_selection import VarianceThreshold\n from sklearn.preprocessing import (\n     FunctionTransformer,\n@@ -2619,6 +2620,29 @@ def test_column_transformer_auto_memmap(global_random_seed):\n     assert_allclose(Xt, StandardScaler().fit_transform(X[:, [0]]))\n \n \n+def test_column_transformer_non_default_index():\n+    \"\"\"Check index handling when both pd.Series and pd.DataFrame slices are used in\n+    ColumnTransformer.\n+\n+    Non-regression test for issue #31546.\n+    \"\"\"\n+    pd = pytest.importorskip(\"pandas\")\n+    df = pd.DataFrame(\n+        {\n+            \"dict_col\": [{\"foo\": 1, \"bar\": 2}, {\"foo\": 3, \"baz\": 1}],\n+            \"dummy_col\": [1, 2],\n+        },\n+        index=[1, 2],\n+    )\n+    t = make_column_transformer(\n+        (DictVectorizer(sparse=False), \"dict_col\"),\n+        (FunctionTransformer(), [\"dummy_col\"]),\n+    )\n+    t.set_output(transform=\"pandas\")\n+    X = t.fit_transform(df)\n+    assert list(X.index) == [1, 2]\n+\n+\n # Metadata Routing Tests\n # ======================\n \ndiff --git a/sklearn/utils/_set_output.py b/sklearn/utils/_set_output.py\nindex e6a6fd0c4c305..6219b2f172a27 100644\n--- a/sklearn/utils/_set_output.py\n+++ b/sklearn/utils/_set_output.py\n@@ -124,7 +124,7 @@ def create_container(self, X_output, X_original, columns, inplace=True):\n             # because `list` exposes an `index` attribute.\n             if isinstance(X_output, pd.DataFrame):\n                 index = X_output.index\n-            elif isinstance(X_original, pd.DataFrame):\n+            elif isinstance(X_original, (pd.DataFrame, pd.Series)):\n                 index = X_original.index\n             else:\n                 index = None\ndiff --git a/sklearn/utils/tests/test_set_output.py b/sklearn/utils/tests/test_set_output.py\nindex 2b756ada64a6d..146f0a6c28592 100644\n--- a/sklearn/utils/tests/test_set_output.py\n+++ b/sklearn/utils/tests/test_set_output.py\n@@ -25,8 +25,9 @@ def test_pandas_adapter():\n     pd = pytest.importorskip(\"pandas\")\n     X_np = np.asarray([[1, 0, 3], [0, 0, 1]])\n     columns = np.asarray([\"f0\", \"f1\", \"f2\"], dtype=object)\n-    index = np.asarray([0, 1])\n+    index = np.asarray([1, 2])\n     X_df_orig = pd.DataFrame([[1, 2], [1, 3]], index=index)\n+    X_ser_orig = pd.Series([2, 3], index=index)\n \n     adapter = ADAPTERS_MANAGER.adapters[\"pandas\"]\n     X_container = adapter.create_container(X_np, X_df_orig, columns=lambda: columns)\n@@ -34,6 +35,12 @@ def test_pandas_adapter():\n     assert_array_equal(X_container.columns, columns)\n     assert_array_equal(X_container.index, index)\n \n+    # use original index when the original is a series\n+    X_container = adapter.create_container(X_np, X_ser_orig, columns=lambda: columns)\n+    assert isinstance(X_container, pd.DataFrame)\n+    assert_array_equal(X_container.columns, columns)\n+    assert_array_equal(X_container.index, index)\n+\n     # Input dataframe's index does not change\n     new_columns = np.asarray([\"f0\", \"f1\"], dtype=object)\n     X_df = pd.DataFrame([[1, 2], [1, 3]], index=[10, 12])\n",
  "fail_to_pass": [
    "test_column_transformer_non_default_index"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/compose/tests/test_column_transformer.py",
    "sklearn/utils/_set_output.py",
    "sklearn/utils/tests/test_set_output.py"
  ],
  "difficulty": "hard",
  "created_at": "2025-03-26T11:40:10Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/31079",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/31051"
}