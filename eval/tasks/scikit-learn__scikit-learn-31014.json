{
  "id": "scikit-learn__scikit-learn-31014",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "a76b02924b91d322e4a9fc7ceeefffe50372a1dc",
  "issue_number": 30818,
  "issue_title": "UnsetMetadataPassedError can point towards the wrong method",
  "issue_body": "### Describe the bug\n\nWhen `enable_metadata_routing=True`, for a missing `set_score_request`, `UnsetMetadataPassedError` message states that a `set_fit_request` is missing.\n\n### Steps/Code to Reproduce\n\n```python\nfrom sklearn import set_config\nfrom sklearn.exceptions import UnsetMetadataPassedError\nfrom sklearn.model_selection import cross_validate\nfrom sklearn.linear_model import LogisticRegression\nimport numpy as np\n\nrng = np.random.RandomState(22)\nn_samples, n_features = 10, 4\nX = rng.rand(n_samples, n_features)\ny = rng.randint(0, 2, size=n_samples)\nsw = rng.randint(0, 5, size=n_samples)\n\nset_config(enable_metadata_routing=True)\n# missing set_score_request\nlogreg = LogisticRegression().set_fit_request(sample_weight=True)\ntry:\n    cross_validate(\n        logreg, X, y, \n        params={\"sample_weight\":sw}, \n        error_score='raise'\n    )\nexcept UnsetMetadataPassedError as e:\n    print(e)\n```\n\n### Expected Results\n\nI would expect an error message pointing towards the missing `set_score_request`, and perhaps a less verbose message when only one metadata is passed. Something like:\n\n\n'sample_weight' are passed to cross validation but are not explicitly set as requested or not requested for cross_validate's estimator: LogisticRegression. Call `.set_score_request(sample_weight=True)` on the estimator for using 'sample_weight' or `sample_weight=False` for not using it. See the Metadata Routing User guide...\n\n### Actual Results\n\n['sample_weight'] are passed to cross validation but are not explicitly set as requested or not requested for cross_validate's estimator: LogisticRegression. Call `.set_fit_request({{metadata}}=True)` on the estimator for each metadata in ['sample_weight'] that you want to use and `metadata=False` for not using it. See the Metadata Routing User guide...\n\n### Versions\n\n```shell\nsklearn: 1.7.dev0\n```",
  "pr_number": 31014,
  "pr_title": "MNT fix error message for UnsetMetadataPassedError in validation",
  "gold_patch": "diff --git a/sklearn/model_selection/_validation.py b/sklearn/model_selection/_validation.py\nindex 2ae704baaefd1..aeb810247c58c 100644\n--- a/sklearn/model_selection/_validation.py\n+++ b/sklearn/model_selection/_validation.py\n@@ -378,19 +378,8 @@ def cross_validate(\n             # `process_routing` code, we pass `fit` as the caller. However,\n             # the user is not calling `fit` directly, so we change the message\n             # to make it more suitable for this case.\n-            unrequested_params = sorted(e.unrequested_params)\n             raise UnsetMetadataPassedError(\n-                message=(\n-                    f\"{unrequested_params} are passed to cross validation but are not\"\n-                    \" explicitly set as requested or not requested for cross_validate's\"\n-                    f\" estimator: {estimator.__class__.__name__}. Call\"\n-                    \" `.set_fit_request({{metadata}}=True)` on the estimator for\"\n-                    f\" each metadata in {unrequested_params} that you\"\n-                    \" want to use and `metadata=False` for not using it. See the\"\n-                    \" Metadata Routing User guide\"\n-                    \" <https://scikit-learn.org/stable/metadata_routing.html> for more\"\n-                    \" information.\"\n-                ),\n+                message=str(e).replace(\"cross_validate.fit\", \"cross_validate\"),\n                 unrequested_params=e.unrequested_params,\n                 routed_params=e.routed_params,\n             )\n@@ -1184,7 +1173,7 @@ def cross_val_predict(\n         # methods. For these router methods, we create the router to use\n         # `process_routing` on it.\n         router = (\n-            MetadataRouter(owner=\"cross_validate\")\n+            MetadataRouter(owner=\"cross_val_predict\")\n             .add(\n                 splitter=cv,\n                 method_mapping=MethodMapping().add(caller=\"fit\", callee=\"split\"),\n@@ -1202,18 +1191,8 @@ def cross_val_predict(\n             # `process_routing` code, we pass `fit` as the caller. However,\n             # the user is not calling `fit` directly, so we change the message\n             # to make it more suitable for this case.\n-            unrequested_params = sorted(e.unrequested_params)\n             raise UnsetMetadataPassedError(\n-                message=(\n-                    f\"{unrequested_params} are passed to `cross_val_predict` but are\"\n-                    \" not explicitly set as requested or not requested for\"\n-                    f\" cross_validate's estimator: {estimator.__class__.__name__} Call\"\n-                    \" `.set_fit_request({{metadata}}=True)` on the estimator for\"\n-                    f\" each metadata in {unrequested_params} that you want to use and\"\n-                    \" `metadata=False` for not using it. See the Metadata Routing User\"\n-                    \" guide <https://scikit-learn.org/stable/metadata_routing.html>\"\n-                    \" for more information.\"\n-                ),\n+                message=str(e).replace(\"cross_val_predict.fit\", \"cross_val_predict\"),\n                 unrequested_params=e.unrequested_params,\n                 routed_params=e.routed_params,\n             )\n@@ -1677,19 +1656,9 @@ def permutation_test_score(\n             # `process_routing` code, we pass `fit` as the caller. However,\n             # the user is not calling `fit` directly, so we change the message\n             # to make it more suitable for this case.\n-            unrequested_params = sorted(e.unrequested_params)\n             raise UnsetMetadataPassedError(\n-                message=(\n-                    f\"{unrequested_params} are passed to `permutation_test_score`\"\n-                    \" but are not explicitly set as requested or not requested\"\n-                    \" for permutation_test_score's\"\n-                    f\" estimator: {estimator.__class__.__name__}. Call\"\n-                    \" `.set_fit_request({{metadata}}=True)` on the estimator for\"\n-                    f\" each metadata in {unrequested_params} that you\"\n-                    \" want to use and `metadata=False` for not using it. See the\"\n-                    \" Metadata Routing User guide\"\n-                    \" <https://scikit-learn.org/stable/metadata_routing.html> for more\"\n-                    \" information.\"\n+                message=str(e).replace(\n+                    \"permutation_test_score.fit\", \"permutation_test_score\"\n                 ),\n                 unrequested_params=e.unrequested_params,\n                 routed_params=e.routed_params,\n@@ -2029,19 +1998,8 @@ def learning_curve(\n             # `process_routing` code, we pass `fit` as the caller. However,\n             # the user is not calling `fit` directly, so we change the message\n             # to make it more suitable for this case.\n-            unrequested_params = sorted(e.unrequested_params)\n             raise UnsetMetadataPassedError(\n-                message=(\n-                    f\"{unrequested_params} are passed to `learning_curve` but are not\"\n-                    \" explicitly set as requested or not requested for learning_curve's\"\n-                    f\" estimator: {estimator.__class__.__name__}. Call\"\n-                    \" `.set_fit_request({{metadata}}=True)` on the estimator for\"\n-                    f\" each metadata in {unrequested_params} that you\"\n-                    \" want to use and `metadata=False` for not using it. See the\"\n-                    \" Metadata Routing User guide\"\n-                    \" <https://scikit-learn.org/stable/metadata_routing.html> for more\"\n-                    \" information.\"\n-                ),\n+                message=str(e).replace(\"learning_curve.fit\", \"learning_curve\"),\n                 unrequested_params=e.unrequested_params,\n                 routed_params=e.routed_params,\n             )\n@@ -2485,19 +2443,8 @@ def validation_curve(\n             # `process_routing` code, we pass `fit` as the caller. However,\n             # the user is not calling `fit` directly, so we change the message\n             # to make it more suitable for this case.\n-            unrequested_params = sorted(e.unrequested_params)\n             raise UnsetMetadataPassedError(\n-                message=(\n-                    f\"{unrequested_params} are passed to `validation_curve` but are not\"\n-                    \" explicitly set as requested or not requested for\"\n-                    f\" validation_curve's estimator: {estimator.__class__.__name__}.\"\n-                    \" Call `.set_fit_request({{metadata}}=True)` on the estimator for\"\n-                    f\" each metadata in {unrequested_params} that you\"\n-                    \" want to use and `metadata=False` for not using it. See the\"\n-                    \" Metadata Routing User guide\"\n-                    \" <https://scikit-learn.org/stable/metadata_routing.html> for more\"\n-                    \" information.\"\n-                ),\n+                message=str(e).replace(\"validation_curve.fit\", \"validation_curve\"),\n                 unrequested_params=e.unrequested_params,\n                 routed_params=e.routed_params,\n             )\ndiff --git a/sklearn/model_selection/tests/test_validation.py b/sklearn/model_selection/tests/test_validation.py\nindex 73156c2a25337..a34257679b50f 100644\n--- a/sklearn/model_selection/tests/test_validation.py\n+++ b/sklearn/model_selection/tests/test_validation.py\n@@ -25,7 +25,7 @@\n     make_regression,\n )\n from sklearn.ensemble import RandomForestClassifier\n-from sklearn.exceptions import FitFailedWarning\n+from sklearn.exceptions import FitFailedWarning, UnsetMetadataPassedError\n from sklearn.impute import SimpleImputer\n from sklearn.linear_model import (\n     LogisticRegression,\n@@ -2575,12 +2575,35 @@ def test_cross_validate_params_none(func, extra_args):\n def test_passed_unrequested_metadata(func, extra_args):\n     \"\"\"Check that we raise an error when passing metadata that is not\n     requested.\"\"\"\n-    err_msg = re.escape(\"but are not explicitly set as requested or not requested\")\n-    with pytest.raises(ValueError, match=err_msg):\n+\n+    err_msg = re.escape(\n+        \"[metadata] are passed but are not explicitly set as requested or not \"\n+        \"requested for ConsumingClassifier.fit, which is used within\"\n+    )\n+    with pytest.raises(UnsetMetadataPassedError, match=err_msg):\n         func(\n             estimator=ConsumingClassifier(),\n             X=X,\n-            y=y,\n+            y=y2,\n+            params=dict(metadata=[]),\n+            **extra_args,\n+        )\n+\n+    # cross_val_predict doesn't use scoring\n+    if func == cross_val_predict:\n+        return\n+\n+    err_msg = re.escape(\n+        \"[metadata] are passed but are not explicitly set as requested or not \"\n+        \"requested for ConsumingClassifier.score, which is used within\"\n+    )\n+    with pytest.raises(UnsetMetadataPassedError, match=err_msg):\n+        func(\n+            estimator=ConsumingClassifier()\n+            .set_fit_request(metadata=True)\n+            .set_partial_fit_request(metadata=True),\n+            X=X,\n+            y=y2,\n             params=dict(metadata=[]),\n             **extra_args,\n         )\n",
  "fail_to_pass": [],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/model_selection/_validation.py",
    "sklearn/model_selection/tests/test_validation.py"
  ],
  "difficulty": "medium",
  "created_at": "2025-03-18T15:20:41Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/31014",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/30818"
}