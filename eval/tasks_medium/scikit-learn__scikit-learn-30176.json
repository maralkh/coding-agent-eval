{
  "id": "scikit-learn__scikit-learn-30176",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "ba2dd5d6d8fd3fc68881a19a763a66c75b7564f8",
  "issue_number": 29614,
  "issue_title": "MNT Parallel build of sphinx_gallery",
  "issue_body": "#### Reference Issues/PRs\r\n#29570\r\n\r\n#### What does this implement/fix? Explain your changes.\r\nThis is an attempt to configure the `doc/conf.py` so that the sphinx_gallery build runs on two cores (see issue). The goal of this PR is to trigger the CI and see how it deals with it.\r\n\r\nLocally, running `make html` and `OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 make html `(I haven't yet been able to measure differences in speed, but they) seem equally stable, except for one tricky thing:\r\n\r\n`examples/feature_selection/plot_rfe_with_cross_validation.py` triggers the following errors (either one, I've ran it multiple times) within resp. right after the parallelized joblib part in `RFECV.fit()`.\r\n\r\n\r\n<details>\r\n    <summary>AttributeError</summary>\r\n\r\n    ../examples/feature_selection/plot_rfe_with_cross_validation.py unexpectedly failed to execute correctly:\r\n\r\n    Traceback (most recent call last):\r\n      File \"/home/stefanie/code/scikit-learn_dev/scikit-learn/examples/feature_selection/plot_rfe_with_cross_validation.py\", line 60, in <module>\r\n        rfecv.fit(X, y)\r\n      File \"/home/stefanie/code/scikit-learn_dev/scikit-learn/sklearn/base.py\", line 1514, in wrapper\r\n        return fit_method(estimator, *args, **kwargs)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n      File \"/home/stefanie/code/scikit-learn_dev/scikit-learn/sklearn/feature_selection/_rfe.py\", line 774, in fit\r\n        scores_features = parallel(\r\n                          ^^^^^^^^^\r\n      File \"/home/stefanie/code/scikit-learn_dev/scikit-learn/sklearn/utils/parallel.py\", line 77, in __call__\r\n        return super().__call__(iterable_with_config)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n      File \"/home/stefanie/.pyenv/versions/3.12.2/envs/scikit-learn_dev/lib/python3.12/site-packages/joblib/parallel.py\", line 2007, in __call__\r\n        return output if self.return_generator else list(output)\r\n                                                    ^^^^^^^^^^^^\r\n      File \"/home/stefanie/.pyenv/versions/3.12.2/envs/scikit-learn_dev/lib/python3.12/site-packages/joblib/parallel.py\", line 1650, in _get_outputs\r\n        yield from self._retrieve()\r\n      File \"/home/stefanie/.pyenv/versions/3.12.2/envs/scikit-learn_dev/lib/python3.12/site-packages/joblib/parallel.py\", line 1754, in _retrieve\r\n        self._raise_error_fast()\r\n      File \"/home/stefanie/.pyenv/versions/3.12.2/envs/scikit-learn_dev/lib/python3.12/site-packages/joblib/parallel.py\", line 1789, in _raise_error_fast\r\n        error_job.get_result(self.timeout)\r\n      File \"/home/stefanie/.pyenv/versions/3.12.2/envs/scikit-learn_dev/lib/python3.12/site-packages/joblib/parallel.py\", line 745, in get_result\r\n        return self._return_or_raise()\r\n               ^^^^^^^^^^^^^^^^^^^^^^^\r\n      File \"/home/stefanie/.pyenv/versions/3.12.2/envs/scikit-learn_dev/lib/python3.12/site-packages/joblib/parallel.py\", line 763, in _return_or_raise\r\n        raise self._result\r\n    AttributeError: 'LogisticRegression' object has no attribute 'coef_'\r\n</details>\r\n\r\n\r\n<details>\r\n    <summary>ValueError</summary>\r\n\r\n    ../examples/feature_selection/plot_rfe_with_cross_validation.py unexpectedly failed to execute correctly:\r\n\r\n    Traceback (most recent call last):\r\n      File \"/home/stefanie/code/scikit-learn_dev/scikit-learn/examples/feature_selection/plot_rfe_with_cross_validation.py\", line 60, in <module>\r\n        rfecv.fit(X, y)\r\n      File \"/home/stefanie/code/scikit-learn_dev/scikit-learn/sklearn/base.py\", line 1514, in wrapper\r\n        return fit_method(estimator, *args, **kwargs)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n      File \"/home/stefanie/code/scikit-learn_dev/scikit-learn/sklearn/feature_selection/_rfe.py\", line 781, in fit\r\n        scores = np.array(scores)\r\n                 ^^^^^^^^^^^^^^^^\r\n    ValueError: setting an array element with a sequence. The requested array has an inhomogeneous shape after 1 dimensions. The detected shape was (5,) + inhomogeneous part.\r\n</details>\r\n\r\nCan this be due to a race condition? If it appears on the CI also, we need to deal with it somehow.",
  "pr_number": 30176,
  "pr_title": "FIX Make RFECV thread-safe when used with joblib threading backend",
  "gold_patch": "diff --git a/sklearn/feature_selection/_rfe.py b/sklearn/feature_selection/_rfe.py\nindex 0282facf9fd31..3015a4ae55e94 100644\n--- a/sklearn/feature_selection/_rfe.py\n+++ b/sklearn/feature_selection/_rfe.py\n@@ -882,7 +882,7 @@ def fit(self, X, y, *, groups=None, **params):\n             func = delayed(_rfe_single_fit)\n \n         scores_features = parallel(\n-            func(rfe, self.estimator, X, y, train, test, scorer, routed_params)\n+            func(clone(rfe), self.estimator, X, y, train, test, scorer, routed_params)\n             for train, test in cv.split(X, y, **routed_params.splitter.split)\n         )\n         scores, step_n_features = zip(*scores_features)\ndiff --git a/sklearn/feature_selection/tests/test_rfe.py b/sklearn/feature_selection/tests/test_rfe.py\nindex 98b55366c5853..74c716054cb70 100644\n--- a/sklearn/feature_selection/tests/test_rfe.py\n+++ b/sklearn/feature_selection/tests/test_rfe.py\n@@ -6,6 +6,7 @@\n \n import numpy as np\n import pytest\n+from joblib import parallel_backend\n from numpy.testing import assert_allclose, assert_array_almost_equal, assert_array_equal\n \n from sklearn.base import BaseEstimator, ClassifierMixin\n@@ -703,3 +704,21 @@ def test_rfe_with_sample_weight():\n     rfe_sw_2.fit(X, y, sample_weight=sample_weight_2)\n \n     assert not np.array_equal(rfe_sw_2.ranking_, rfe.ranking_)\n+\n+\n+def test_rfe_with_joblib_threading_backend(global_random_seed):\n+    X, y = make_classification(random_state=global_random_seed)\n+\n+    clf = LogisticRegression()\n+    rfe = RFECV(\n+        estimator=clf,\n+        n_jobs=2,\n+    )\n+\n+    rfe.fit(X, y)\n+    ranking_ref = rfe.ranking_\n+\n+    with parallel_backend(\"threading\"):\n+        rfe.fit(X, y)\n+\n+    assert_array_equal(ranking_ref, rfe.ranking_)\n",
  "fail_to_pass": [
    "test_rfe_with_joblib_threading_backend"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/feature_selection/_rfe.py",
    "sklearn/feature_selection/tests/test_rfe.py"
  ],
  "difficulty": "medium",
  "created_at": "2024-10-30T13:54:24Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/30176",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/pull/29614"
}