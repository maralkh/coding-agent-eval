{
  "id": "scikit-learn__scikit-learn-30451",
  "repo": "scikit-learn/scikit-learn",
  "base_commit": "8481e681128822050e996c3ef6b65d3801d102f5",
  "issue_number": 30447,
  "issue_title": "`cross_validate` raises an exception when metadata routing is enabled",
  "issue_body": "### Describe the bug\n\nIn the latest release (v1.6.0), `cross_validate` raises an exception when using it with metadata routing enabled. This is because `params` dict gets unpacked even if `None`, which is the default value. See this line:\r\n\r\nhttps://github.com/scikit-learn/scikit-learn/blob/76ae0a539a0e87145c9f6fedcd7033494082fa17/sklearn/model_selection/_validation.py#L375\n\n### Steps/Code to Reproduce\n\n```python\r\nimport numpy as np\r\nimport sklearn\r\nfrom sklearn.model_selection import cross_validate\r\nfrom sklearn.model_selection.tests.test_validation import MockClassifier\r\n\r\nsklearn.set_config(enable_metadata_routing=True)\r\n\r\nX = np.ones((10, 2))\r\ny = np.array([0, 0, 1, 1, 2, 2, 3, 3, 4, 4])\r\n\r\nclf = MockClassifier()\r\ncross_validate(clf, X, y)\r\n```\n\n### Expected Results\n\nNo exception being raised.\n\n### Actual Results\n\n```python-traceback\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"<redacted>/lib/python3.10/site-packages/sklearn/utils/_param_validation.py\", line 216, in wrapper\r\n    return func(*args, **kwargs)\r\n  File \"<redacted>/lib/python3.10/site-packages/sklearn/model_selection/_validation.py\", line 375, in cross_validate\r\n    routed_params = process_routing(router, \"fit\", **params)\r\nTypeError: sklearn.utils._metadata_requests.process_routing() argument after ** must be a mapping, not NoneType\r\n```\n\n### Versions\n\n```shell\nSystem:\r\n    python: 3.10.12 (main, Nov  6 2024, 20:22:13) [GCC 11.4.0]\r\nexecutable: <redacted>/bin/python\r\n   machine: Linux-6.5.13netflix-g77293087f291-x86_64-with-glibc2.35\r\n\r\nPython dependencies:\r\n      sklearn: 1.6.0\r\n          pip: None\r\n   setuptools: 75.6.0\r\n        numpy: 1.26.4\r\n        scipy: 1.14.1\r\n       Cython: None\r\n       pandas: 2.2.3\r\n   matplotlib: 3.9.3\r\n       joblib: 1.4.2\r\nthreadpoolctl: 3.5.0\r\n\r\nBuilt with OpenMP: True\r\n\r\nthreadpoolctl info:\r\n       user_api: blas\r\n   internal_api: openblas\r\n    num_threads: 4\r\n         prefix: libopenblas\r\n       filepath: /root/pycharm_projects/evaluations/.venv/lib/python3.10/site-packages/numpy.libs/libopenblas64_p-r0-0cf96a72.3.23.dev.so\r\n        version: 0.3.23.dev\r\nthreading_layer: pthreads\r\n   architecture: Cooperlake\r\n\r\n       user_api: blas\r\n   internal_api: openblas\r\n    num_threads: 4\r\n         prefix: libscipy_openblas\r\n       filepath: /root/pycharm_projects/evaluations/.venv/lib/python3.10/site-packages/scipy.libs/libscipy_openblas-c128ec02.so\r\n        version: 0.3.27.dev\r\nthreading_layer: pthreads\r\n   architecture: Cooperlake\r\n\r\n       user_api: openmp\r\n   internal_api: openmp\r\n    num_threads: 4\r\n         prefix: libgomp\r\n       filepath: <redacted>/lib/python3.10/site-packages/scikit_learn.libs/libgomp-a34b3233.so.1.0.0\r\n        version: None\r\n```\n```\n",
  "pr_number": 30451,
  "pr_title": "FIX methods in model_selection/_validation accept params=None with metadata routing enabled",
  "gold_patch": "diff --git a/doc/whats_new/upcoming_changes/sklearn.model_selection/30451.fix.rst b/doc/whats_new/upcoming_changes/sklearn.model_selection/30451.fix.rst\nnew file mode 100644\nindex 0000000000000..5ebfb5992d832\n--- /dev/null\n+++ b/doc/whats_new/upcoming_changes/sklearn.model_selection/30451.fix.rst\n@@ -0,0 +1,3 @@\n+- :func:`~model_selection.cross_validate`, :func:`~model_selection.cross_val_predict`,\n+  and :func:`~model_selection.cross_val_score` now accept `params=None` when metadata\n+  routing is enabled. By `Adrin Jalali`_\ndiff --git a/sklearn/model_selection/_validation.py b/sklearn/model_selection/_validation.py\nindex 7d38182911fb8..d5984d2454a4c 100644\n--- a/sklearn/model_selection/_validation.py\n+++ b/sklearn/model_selection/_validation.py\n@@ -343,7 +343,7 @@ def cross_validate(\n     _check_groups_routing_disabled(groups)\n \n     X, y = indexable(X, y)\n-\n+    params = {} if params is None else params\n     cv = check_cv(cv, y, classifier=is_classifier(estimator))\n \n     scorers = check_scoring(\n@@ -1172,6 +1172,7 @@ def cross_val_predict(\n     \"\"\"\n     _check_groups_routing_disabled(groups)\n     X, y = indexable(X, y)\n+    params = {} if params is None else params\n \n     if _routing_enabled():\n         # For estimators, a MetadataRouter is created in get_metadata_routing\ndiff --git a/sklearn/model_selection/tests/test_validation.py b/sklearn/model_selection/tests/test_validation.py\nindex 2d579772b1fbe..73156c2a25337 100644\n--- a/sklearn/model_selection/tests/test_validation.py\n+++ b/sklearn/model_selection/tests/test_validation.py\n@@ -2539,6 +2539,27 @@ def test_groups_with_routing_validation(func, extra_args):\n         )\n \n \n+@pytest.mark.parametrize(\n+    \"func, extra_args\",\n+    [\n+        (cross_validate, {}),\n+        (cross_val_score, {}),\n+        (cross_val_predict, {}),\n+        (learning_curve, {}),\n+        (permutation_test_score, {}),\n+        (validation_curve, {\"param_name\": \"alpha\", \"param_range\": np.array([1])}),\n+    ],\n+)\n+@config_context(enable_metadata_routing=True)\n+def test_cross_validate_params_none(func, extra_args):\n+    \"\"\"Test that no errors are raised when passing `params=None`, which is the\n+    default value.\n+    Non-regression test for: https://github.com/scikit-learn/scikit-learn/issues/30447\n+    \"\"\"\n+    X, y = make_classification(n_samples=100, n_classes=2, random_state=0)\n+    func(estimator=ConsumingClassifier(), X=X, y=y, **extra_args)\n+\n+\n @pytest.mark.parametrize(\n     \"func, extra_args\",\n     [\n",
  "fail_to_pass": [
    "test_cross_validate_params_none"
  ],
  "pass_to_pass": [],
  "relevant_files": [
    "sklearn/model_selection/_validation.py",
    "sklearn/model_selection/tests/test_validation.py"
  ],
  "difficulty": "medium",
  "created_at": "2024-12-10T09:38:54Z",
  "pr_url": "https://github.com/scikit-learn/scikit-learn/pull/30451",
  "issue_url": "https://github.com/scikit-learn/scikit-learn/issues/30447"
}